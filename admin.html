<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>장항지구 맛집지도 관리자</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",sans-serif;margin:16px;}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    input,textarea{padding:10px;border:1px solid #ddd;border-radius:10px;font-size:14px;}
    button{padding:10px 12px;border:0;border-radius:10px;background:#03c75a;color:#fff;font-weight:700;}
    button.secondary{background:#f3f4f6;color:#111;}
    .card{border:1px solid #eee;border-radius:14px;padding:12px;margin:10px 0;}
    .small{color:#666;font-size:13px;margin-top:6px;}
    .tab{padding:10px 12px;border-radius:999px;border:1px solid #ddd;background:#fff;}
    .tab.active{border-color:#03c75a;background:#03c75a1a;font-weight:800;}
  </style>
</head>
<body>
  <h2>관리자</h2>

  <div class="row" style="margin-bottom:10px;">
    <input id="key" placeholder="관리자 키" style="flex:1;min-width:220px;" />
    <button onclick="saveKey()">저장</button>
  </div>

  <div class="row" style="margin-bottom:14px;">
    <div class="tab active" id="t1" onclick="setTab('restaurants')">맛집 승인</div>
    <div class="tab" id="t2" onclick="setTab('comments')">댓글 숨김</div>
  </div>

  <div id="restaurantsView">
    <button onclick="loadPending()">대기 목록 불러오기</button>
    <div id="pendingList"></div>
  </div>

  <div id="commentsView" style="display:none;">
    <div class="row">
      <input id="rid" placeholder="restaurantId 입력" />
      <button onclick="loadComments()">댓글 불러오기</button>
    </div>
    <div id="commentList"></div>
  </div>

<script>
  // ✅ GitHub에서 쓰는 workers.dev 그대로
  const API_URL = "https://twilight-art-ed3c.wlalsqqq.workers.dev";

  const keyInput = document.getElementById("key");
  keyInput.value = localStorage.getItem("ADMIN_KEY") || "";

  function saveKey(){
    localStorage.setItem("ADMIN_KEY", keyInput.value.trim());
    alert("저장됨");
  }

  function getKey(){
    return (localStorage.getItem("ADMIN_KEY") || "").trim();
  }

  function setTab(tab){
    document.getElementById("t1").classList.toggle("active", tab==="restaurants");
    document.getElementById("t2").classList.toggle("active", tab==="comments");
    document.getElementById("restaurantsView").style.display = tab==="restaurants" ? "block" : "none";
    document.getElementById("commentsView").style.display = tab==="comments" ? "block" : "none";
  }

  async function loadPending(){
    const key = getKey();
    if(!key) return alert("관리자 키를 먼저 저장해줘");

    const res = await fetch(API_URL + "?action=pending&key=" + encodeURIComponent(key));
    const json = await res.json();

    const el = document.getElementById("pendingList");
    el.innerHTML = "";

    (json.data || []).forEach(r=>{
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div><b>${escapeHtml(r.name)}</b> <span class="small">(${escapeHtml(r.status)})</span></div>
        <div class="small">${escapeHtml(r.address || "")}</div>
        <div class="small">카테고리: ${escapeHtml(r.category || "")}</div>
        <div class="small">placeUrl: ${escapeHtml(r.placeUrl || "")}</div>
        <div class="row" style="margin-top:10px;">
          <button onclick="approve('${encodeURIComponent(r.id)}')">승인</button>
          <button class="secondary" onclick="copyId('${escapeHtml(r.id)}')">ID 복사</button>
        </div>
      `;
      el.appendChild(card);
    });

    if(!(json.data || []).length){
      el.innerHTML = `<div class="small">대기 목록이 없습니다.</div>`;
    }
  }

  async function approve(idEnc){
    const key = getKey();
    const id = decodeURIComponent(idEnc);

    if(!confirm("승인할까?")) return;

    const res = await fetch(API_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ action:"approveRestaurant", key, data:{ id } })
    });
    const json = await res.json();
    if(!json.ok) return alert("실패: " + (json.error || "unknown"));
    alert("승인 완료");
    loadPending();
  }

  function copyId(id){
    navigator.clipboard.writeText(id);
    alert("복사됨: " + id);
  }

  async function loadComments(){
    const rid = document.getElementById("rid").value.trim();
    if(!rid) return alert("restaurantId를 입력해줘");

    const res = await fetch(API_URL + "?action=comments&restaurantId=" + encodeURIComponent(rid));
    const json = await res.json();

    const el = document.getElementById("commentList");
    el.innerHTML = "";

    (json.data || []).forEach(c=>{
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div><b>${escapeHtml(c.nickname)}</b> <span class="small">${escapeHtml((c.createdAt||"").slice(0,10))}</span></div>
        <div style="margin-top:6px;">${escapeHtml(c.content)}</div>
        <div class="row" style="margin-top:10px;">
          <button class="secondary" onclick="hideComment('${escapeHtml(c.commentId)}', true)">숨김</button>
          <button class="secondary" onclick="hideComment('${escapeHtml(c.commentId)}', false)">복구</button>
        </div>
        <div class="small">commentId: ${escapeHtml(c.commentId)}</div>
      `;
      el.appendChild(card);
    });

    if(!(json.data||[]).length){
      el.innerHTML = `<div class="small">댓글이 없습니다.</div>`;
    }
  }

  async function hideComment(commentId, hidden){
    const key = getKey();
    if(!key) return alert("관리자 키를 먼저 저장해줘");

    const res = await fetch(API_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ action:"setCommentHidden", key, data:{ commentId, hidden: hidden ? "true" : "false" } })
    });
    const json = await res.json();
    if(!json.ok) return alert("실패: " + (json.error || "unknown"));
    alert(hidden ? "숨김 처리됨" : "복구 처리됨");
  }

  function escapeHtml(str){
    return String(str||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
</script>
</body>
</html>
