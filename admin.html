<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>장항지구 맛집 관리자</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",sans-serif;margin:0;background:#f6f7f9;}
    .wrap{max-width:900px;margin:0 auto;padding:16px;}
    .top{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    h1{font-size:18px;margin:0;}
    input,button,select{font-size:14px;border-radius:12px;border:1px solid #ddd;padding:10px 12px;}
    button{border:0;background:#111;color:#fff;font-weight:800;cursor:pointer;}
    button.gray{background:#6b7280;}
    button.green{background:#03c75a;}
    button.red{background:#ef4444;}
    .card{background:#fff;border:1px solid #eee;border-radius:16px;padding:14px;margin-top:12px;box-shadow:0 6px 20px rgba(0,0,0,.05);}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    .row > *{flex:1;min-width:160px;}
    .meta{color:#555;font-size:13px;line-height:1.35;margin-top:6px;}
    .pill{display:inline-block;margin:4px 6px 0 0;background:#f3f4f6;padding:4px 8px;border-radius:999px;font-size:12px;}
    .status{font-size:12px;font-weight:900;display:inline-block;padding:4px 8px;border-radius:999px;}
    .pending{background:#fff7ed;color:#9a3412;border:1px solid #fed7aa;}
    .approved{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0;}
    .rejected{background:#fef2f2;color:#991b1b;border:1px solid #fecaca;}
    .small{font-size:12px;color:#777;margin-top:8px;line-height:1.35;}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:12px;font-size:13px;display:none;z-index:9999;}
    .toast.show{display:block;}
    a{color:#2563eb;text-decoration:none;}
    .divider{height:1px;background:#eee;margin:10px 0;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h1>장항지구 맛집 관리자</h1>
    <input id="adminKey" placeholder="관리자 비밀번호" />
    <select id="filter">
      <option value="pending">대기(pending)</option>
      <option value="all">전체</option>
      <option value="approved">승인(approved)</option>
      <option value="rejected">반려(rejected)</option>
    </select>
    <button onclick="load()">대기목록 불러오기</button>
    <button class="gray" onclick="location.href='./'">지도로</button>
  </div>

  <div class="small">
    ✅ 승인할 때 <b>lat/lng</b>를 입력해야 지도(restaurants)에 등록돼요.<br/>
    ✅ 좌표는 네이버지도에서 위치 길게 눌러 좌표 확인하거나, 지도 페이지에서 보정해서 넣으면 돼요.
  </div>

  <div id="list"></div>
</div>

<div id="toast" class="toast"></div>

<script>
  // ✅ 네 Cloudflare Worker 주소로!
const API_URL = "https://twilight-art-ed3c.wlalsqqq.workers.dev";

  function toast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2500);
  }

  function esc(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function statusClass(s){
    s = String(s||"").toLowerCase();
    if(s==="approved") return "approved";
    if(s==="rejected") return "rejected";
    return "pending";
  }

  async function load(){
    const adminKey = document.getElementById("adminKey").value.trim();
    if(!adminKey) return toast("관리자 비밀번호를 입력해줘");

    const filter = document.getElementById("filter").value;

    try{
      const res = await fetch(`${API_URL}?action=submissions&adminKey=${encodeURIComponent(adminKey)}`);
      const json = await res.json();

      if(!json.ok){
        return toast("불러오기 실패: " + (json.error || "unknown"));
      }

      let data = json.data || [];

      if(filter !== "all"){
        data = data.filter(x => String(x.status||"").toLowerCase() === filter);
      }

      render(data);

      toast(`불러오기 완료 (${data.length}건)`);

    }catch(e){
      console.error(e);
      toast("네트워크 오류(콘솔 확인)");
    }
  }

  function render(items){
    const root = document.getElementById("list");
    if(!items.length){
      root.innerHTML = `<div class="card">대기/목록이 없습니다.</div>`;
      return;
    }

    root.innerHTML = items.map(item=>{
      const pills = []
      if(item.category) pills.push(...String(item.category).split(",").map(s=>s.trim()).filter(Boolean).map(s=>`<span class="pill">${esc(s)}</span>`));
      if(item.tags) pills.push(...String(item.tags).split(",").map(s=>s.trim()).filter(Boolean).map(s=>`<span class="pill">#${esc(s)}</span>`));

      const place = item.placeUrl ? `<div class="meta">플레이스: <a href="${esc(item.placeUrl)}" target="_blank">${esc(item.placeUrl)}</a></div>` : "";

      return `
        <div class="card">
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;">
            <div>
              <div style="font-weight:900;font-size:16px;">${esc(item.name)}</div>
              <div class="meta">${esc(item.address || "")}</div>
              <div class="meta">
                <span class="status ${statusClass(item.status)}">${esc(item.status)}</span>
                <span style="margin-left:8px;color:#777;">${esc(item.createdAt || "")}</span>
              </div>
              ${place}
              ${item.desc ? `<div class="meta">소개: ${esc(item.desc)}</div>` : ""}
              ${item.nickname ? `<div class="meta">제보자: ${esc(item.nickname)}</div>` : ""}
              <div>${pills.join("")}</div>
            </div>
            <div style="min-width:260px;flex:0 0 260px;">
              <div class="row" style="margin-top:0;">
                <input id="lat_${esc(item.submissionId)}" placeholder="lat (예 37.6612)" />
                <input id="lng_${esc(item.submissionId)}" placeholder="lng (예 126.7641)" />
              </div>

              <div class="row">
                <button class="green" onclick="approve('${esc(item.submissionId)}')">승인(좌표필수)</button>
                <button class="red" onclick="reject('${esc(item.submissionId)}')">반려</button>
              </div>

              <div class="divider"></div>
              <div class="small">
                submissionId: <b>${esc(item.submissionId)}</b><br/>
                adminLat/adminLng(기록): ${esc(item.adminLat||"")} / ${esc(item.adminLng||"")}<br/>
                반려사유: ${esc(item.rejectReason||"")}
              </div>
            </div>
          </div>
        </div>
      `;
    }).join("");
  }

  async function approve(submissionId){
    const adminKey = document.getElementById("adminKey").value.trim();
    const lat = Number(document.getElementById(`lat_${submissionId}`).value.trim());
    const lng = Number(document.getElementById(`lng_${submissionId}`).value.trim());

    if(!adminKey) return toast("관리자 비밀번호 입력");
    if(!Number.isFinite(lat) || !Number.isFinite(lng)) return toast("lat/lng를 숫자로 입력해줘");

    try{
      const res = await fetch(API_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          action:"approve",
          data:{ adminKey, submissionId, lat, lng }
        })
      });
      const json = await res.json();
      if(!json.ok) return toast("승인 실패: " + (json.error||"unknown"));

      toast("승인 완료! 지도에 반영됨");
      load();
    }catch(e){
      console.error(e);
      toast("네트워크 오류(콘솔 확인)");
    }
  }

  async function reject(submissionId){
    const adminKey = document.getElementById("adminKey").value.trim();
    if(!adminKey) return toast("관리자 비밀번호 입력");

    const reason = prompt("반려 사유(선택):") || "";

    try{
      const res = await fetch(API_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          action:"reject",
          data:{ adminKey, submissionId, reason }
        })
      });
      const json = await res.json();
      if(!json.ok) return toast("반려 실패: " + (json.error||"unknown"));

      toast("반려 처리 완료");
      load();
    }catch(e){
      console.error(e);
      toast("네트워크 오류(콘솔 확인)");
    }
  }
</script>
</body>
</html>
