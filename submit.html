<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì¥í•­ì§€êµ¬ ë§›ì§‘ ì œë³´</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",sans-serif;margin:0;background:#f6f7f9;}
    .wrap{max-width:520px;margin:0 auto;padding:18px;}
    .card{background:#fff;border:1px solid #eee;border-radius:16px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.06);}
    h1{font-size:18px;margin:0 0 6px;}
    .sub{font-size:13px;color:#666;margin:0 0 14px;line-height:1.4;}
    label{display:block;font-size:13px;color:#333;margin:12px 0 6px;font-weight:800;}
    input, textarea{width:100%;box-sizing:border-box;padding:12px;border:1px solid #ddd;border-radius:12px;font-size:14px;background:#fff;}
    textarea{min-height:84px;resize:vertical;}
    .chips{display:flex;flex-wrap:wrap;gap:8px;}
    .chip{padding:9px 10px;border-radius:999px;border:1px solid #ddd;background:#fff;font-size:13px;user-select:none;cursor:pointer;}
    .chip.active{border-color:#03c75a;background:#03c75a1a;font-weight:900;}
    .row{display:flex;gap:10px;}
    .row > *{flex:1;}
    .btn{margin-top:14px;width:100%;padding:14px;border:0;border-radius:14px;background:#03c75a;color:#fff;font-weight:900;font-size:15px;cursor:pointer;}
    .btn.secondary{background:#f3f4f6;color:#111;}
    .toast{margin-top:12px;padding:12px;border-radius:12px;background:#111;color:#fff;font-size:13px;display:none;}
    .toast.show{display:block;}
    .small{margin-top:10px;color:#777;font-size:12px;line-height:1.35;}
    .locline{margin-top:10px;font-size:12px;color:#333;display:flex;justify-content:space-between;align-items:center;gap:10px;}
    .locbadge{padding:6px 10px;border-radius:999px;background:#f3f4f6;border:1px solid #e5e7eb;font-weight:800;white-space:nowrap;}
    .locbtn{padding:8px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.10);background:#fff;font-weight:900;cursor:pointer;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ì¥í•­ì§€êµ¬ ë§›ì§‘ ì œë³´</h1>
      <p class="sub">
        ì œë³´ëœ ë§›ì§‘ì€ ê´€ë¦¬ì í™•ì¸ í›„ ìŠ¹ì¸ë˜ë©´ ì§€ë„ì— í‘œì‹œë¼ìš” ğŸ™‚<br/>
        ê°€ëŠ¥í•˜ë©´ <b>ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ë§í¬</b>ê¹Œì§€ ë„£ì–´ì£¼ë©´ ì •í™•ë„ê°€ í™• ì˜¬ë¼ê°€ìš”.
      </p>

      <div class="locline">
        <div id="locText">ğŸ“ ìœ„ì¹˜: í™•ì¸ ì¤‘â€¦</div>
        <div style="display:flex; gap:8px;">
          <span class="locbadge" id="locBadge">GPS OFF</span>
          <button class="locbtn" type="button" onclick="refreshLocation()">í˜„ì¬ìœ„ì¹˜ ê°±ì‹ </button>
        </div>
      </div>

      <label>ê°€ê²Œëª… *</label>
      <input id="name" placeholder="ì˜ˆ) ì¥í•­ì§¬ë½•" maxlength="40" />

      <label>ì£¼ì†Œ *</label>
      <input id="address" placeholder="ì˜ˆ) ê³ ì–‘ì‹œ ì¼ì‚°ë™êµ¬ ì¥í•­ë™ ..." maxlength="80" />

      <label>ì¹´í…Œê³ ë¦¬ (ë³µìˆ˜ ì„ íƒ) *</label>
      <div id="cats" class="chips"></div>

      <label>í•œì¤„ ì†Œê°œ (ì„ íƒ)</label>
      <textarea id="desc" placeholder="ì˜ˆ) ì–‘ ë§ê³  ê°€ì„±ë¹„ ì¢‹ì•„ìš”" maxlength="120"></textarea>

      <label>ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ë§í¬ (ì„ íƒ)</label>
      <input id="placeUrl" placeholder="ì˜ˆ) https://place.map.naver.com/..." maxlength="200" />

      <div class="row">
        <div>
          <label>ë‹‰ë„¤ì„ (ì„ íƒ)</label>
          <input id="nickname" placeholder="ì˜ˆ) ì¥í•­ë§˜" maxlength="20" />
        </div>
        <div>
          <label>ì¶”ì²œ íƒœê·¸(ì„ íƒ)</label>
          <input id="tags" placeholder="ì˜ˆ) ì•„ì´ë™ë°˜,ì£¼ì°¨" maxlength="60" />
        </div>
      </div>

      <button class="btn" type="button" onclick="submitRestaurant()">ì œë³´í•˜ê¸°</button>
      <button class="btn secondary" type="button" onclick="goBack()">ì§€ë„ë¡œ ëŒì•„ê°€ê¸°</button>

      <div id="toast" class="toast"></div>
      <div class="small">
        * ì¹´í…Œê³ ë¦¬ëŠ” ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥í•´ìš”.<br/>
        * GPSê°€ ì¼œì ¸ ìˆìœ¼ë©´ ì œë³´ ì‹œì ì— ì¢Œí‘œ(lat/lng)ë¥¼ ê°™ì´ ì €ì¥í•´ìš”. (GPSê°€ êº¼ì ¸ë„ ì£¼ì†Œ ì§€ì˜¤ì½”ë”©ìœ¼ë¡œ ë³´ì™„ ê°€ëŠ¥)
      </div>
    </div>
  </div>

<script>
  // âœ… Worker ì£¼ì†Œ
  const API_URL = "https://twilight-art-ed3c.wlalsqqq.workers.dev";

  // âœ… ì¹´í…Œê³ ë¦¬
  const CATEGORY_MASTER = ["í•œì‹","ì¤‘ì‹","ì¼ì‹","ì–‘ì‹","ì¹´í˜","ë¶„ì‹","ê³ ê¸°","ë°°ë‹¬","ì¹˜í‚¨","í”¼ì","ë””ì €íŠ¸"];
  const selectedCats = new Set();

  // âœ… GPS ìœ„ì¹˜(ì œë³´ì— ê°™ì´ ë³´ëƒ„)
  let gps = { lat: null, lng: null, ok: false };

  const catsEl = document.getElementById("cats");
  CATEGORY_MASTER.forEach(c=>{
    const el = document.createElement("div");
    el.className = "chip";
    el.textContent = c;
    el.onclick = () => {
      if (selectedCats.has(c)) selectedCats.delete(c);
      else selectedCats.add(c);
      el.classList.toggle("active", selectedCats.has(c));
    };
    catsEl.appendChild(el);
  });

  function toast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2600);
  }

  function setLocUI(ok, lat, lng, msg){
    const badge = document.getElementById("locBadge");
    const text = document.getElementById("locText");
    if(ok){
      badge.textContent = "GPS ON";
      badge.style.background = "#03c75a1a";
      badge.style.borderColor = "rgba(3,199,90,.35)";
      text.textContent = `ğŸ“ ìœ„ì¹˜: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    }else{
      badge.textContent = "GPS OFF";
      badge.style.background = "#f3f4f6";
      badge.style.borderColor = "#e5e7eb";
      text.textContent = `ğŸ“ ìœ„ì¹˜: ${msg || "ì‚¬ìš© ì•ˆ í•¨(ì£¼ì†Œë¡œ ë³´ì™„)"}`;
    }
  }

  function refreshLocation(){
    if(!navigator.geolocation){
      gps = { lat:null, lng:null, ok:false };
      setLocUI(false, 0, 0, "ì´ ê¸°ê¸°ì—ì„œ ìœ„ì¹˜ ì‚¬ìš© ë¶ˆê°€");
      return;
    }

    setLocUI(false, 0, 0, "í™•ì¸ ì¤‘â€¦(ê¶Œí•œ í—ˆìš© í•„ìš”)");

    navigator.geolocation.getCurrentPosition(
      (pos)=>{
        gps = { lat: pos.coords.latitude, lng: pos.coords.longitude, ok: true };
        setLocUI(true, gps.lat, gps.lng);
      },
      (err)=>{
        gps = { lat:null, lng:null, ok:false };
        let msg = "ìœ„ì¹˜ ê¶Œí•œ/í™˜ê²½ ë¬¸ì œ";
        if(err.code === 1) msg = "ê¶Œí•œ ê±°ë¶€ë¨";
        if(err.code === 2) msg = "ìœ„ì¹˜ ì‚¬ìš© ë¶ˆê°€";
        if(err.code === 3) msg = "ì‹œê°„ ì´ˆê³¼(ì‹¤ì™¸/ì •í™•í•œ ìœ„ì¹˜ ON ì¶”ì²œ)";
        setLocUI(false, 0, 0, msg);
      },
      { enableHighAccuracy: true, timeout: 12000, maximumAge: 5000 }
    );
  }

  // í˜ì´ì§€ ì§„ì… ì‹œ 1ë²ˆ ì‹œë„
  refreshLocation();

  async function submitRestaurant(){
    const name = document.getElementById("name").value.trim();
    const address = document.getElementById("address").value.trim();
    const category = [...selectedCats].join(",");

    const desc = document.getElementById("desc").value.trim();
    const placeUrl = document.getElementById("placeUrl").value.trim();
    const nickname = document.getElementById("nickname").value.trim();
    const tags = document.getElementById("tags").value.trim();

    if(!name || !address){
      return toast("ê°€ê²Œëª…/ì£¼ì†ŒëŠ” ê¼­ ì…ë ¥í•´ì¤˜!");
    }
    if(selectedCats.size === 0){
      return toast("ì¹´í…Œê³ ë¦¬ë¥¼ ìµœì†Œ 1ê°œ ì„ íƒí•´ì¤˜!");
    }

    // âœ… í•µì‹¬: GASê°€ ë°›ëŠ” actionì€ "submit"
    // âœ… í•µì‹¬: gpsê°€ ìˆìœ¼ë©´ lat/lngë„ ê°™ì´ ì „ì†¡
    const payload = {
      action: "submit",
      data: {
        name,
        address,
        category,
        tags,
        placeUrl,
        desc,
        nickname,
        lat: gps.ok ? gps.lat : null,
        lng: gps.ok ? gps.lng : null
      }
    };

    try{
      const res = await fetch(API_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });

      const json = await res.json();
      if(!json.ok){
        return toast("ì œë³´ ì‹¤íŒ¨: " + (json.error || "unknown"));
      }

      toast("ì œë³´ ì™„ë£Œ! ìŠ¹ì¸ë˜ë©´ ì§€ë„ì— í‘œì‹œë¼ìš” ğŸ™‚");

      // ì…ë ¥ ì´ˆê¸°í™”
      document.getElementById("name").value = "";
      document.getElementById("address").value = "";
      document.getElementById("desc").value = "";
      document.getElementById("placeUrl").value = "";
      document.getElementById("nickname").value = "";
      document.getElementById("tags").value = "";
      selectedCats.clear();
      document.querySelectorAll(".chip").forEach(ch => ch.classList.remove("active"));
    }catch(e){
      console.error(e);
      toast("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜(ì½˜ì†” í™•ì¸)");
    }
  }

  function goBack(){
    location.href = "./";
  }
</script>
</body>
</html>
