<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì¥í•­ì§€êµ¬ ë§›ì§‘ ì œë³´</title>
<link rel="icon" href="data:,">
<style>
body{font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",sans-serif;margin:0;background:#f6f7f9;}
.wrap{max-width:520px;margin:0 auto;padding:18px;}
.card{background:#fff;border:1px solid #eee;border-radius:16px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.06);}
h1{font-size:18px;margin:0 0 6px;}
.sub{font-size:13px;color:#666;margin:0 0 14px;line-height:1.4;}
label{display:block;font-size:13px;color:#333;margin:12px 0 6px;font-weight:900;}
input, textarea{width:100%;box-sizing:border-box;padding:12px;border:1px solid #ddd;border-radius:12px;font-size:14px;background:#fff;}
textarea{min-height:84px;resize:vertical;}
.chips{display:flex;flex-wrap:wrap;gap:8px;}
.chip{padding:9px 10px;border-radius:999px;border:1px solid #ddd;background:#fff;font-size:13px;user-select:none;font-weight:900;cursor:pointer;}
.chip.active{border-color:#03c75a;background:#03c75a1a;}
.row{display:flex;gap:10px;}
.row > *{flex:1;}
.btn{margin-top:14px;width:100%;padding:14px;border:0;border-radius:14px;background:#03c75a;color:#fff;font-weight:900;font-size:15px;cursor:pointer;}
.btn.secondary{background:#111;}
.small{margin-top:10px;color:#777;font-size:12px;line-height:1.35;}

/* ===== âœ… ëª¨ë‹¬ íŒì—… ===== */
.modalBack{
  position:fixed; inset:0; z-index:99999;
  background:rgba(0,0,0,.45);
  display:none; align-items:center; justify-content:center;
  padding:18px;
}
.modalBack.show{ display:flex; }
.modal{
  width:min(420px, 100%);
  background:#fff;
  border-radius:16px;
  box-shadow:0 18px 50px rgba(0,0,0,.28);
  border:1px solid rgba(0,0,0,.10);
  padding:16px;
}
.modalTitle{ font-weight:900; font-size:15px; color:#111; margin:0 0 6px; }
.modalMsg{ font-size:13px; color:#444; line-height:1.5; margin:0; white-space:pre-line; }
.modalBtns{ display:flex; gap:8px; margin-top:14px; }
.modalBtn{
  flex:1;
  padding:12px 12px;
  border-radius:12px;
  border:0;
  font-weight:900;
  cursor:pointer;
}
.modalBtn.ok{ background:#03c75a; color:#fff; }
.modalBtn.dark{ background:#111; color:#fff; }
.spinnerRow{ display:flex; align-items:center; gap:10px; margin-top:10px; }
.spinner{
  width:18px; height:18px; border-radius:999px;
  border:3px solid rgba(0,0,0,.12);
  border-top-color:#03c75a;
  animation:spin 0.8s linear infinite;
}
@keyframes spin{ to{ transform:rotate(360deg);} }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>ì¥í•­ì§€êµ¬ ë§›ì§‘ ì œë³´</h1>
    <p class="sub">ì œë³´ëœ ë§›ì§‘ì€ ê´€ë¦¬ì í™•ì¸ í›„ ìŠ¹ì¸ë˜ë©´ ì§€ë„ì— í‘œì‹œë¼ìš” ğŸ™‚<br/>ê°€ëŠ¥í•˜ë©´ <b>ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ë§í¬</b>ë¥¼ ë„£ì–´ì£¼ë©´ ì¢‹ì•„ìš”.</p>

    <label>ê°€ê²Œëª… *</label>
    <input id="name" placeholder="ì˜ˆ) ëŒ€ë°•ê°" maxlength="40" />

    <label>ì£¼ì†Œ *</label>
    <input id="address" placeholder="ì˜ˆ) ê³ ì–‘ì‹œ ì¼ì‚°ë™êµ¬ ..." maxlength="120" />

    <label>ì¹´í…Œê³ ë¦¬ (ë³µìˆ˜ ì„ íƒ) *</label>
    <div id="cats" class="chips"></div>

    <label>í•œì¤„ ì†Œê°œ (ì„ íƒ)</label>
    <textarea id="desc" placeholder="ì˜ˆ) ì–‘ ë§ê³  ê°€ì„±ë¹„ ì¢‹ì•„ìš”" maxlength="200"></textarea>

    <label>ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ë§í¬ (ì„ íƒ)</label>
    <input id="placeUrl" placeholder="ì˜ˆ) https://place.map.naver.com/..." maxlength="200" />

    <div class="row">
      <div>
        <label>ë‹‰ë„¤ì„ (ì„ íƒ)</label>
        <input id="nickname" placeholder="ì˜ˆ) ì¥í•­ë§˜" maxlength="20" />
      </div>
      <div>
        <label>ì¶”ì²œ íƒœê·¸(ì„ íƒ)</label>
        <input id="tags" placeholder="ì˜ˆ) ì•„ì´ë™ë°˜,ì£¼ì°¨" maxlength="80" />
      </div>
    </div>

    <button class="btn" id="btnSubmit" onclick="submitRestaurant()">ì œë³´í•˜ê¸°</button>
    <button class="btn secondary" onclick="goBack()">ì§€ë„ë¡œ ëŒì•„ê°€ê¸°</button>

    <div class="small">
      * ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì§€ë„ì— í‘œì‹œë©ë‹ˆë‹¤.
    </div>
  </div>
</div>

<!-- âœ… ëª¨ë‹¬ -->
<div class="modalBack" id="modalBack" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
    <div class="modalTitle" id="mTitle">ì•ˆë‚´</div>
    <p class="modalMsg" id="mMsg"></p>

    <div class="spinnerRow" id="mSpinRow" style="display:none;">
      <div class="spinner"></div>
      <div style="font-size:12px; color:#555;">ìš”ì²­ ì²˜ë¦¬ ì¤‘â€¦</div>
    </div>

    <div class="modalBtns" id="mBtns">
      <button class="modalBtn ok" id="mOkBtn" type="button">í™•ì¸</button>
    </div>
  </div>
</div>

<script>
const API_URL = "https://twilight-art-ed3c.wlalsqqq.workers.dev";

const CATEGORY_MASTER = ["í•œì‹","ì¤‘ì‹","ì¼ì‹","ì–‘ì‹","ì¹´í˜","ë¶„ì‹","ê³ ê¸°","ë°°ë‹¬","ì¹˜í‚¨","í”¼ì","ë””ì €íŠ¸"];
const selected = new Set();

const catsEl = document.getElementById("cats");
CATEGORY_MASTER.forEach(c=>{
  const el = document.createElement("div");
  el.className = "chip";
  el.textContent = c;
  el.onclick = () => {
    if (selected.has(c)) selected.delete(c);
    else selected.add(c);
    el.classList.toggle("active", selected.has(c));
  };
  catsEl.appendChild(el);
});

/* ===== âœ… ëª¨ë‹¬ ì œì–´ ===== */
const modalBack = document.getElementById("modalBack");
const mTitle = document.getElementById("mTitle");
const mMsg = document.getElementById("mMsg");
const mSpinRow = document.getElementById("mSpinRow");
const mBtns = document.getElementById("mBtns");
const mOkBtn = document.getElementById("mOkBtn");

let modalClosable = true;
let okHandler = null;

function showModal({ title="ì•ˆë‚´", message="", loading=false, closable=true, okText="í™•ì¸", onOk=null }){
  modalClosable = closable;
  okHandler = onOk;

  mTitle.textContent = title;
  mMsg.textContent = message;

  mSpinRow.style.display = loading ? "flex" : "none";
  mBtns.style.display = loading ? "none" : "flex";

  mOkBtn.textContent = okText;

  modalBack.classList.add("show");
  modalBack.setAttribute("aria-hidden","false");
}

function closeModal(){
  modalBack.classList.remove("show");
  modalBack.setAttribute("aria-hidden","true");
  okHandler = null;
}

mOkBtn.addEventListener("click", ()=>{
  if (typeof okHandler === "function") okHandler();
  closeModal();
});

modalBack.addEventListener("click", (e)=>{
  if (!modalClosable) return;
  if (e.target === modalBack) closeModal();
});

document.addEventListener("keydown", (e)=>{
  if (e.key === "Escape" && modalBack.classList.contains("show") && modalClosable){
    closeModal();
  }
});

/* ===== ì œì¶œ ===== */
async function submitRestaurant(){
  const btn = document.getElementById("btnSubmit");

  const name = document.getElementById("name").value.trim();
  const address = document.getElementById("address").value.trim();
  const category = [...selected].join(",");

  const desc = document.getElementById("desc").value.trim();
  const placeUrl = document.getElementById("placeUrl").value.trim();
  const nickname = document.getElementById("nickname").value.trim();
  const tags = document.getElementById("tags").value.trim();

  if(!name || !address){
    return showModal({ title:"ì…ë ¥ í™•ì¸", message:"ê°€ê²Œëª…/ì£¼ì†ŒëŠ” ê¼­ ì…ë ¥í•´ì¤˜!", loading:false, closable:true });
  }
  if(selected.size === 0){
    return showModal({ title:"ì…ë ¥ í™•ì¸", message:"ì¹´í…Œê³ ë¦¬ë¥¼ ìµœì†Œ 1ê°œ ì„ íƒí•´ì¤˜!", loading:false, closable:true });
  }

  // âœ… ë¡œë”© íŒì—… (ë‹«ê¸° ë¶ˆê°€)
  showModal({
    title:"ë“±ë¡ ìš”ì²­ ì¤‘",
    message:"ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” ğŸ™‚",
    loading:true,
    closable:false
  });

  btn.disabled = true;

  try{
    const res = await fetch(API_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        action:"submitRestaurant", // âœ… GASì™€ í†µì¼
        data:{ name, address, category, tags, placeUrl, desc, nickname }
      })
    });

    const json = await res.json();

    if(!json.ok){
      // âœ… ì‹¤íŒ¨ íŒì—…
      showModal({
        title:"ë“±ë¡ ì‹¤íŒ¨",
        message:`ì œë³´ì— ì‹¤íŒ¨í–ˆì–´ìš”.\n\nì‚¬ìœ : ${json.error || "unknown"}`,
        loading:false,
        closable:true
      });
      return;
    }

    // âœ… ì„±ê³µ íŒì—…
    showModal({
      title:"ë“±ë¡ ì™„ë£Œ ğŸ‰",
      message:"ì œë³´ê°€ ì ‘ìˆ˜ëì–´ìš”!\nê´€ë¦¬ì ìŠ¹ì¸ í›„ ì§€ë„ì— í‘œì‹œë©ë‹ˆë‹¤ ğŸ™‚",
      loading:false,
      closable:true
    });

    // ì…ë ¥ ì´ˆê¸°í™”
    document.getElementById("name").value = "";
    document.getElementById("address").value = "";
    document.getElementById("desc").value = "";
    document.getElementById("placeUrl").value = "";
    document.getElementById("nickname").value = "";
    document.getElementById("tags").value = "";
    selected.clear();
    document.querySelectorAll(".chip").forEach(ch => ch.classList.remove("active"));

  }catch(e){
    console.error(e);
    showModal({
      title:"ë“±ë¡ ì‹¤íŒ¨",
      message:"ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì¤˜!",
      loading:false,
      closable:true
    });
  }finally{
    btn.disabled = false;
  }
}

function goBack(){ location.href = "./"; }
</script>
</body>
</html>
