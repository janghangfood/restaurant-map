<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>장항지구 맛집지도</title>

<script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=g7937mmgwu"></script>

<style>
html, body { margin:0; padding:0; height:100%; font-family: -apple-system, BlinkMacSystemFont, 'Noto Sans KR'; }
#map { width:100%; height:100%; }

.sheet {
  position: fixed; left:0; right:0; bottom:0;
  background:#fff;
  border-radius:16px 16px 0 0;
  box-shadow:0 -6px 20px rgba(0,0,0,.2);
  padding:16px;
  display:none;
  z-index:1000;
}
.sheet.show { display:block; }
.title { font-weight:900; font-size:16px; }
.addr { font-size:13px; color:#555; margin-top:4px; }

.desc { margin-top:10px; font-size:13px; color:#222; line-height:1.35; }
.nick { margin-top:6px; font-size:12px; color:#666; }

.meta { margin-top:8px; display:flex; gap:6px; flex-wrap:wrap; }
.pill { font-size:12px; padding:4px 8px; border-radius:999px; background:#f2f2f2; }

.btn {
  margin-top:12px;
  padding:12px;
  background:#03c75a;
  color:#fff;
  text-align:center;
  border-radius:10px;
  font-weight:800;
  cursor:pointer;
}

.close-btn {
  position: absolute; top: 16px; right: 16px;
  width: 24px; height: 24px;
  cursor: pointer; font-size: 20px; color: #999;
}

.comments { margin-top:12px; border-top:1px solid #eee; padding-top:12px; }
.c-item{ padding:8px 0; border-bottom:1px solid #f0f0f0; }
.c-head{ display:flex; justify-content:space-between; gap:10px; }
.c-nick{ font-weight:800; font-size:12px; color:#111; }
.c-time{ font-size:11px; color:#777; }
.c-body{ margin-top:4px; font-size:13px; color:#222; line-height:1.35; }
.c-form{ display:flex; gap:8px; margin-top:10px; }
.c-form input{ flex:1; border:1px solid #ddd; border-radius:10px; padding:10px; font-size:13px; }
.c-form button{ border:0; border-radius:10px; padding:10px 12px; background:#111; color:#fff; font-weight:800; }
</style>
</head>

<body>
<div id="map"></div>

<div id="sheet" class="sheet">
  <span class="close-btn" onclick="closeSheet()">×</span>
  <div class="title" id="sName"></div>
  <div class="addr" id="sAddr"></div>

  <div class="desc" id="sDesc" style="display:none;"></div>
  <div class="nick" id="sNick" style="display:none;"></div>

  <div class="meta" id="sMeta"></div>

  <div class="btn" onclick="openNaverMap()">네이버지도에서 보기</div>

  <div class="comments">
    <div style="font-weight:900;margin-bottom:6px;">댓글</div>
    <div id="cList"></div>
    <div class="c-form">
      <input id="cNick" placeholder="닉네임" maxlength="20" />
      <input id="cText" placeholder="댓글 내용" maxlength="120" />
      <button onclick="addComment()">등록</button>
    </div>
  </div>
</div>

<script>
const API_URL = "https://twilight-art-ed3c.wlalsqqq.workers.dev";

let selected = null;
let map = null;
const markers = [];

function parseCats(str){
  return String(str||"").split(",").map(s=>s.trim()).filter(Boolean);
}
function esc(s){
  return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

function initMap() {
  if (!window.naver || !naver.maps) {
    setTimeout(initMap, 100);
    return;
  }

  map = new naver.maps.Map('map', {
    center: new naver.maps.LatLng(37.661, 126.764),
    zoom: 14
  });

  naver.maps.Event.addListener(map, 'click', () => closeSheet());
  loadRestaurants();
}

async function loadRestaurants() {
  try{
    const r = await fetch(API_URL + "?action=list");
    const json = await r.json();
    if(!json.ok) return console.error("list fail", json);

    markers.forEach(m => m.setMap(null));
    markers.length = 0;

    json.data.forEach(item => {
      const marker = new naver.maps.Marker({
        position: new naver.maps.LatLng(item.lat, item.lng),
        map
      });

      naver.maps.Event.addListener(marker, 'click', () => {
        selected = item;
        showSheet(item);
        loadComments(item.id);
      });

      markers.push(marker);
    });

  }catch(e){
    console.error(e);
  }
}

function showSheet(item){
  document.getElementById("sName").textContent = item.name || "";
  document.getElementById("sAddr").textContent = item.address || "";

  // ✅ desc 표시
  const descEl = document.getElementById("sDesc");
  if(item.desc && String(item.desc).trim()){
    descEl.style.display = "block";
    descEl.textContent = String(item.desc);
  }else{
    descEl.style.display = "none";
    descEl.textContent = "";
  }

  // ✅ nickname 표시
  const nickEl = document.getElementById("sNick");
  if(item.nickname && String(item.nickname).trim()){
    nickEl.style.display = "block";
    nickEl.textContent = "제보: " + String(item.nickname);
  }else{
    nickEl.style.display = "none";
    nickEl.textContent = "";
  }

  const cats = parseCats(item.category);
  const tags = parseCats(item.tags);

  const pills = [];
  if(cats.length) pills.push(...cats.map(c=>`<span class="pill">${esc(c)}</span>`));
  if(tags.length) pills.push(...tags.map(t=>`<span class="pill">#${esc(t)}</span>`));
  document.getElementById("sMeta").innerHTML = pills.join("");

  document.getElementById("sheet").classList.add("show");
}

function closeSheet(){
  document.getElementById("sheet").classList.remove("show");
}

function openNaverMap(){
  if(!selected) return;

  // ✅ placeUrl이 있으면 그걸 최우선으로 연다 (이상한 주소 방지)
  const placeUrl = String(selected.placeUrl||"").trim();
  if(placeUrl && /^https?:\/\//i.test(placeUrl)){
    window.open(placeUrl, "_blank");
    return;
  }

  // 없으면 기존 방식 fallback
  const name = encodeURIComponent(selected.name || "");
  const lat = selected.lat;
  const lng = selected.lng;
  const appname = encodeURIComponent("장항지구맛집");

  const ua = navigator.userAgent.toLowerCase();
  if (ua.indexOf('android') > -1) {
    const targetUrl = 'intent://place?lat=' + lat +
      '&lng=' + lng +
      '&name=' + name +
      '&appname=' + appname +
      '#Intent;scheme=nmap;package=com.nhn.android.nmap;end';
    window.open(targetUrl, '_blank');
  } else if (/iphone|ipad/.test(ua)) {
    const url = 'nmap://place?lat=' + lat + '&lng=' + lng + '&name=' + name + '&appname=' + appname;
    location.href = url;
  } else {
    window.open('https://map.naver.com/v5/search/' + name, "_blank");
  }
}

async function loadComments(restaurantId){
  const list = document.getElementById("cList");
  list.innerHTML = "불러오는 중...";

  try{
    const r = await fetch(API_URL + `?action=comments&restaurantId=${encodeURIComponent(restaurantId)}`);
    const json = await r.json();
    if(!json.ok){ list.innerHTML = "댓글 로드 실패"; return; }

    const data = json.data || [];
    if(!data.length){ list.innerHTML = "<div style='color:#777;font-size:13px;'>댓글이 아직 없어요</div>"; return; }

    list.innerHTML = data.map(c => `
      <div class="c-item">
        <div class="c-head">
          <div class="c-nick">${esc(c.nickname)}</div>
          <div class="c-time">${esc(c.createdAt || "")}</div>
        </div>
        <div class="c-body">${esc(c.content)}</div>
      </div>
    `).join("");

  }catch(e){
    console.error(e);
    list.innerHTML = "댓글 로드 실패";
  }
}

async function addComment(){
  if(!selected) return;

  const nickname = document.getElementById("cNick").value.trim();
  const content = document.getElementById("cText").value.trim();
  if(!nickname || !content) return;

  try{
    const r = await fetch(API_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        action:"addcomment",
        data:{ restaurantId: selected.id, nickname, content }
      })
    });
    const json = await r.json();
    if(!json.ok){ alert("댓글 등록 실패: " + (json.error||"")); return; }

    document.getElementById("cText").value = "";
    loadComments(selected.id);

  }catch(e){
    console.error(e);
    alert("댓글 등록 실패(네트워크)");
  }
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initMap);
} else {
  initMap();
}
</script>
</body>
</html>
