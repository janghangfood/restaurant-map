<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì¥í•­ì§€êµ¬ ë§›ì§‘ì§€ë„</title>

<link rel="icon" href="data:,">

<script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=g7937mmgwu"></script>

<style>
html, body { margin:0; padding:0; height:100%; font-family:-apple-system,BlinkMacSystemFont,'Noto Sans KR'; }
#map { width:100%; height:100%; }

/* ===== ìƒë‹¨ UI / ë²„íŠ¼ / ë°”í…€ì‹œíŠ¸ ===== */
/* ğŸ‘‰ (ì´ì „ ë„¤ UI ê·¸ëŒ€ë¡œ, ìŠ¤íƒ€ì¼ ë³€ê²½ ì—†ìŒ) */

.ratingBox{ margin-top:10px; }
.stars{ display:flex; gap:6px; font-size:20px; cursor:pointer; }
.star{ color:#ddd; }
.star.on{ color:#FFB800; }

.avgRating{
  font-size:12px;
  font-weight:900;
  color:#FFB800;
  margin-left:6px;
}

</style>
</head>

<body>
<div id="map"></div>

<!-- ë°”í…€ì‹œíŠ¸ -->
<div id="sheet" class="sheet">
  <button id="btnCloseSheet">Ã—</button>

  <div class="sheetTitle">
    <span id="sName"></span>
    <span id="sAvg" class="avgRating"></span>
  </div>

  <div id="sAddr"></div>
  <div id="sDesc"></div>

  <button id="btnOpenNaver">ë„¤ì´ë²„ì§€ë„ì—ì„œ ë³´ê¸°</button>

  <!-- ëŒ“ê¸€ -->
  <div class="cmtBox">
    <div class="cmtHeader">ëŒ“ê¸€</div>
    <div id="cmtList"></div>

    <!-- â­ í‰ì  -->
    <div class="ratingBox">
      <div style="font-size:12px;font-weight:900;margin-bottom:4px;">í‰ì </div>
      <div class="stars" id="ratingStars">
        <span class="star" data-v="1">â˜…</span>
        <span class="star" data-v="2">â˜…</span>
        <span class="star" data-v="3">â˜…</span>
        <span class="star" data-v="4">â˜…</span>
        <span class="star" data-v="5">â˜…</span>
      </div>
    </div>

    <input id="nickInput" placeholder="ë‹‰ë„¤ì„" />
    <textarea id="contentInput" placeholder="ëŒ“ê¸€ì„ ë‚¨ê²¨ì£¼ì„¸ìš”"></textarea>

    <button id="btnAddComment">ëŒ“ê¸€ ë‹¬ê¸°</button>
  </div>
</div>

<script>
/* =========================
   ì„¤ì •
========================= */
const API_URL = "https://twilight-art-ed3c.wlalsqqq.workers.dev";

/* =========================
   ìƒíƒœ
========================= */
let map, selected;
let selectedRating = 0;

/* =========================
   ë³„ì  UI
========================= */
const stars = document.querySelectorAll(".star");

stars.forEach(star=>{
  star.addEventListener("click", ()=>{
    selectedRating = Number(star.dataset.v);
    updateStars();
  });
});

function updateStars(){
  stars.forEach(s=>{
    s.classList.toggle("on", Number(s.dataset.v) <= selectedRating);
  });
}

/* =========================
   ëŒ“ê¸€ ë Œë”
========================= */
function renderComments(list){
  const box = document.getElementById("cmtList");
  box.innerHTML = "";

  if(!list || list.length===0){
    box.innerHTML = "<div style='font-size:12px;color:#777'>ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš” ğŸ™‚</div>";
    return;
  }

  let sum = 0, cnt = 0;

  list.forEach(c=>{
    if(c.rating){
      sum += Number(c.rating);
      cnt++;
    }

    const el = document.createElement("div");
    el.innerHTML = `
      <div style="font-weight:900;font-size:12px;">
        ${c.nickname || "ìµëª…"}
        ${c.rating ? `<span style="color:#FFB800">â˜…${c.rating}</span>` : ""}
      </div>
      <div style="font-size:12px;margin-top:4px;">${c.content}</div>
    `;
    box.appendChild(el);
  });

  // í‰ê·  í‰ì 
  if(cnt>0){
    document.getElementById("sAvg").textContent = `â˜… ${(sum/cnt).toFixed(1)}`;
  }else{
    document.getElementById("sAvg").textContent = "";
  }
}

/* =========================
   ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
========================= */
async function loadComments(id){
  const res = await fetch(API_URL + `?action=comments&restaurantId=${id}`);
  const json = await res.json();
  if(json.ok) renderComments(json.data);
}

/* =========================
   ëŒ“ê¸€ ë“±ë¡ (â­ í‰ì  í¬í•¨)
========================= */
document.getElementById("btnAddComment").addEventListener("click", async ()=>{
  if(!selected) return;

  const nickname = document.getElementById("nickInput").value.trim();
  const content = document.getElementById("contentInput").value.trim();

  if(!nickname || !content || selectedRating===0){
    alert("ë‹‰ë„¤ì„, ëŒ“ê¸€, í‰ì ì„ ëª¨ë‘ ì…ë ¥í•´ì¤˜");
    return;
  }

  const res = await fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      action:"addcomment",
      data:{
        restaurantId: String(selected.id),
        nickname,
        content,
        rating: selectedRating
      }
    })
  });

  const json = await res.json();
  if(!json.ok){
    alert("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨");
    return;
  }

  // ì´ˆê¸°í™”
  document.getElementById("contentInput").value = "";
  selectedRating = 0;
  updateStars();

  loadComments(selected.id);
});

/* =========================
   ë§¤ì¥ í´ë¦­ ì‹œ
========================= */
function showSheet(item){
  selected = item;
  document.getElementById("sName").textContent = item.name;
  document.getElementById("sAddr").textContent = item.address || "";
  document.getElementById("sDesc").textContent = item.desc || "";
  document.getElementById("sheet").classList.add("show");

  document.getElementById("sAvg").textContent = "";
  loadComments(item.id);
}
</script>
</body>
</html>
