<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì¥í•­ì§€êµ¬ ë§›ì§‘ì§€ë„</title>

  <!-- âœ… ë„¤ì´ë²„ ì§€ë„ SDK -->
  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=g7937mmgwu"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; font-family: -apple-system, BlinkMacSystemFont, "Noto Sans KR", sans-serif; }
    #map { width:100%; height:100%; }

    /* ìƒë‹¨ í•„í„°ë°” */
    .filter-bar{
      position: fixed;
      top: 10px; left: 10px; right: 10px;
      display: flex; gap: 8px; flex-wrap: wrap;
      z-index: 2000;
      pointer-events: none; /* ì•„ë˜ map í„°ì¹˜ ìœ ì§€ */
    }
    .chip{
      pointer-events: auto; /* ì¹©ë§Œ í´ë¦­ ê°€ëŠ¥ */
      padding: 8px 10px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 999px;
      font-size: 13px;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      box-shadow: 0 2px 10px rgba(0,0,0,.08);
    }
    .chip.active{
      border-color: #03c75a;
      background: #03c75a1a;
      font-weight: 700;
    }
    .fab{
      position: fixed;
      right: 14px;
      bottom: 92px;
      z-index: 2500;
      background:#03c75a;
      color:#fff;
      padding:12px 14px;
      border-radius:999px;
      font-weight:900;
      text-decoration:none;
      box-shadow:0 10px 24px rgba(0,0,0,.18);
    }
    /* ë°”í…€ì‹œíŠ¸ */
    .sheet {
      position: fixed;
      left:0; right:0; bottom:0;
      background:#fff;
      border-radius:16px 16px 0 0;
      box-shadow:0 -6px 20px rgba(0,0,0,.2);
      padding:16px;
      display:none;
      z-index:3000;
      max-height: 70vh;
      overflow: auto;
    }
    .sheet.show { display:block; }
    .title { font-weight:800; font-size:16px; }
    .addr { font-size:13px; color:#555; margin-top:4px; }
    .meta { font-size:12px; color:#777; margin-top:6px; }

    .btn {
      margin-top:12px;
      padding:12px;
      background:#03c75a;
      color:#fff;
      text-align:center;
      border-radius:12px;
      font-weight:700;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn.secondary{
      background:#f3f4f6;
      color:#111;
      font-weight:700;
    }

    .close-btn {
      position: absolute;
      top: 10px;
      right: 12px;
      width: 32px;
      height: 32px;
      cursor: pointer;
      font-size: 22px;
      color: #999;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius: 999px;
    }
    .close-btn:active{ background:#f3f4f6; }

    /* ëŒ“ê¸€ */
    .comments{
      margin-top: 14px;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    .comment{
      padding: 10px 0;
      border-bottom: 1px solid #f1f1f1;
    }
    .comment .meta2{
      font-size: 12px;
      color:#666;
      margin-bottom: 4px;
    }
    .comment-form{
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin-top: 10px;
    }
    .comment-form input, .comment-form textarea{
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 12px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .comment-form textarea{
      min-height: 74px;
      resize: vertical;
    }

    /* ë¡œë”©/ì—ëŸ¬ ë°°ë„ˆ */
    .banner{
      position: fixed;
      left: 10px; right: 10px;
      bottom: 10px;
      z-index: 4000;
      background: rgba(0,0,0,.78);
      color: #fff;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
      display: none;
    }
    .banner.show{ display:block; }
  </style>
</head>

<body>
  <div id="filterBar" class="filter-bar"></div>
  <div id="map"></div>

  <a href="./submit.html" class="fab">â• ë§›ì§‘ ì œë³´</a>
  
  <div id="sheet" class="sheet">
    <span class="close-btn" onclick="closeSheet()">Ã—</span>
    <div class="title" id="sName"></div>
    <div class="addr" id="sAddr"></div>
    <div class="meta" id="sCats"></div>

    <div class="btn" onclick="openNaverMap()">ë„¤ì´ë²„ì§€ë„ì—ì„œ ë³´ê¸°</div>
    <div class="btn secondary" onclick="closeSheet()">ë‹«ê¸°</div>

    <div class="comments">
      <div id="commentList"></div>

      <div class="comment-form">
        <input id="nick" placeholder="ë‹‰ë„¤ì„" maxlength="20" />
        <textarea id="commentText" placeholder="ëŒ“ê¸€ì„ ë‚¨ê²¨ì£¼ì„¸ìš”" maxlength="300"></textarea>
        <div class="btn" onclick="submitComment()">ëŒ“ê¸€ ë“±ë¡</div>
      </div>
    </div>
  </div>

  <div id="banner" class="banner"></div>

<script>
/******** ì„¤ì • ********/
// âœ… GAS ì›¹ì•±(exec) URL (ë„ˆê°€ ì“°ë˜ ì£¼ì†Œ)
//const API_URL = "https://script.google.com/macros/s/AKfycbxRhXGNOU0pDv1aLXHB_yvDgtCkQhw_-cnNM5vX1eMBi_3XPw-KEZ1xXWH9K327Jlizyg/exec";
const API_URL = "https://twilight-art-ed3c.wlalsqqq.workers.dev";
// âœ… í‘œì‹œí•  ì¹´í…Œê³ ë¦¬(ì›í•˜ë©´ ì—¬ê¸°ë§Œ ìˆ˜ì •)
const CATEGORY_MASTER = ["ì „ì²´","í•œì‹","ì¤‘ì‹","ì¼ì‹","ì–‘ì‹","ì¹´í˜","ë¶„ì‹","ê³ ê¸°","ë°°ë‹¬","ì¹˜í‚¨","í”¼ì","ë””ì €íŠ¸"];
/************************/

let map = null;
let selected = null;

let allRestaurants = [];   // ì „ì²´ ë°ì´í„°
let markers = [];          // í˜„ì¬ í‘œì‹œì¤‘ ë§ˆì»¤
let selectedCategories = new Set(); // ì„ íƒëœ ì¹´í…Œê³ ë¦¬(ë³µìˆ˜)

/* ---------- ìœ í‹¸ ---------- */
function showBanner(msg){
  const el = document.getElementById("banner");
  el.textContent = msg;
  el.classList.add("show");
  setTimeout(()=>el.classList.remove("show"), 2500);
}
function escapeHtml(str) {
  return String(str || "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

/* ---------- ì§€ë„ ì´ˆê¸°í™” ---------- */
function initMap() {
  if (!window.naver || !naver.maps) {
    console.error("ë„¤ì´ë²„ ì§€ë„ SDK ë¡œë“œ ì‹¤íŒ¨(ì¸ì¦ ì‹¤íŒ¨ ê°€ëŠ¥)");
    showBanner("ë„¤ì´ë²„ ì§€ë„ ë¡œë”© ì‹¤íŒ¨(ì½˜ì†” 200 ì¸ì¦ ì˜¤ë¥˜ í™•ì¸)");
    setTimeout(initMap, 300);
    return;
  }

  map = new naver.maps.Map("map", {
    center: new naver.maps.LatLng(37.661, 126.764),
    zoom: 14
  });

  // âœ… ì§€ë„ í´ë¦­í•˜ë©´ ë°”í…€ì‹œíŠ¸ ë‹«ê¸° (ì—¬ê¸°ì„œë§Œ!)
  map.addListener("click", closeSheet);

  renderFilterBar();
  loadRestaurants();
}

/* ---------- í•„í„° UI ---------- */
function renderFilterBar() {
  const bar = document.getElementById("filterBar");
  bar.innerHTML = "";

  CATEGORY_MASTER.forEach(cat => {
    const chip = document.createElement("div");
    chip.className = "chip";
    chip.textContent = cat;
    chip.onclick = () => toggleCategory(cat);
    bar.appendChild(chip);
  });

  updateFilterActiveUI();
}

function updateFilterActiveUI() {
  document.querySelectorAll(".chip").forEach(chip => {
    const cat = chip.textContent;
    if (cat === "ì „ì²´") {
      chip.classList.toggle("active", selectedCategories.size === 0);
    } else {
      chip.classList.toggle("active", selectedCategories.has(cat));
    }
  });
}

function toggleCategory(cat) {
  if (cat === "ì „ì²´") {
    selectedCategories.clear();
  } else {
    if (selectedCategories.has(cat)) selectedCategories.delete(cat);
    else selectedCategories.add(cat);
  }
  updateFilterActiveUI();
  renderMarkers();
}

/* ---------- ë°ì´í„° ë¡œë“œ ---------- */
function loadRestaurants() {
  fetch(API_URL + "?action=list")
    .then(r => r.json())
    .then(json => {
      if (!json.ok) {
        showBanner("ë§›ì§‘ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");
        return;
      }

      // category ì»¬ëŸ¼ì´ "ì¤‘ì‹,ë°°ë‹¬" ê°™ì€ í˜•íƒœì—¬ë„ ì²˜ë¦¬
      allRestaurants = (json.data || []).map(r => ({
        ...r,
        categories: String(r.category || "")
          .split(",")
          .map(s => s.trim())
          .filter(Boolean)
      }));

      renderMarkers();
      showBanner("ë§›ì§‘ " + allRestaurants.length + "ê°œ ë¡œë“œ ì™„ë£Œ");
    })
    .catch(err => {
      console.error("Fetch ì—ëŸ¬:", err);
      showBanner("API ì—°ê²° ì‹¤íŒ¨(ì½˜ì†” í™•ì¸)");
    });
}

/* ---------- ë§ˆì»¤ ë Œë”ë§ ---------- */
function clearMarkers() {
  markers.forEach(m => m.setMap(null));
  markers = [];
}

function passFilter(r) {
  // ì„ íƒì´ ì—†ìœ¼ë©´ ì „ì²´
  if (selectedCategories.size === 0) return true;

  // OR ì¡°ê±´: í•˜ë‚˜ë¼ë„ í¬í•¨ë˜ë©´ í†µê³¼
  return (r.categories || []).some(c => selectedCategories.has(c));
}

function renderMarkers() {
  if (!map) return;

  clearMarkers();
  const filtered = allRestaurants.filter(passFilter);

  filtered.forEach(item => {
    const marker = new naver.maps.Marker({
      position: new naver.maps.LatLng(item.lat, item.lng),
      map: map
    });

    naver.maps.Event.addListener(marker, "click", () => {
      selected = item;
      showSheet(item);
      loadComments(item.id);
    });

    markers.push(marker);
  });

  showBanner("í‘œì‹œì¤‘: " + filtered.length + "ê°œ");
}

/* ---------- ë°”í…€ì‹œíŠ¸ ---------- */
function showSheet(item) {
  document.getElementById("sName").textContent = item.name || "";
  document.getElementById("sAddr").textContent = item.address || "";

  const cats = (item.categories && item.categories.length)
    ? "ì¹´í…Œê³ ë¦¬: " + item.categories.join(", ")
    : "ì¹´í…Œê³ ë¦¬: (ë¯¸ì§€ì •)";
  document.getElementById("sCats").textContent = cats;

  document.getElementById("sheet").classList.add("show");
}

function closeSheet() {
  document.getElementById("sheet").classList.remove("show");
  selected = null;
}

/* ---------- ë„¤ì´ë²„ì§€ë„ ì•±/ì›¹ ì´ë™ ---------- */
function openNaverMap() {
  if (!selected) return;

  const name = encodeURIComponent(selected.name || "");
  const lat = selected.lat;
  const lng = selected.lng;
  const appname = encodeURIComponent("ì¥í•­ì§€êµ¬ë§›ì§‘");

  const ua = navigator.userAgent.toLowerCase();
  const isAndroid = ua.includes("android");
  const isIOS = /iphone|ipad|ipod/.test(ua);

  if (isAndroid) {
    // âœ… ê°€ì¥ ì•ˆì •ì ì¸ ë°©ì‹: location.href
    location.href =
      "intent://place?lat=" + lat +
      "&lng=" + lng +
      "&name=" + name +
      "&appname=" + appname +
      "#Intent;scheme=nmap;package=com.nhn.android.nmap;end";
    return;
  }

  if (isIOS) {
    // iOS: ì•± ì—´ê¸° ì‹œë„ + fallback
    location.href =
      "nmap://place?lat=" + lat +
      "&lng=" + lng +
      "&name=" + name +
      "&appname=" + appname;

    setTimeout(() => {
      location.href = "https://map.naver.com/v5/search/" + name;
    }, 800);
    return;
  }

  location.href = "https://map.naver.com/v5/search/" + name;
}

/* ---------- ëŒ“ê¸€ ---------- */
function loadComments(restaurantId) {
  const list = document.getElementById("commentList");
  list.innerHTML = `<div style="color:#666;font-size:13px;padding:8px 0;">ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>`;

  fetch(API_URL + "?action=comments&restaurantId=" + encodeURIComponent(restaurantId))
    .then(r => r.json())
    .then(json => {
      const data = json.data || [];
      list.innerHTML = "";

      if (!data.length) {
        list.innerHTML = `<div style="color:#666;font-size:13px;padding:8px 0;">ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ì£¼ì„¸ìš” ğŸ™‚</div>`;
        return;
      }

      data.forEach(c => {
        const el = document.createElement("div");
        el.className = "comment";
        const date = (c.createdAt || "").slice(0, 10);
        el.innerHTML =
          `<div class="meta2">${escapeHtml(c.nickname)} Â· ${escapeHtml(date)}</div>` +
          `<div>${escapeHtml(c.content)}</div>`;
        list.appendChild(el);
      });
    })
    .catch(err => {
      console.error("ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨:", err);
      list.innerHTML = `<div style="color:#b00;font-size:13px;padding:8px 0;">ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨</div>`;
    });
}

function submitComment() {
  if (!selected) return;

  const nickname = document.getElementById("nick").value.trim();
  const content = document.getElementById("commentText").value.trim();

  if (!nickname || !content) {
    alert("ë‹‰ë„¤ì„ê³¼ ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì¤˜");
    return;
  }

  fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      action: "addComment",
      data: { restaurantId: selected.id, nickname, content }
    })
  })
  .then(r => r.json())
  .then(json => {
    if (!json.ok) {
      alert("ëŒ“ê¸€ ì €ì¥ ì‹¤íŒ¨");
      return;
    }
    document.getElementById("commentText").value = "";
    loadComments(selected.id);
    showBanner("ëŒ“ê¸€ ë“±ë¡ ì™„ë£Œ");
  })
  .catch(err => {
    console.error("ëŒ“ê¸€ ì €ì¥ ì‹¤íŒ¨:", err);
    alert("ëŒ“ê¸€ ì €ì¥ ì‹¤íŒ¨(ì½˜ì†” í™•ì¸)");
  });
}

/* ---------- ì‹œì‘ ---------- */
document.addEventListener("DOMContentLoaded", initMap);
</script>
</body>
</html>
