<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì¥í•­ì§€êµ¬ ë§›ì§‘ì§€ë„</title>

<link rel="icon" href="data:,">

<!-- ë„¤ì´ë²„ ì§€ë„ SDK -->
<script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=g7937mmgwu"></script>

<style>
html,body{margin:0;padding:0;height:100%;font-family:-apple-system,BlinkMacSystemFont,'Noto Sans KR'}
#map{width:100%;height:100%}

/* ===== ìƒë‹¨ UI ===== */
.topUI{position:fixed;left:12px;right:12px;top:12px;z-index:9999;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.topRow{display:flex;justify-content:space-between;align-items:center}
.brand{font-weight:900;font-size:15px}
.status{font-size:12px;color:#333}
.controls{pointer-events:auto}
.toggleBtn{display:flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#fff;border:1px solid #ddd;font-size:12px;font-weight:800;cursor:pointer}
.toggleBtn.on{background:#03c75a;color:#fff}
.toggleDot{width:8px;height:8px;border-radius:50%;background:#999}
.toggleBtn.on .toggleDot{background:#fff}

.chipBar{display:flex;gap:6px;overflow-x:auto;pointer-events:auto}
.chip{padding:6px 10px;border-radius:999px;background:#fff;border:1px solid #ddd;font-size:12px;font-weight:800;white-space:nowrap;cursor:pointer}
.chip.on{background:#03c75a;color:#fff;border-color:#03c75a}

/* ë²„íŠ¼ */
.locBtn{position:fixed;right:16px;bottom:86px;z-index:9999;width:42px;height:42px;border-radius:50%;border:1px solid #ccc;background:#fff;font-size:18px}
.fab{position:fixed;right:16px;bottom:18px;z-index:9999;width:56px;height:56px;border-radius:50%;background:#03c75a;color:#fff;font-weight:900;border:0}

/* ë°”í…€ì‹œíŠ¸ */
.sheet{position:fixed;left:0;right:0;bottom:0;max-height:70vh;background:#fff;border-radius:16px 16px 0 0;box-shadow:0 -6px 20px rgba(0,0,0,.2);padding:16px;display:none;z-index:9998;overflow:auto}
.sheet.show{display:block}
.close-btn{position:sticky;top:0;margin-left:auto;width:28px;height:28px;border-radius:50%;border:1px solid #ddd;background:#fff}
.sheetTitle{font-size:16px;font-weight:900}
.addr{font-size:13px;color:#555;margin-top:4px}
.meta{margin-top:8px;display:flex;gap:6px;flex-wrap:wrap}
.pill{font-size:12px;padding:4px 8px;border-radius:999px;background:#f2f2f2}

.btn{margin-top:12px;width:100%;padding:12px;border-radius:12px;border:0;background:#03c75a;color:#fff;font-weight:900}
.btn.secondary{background:#111}

/* ëŒ“ê¸€ */
.cmtItem{border:1px solid #eee;border-radius:12px;padding:10px;margin-top:8px}
.cmtNick{font-weight:900;font-size:13px}
.cmtTime{font-size:11px;color:#777}
.cmtContent{font-size:13px;margin-top:6px}
.input{width:100%;padding:10px;border-radius:12px;border:1px solid #ddd;font-size:13px}
</style>
</head>

<body>
<div id="map"></div>

<div class="topUI">
  <div class="topRow">
    <div>
      <div class="brand">ì¥í•­ì§€êµ¬ ë§›ì§‘ì§€ë„</div>
      <div class="status" id="statusText">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
    </div>
    <div class="controls">
      <div id="nearBtn" class="toggleBtn">
        <span class="toggleDot"></span> 500m
      </div>
    </div>
  </div>
  <div class="chipBar" id="chips"></div>
</div>

<button class="locBtn" id="btnMyLoc">â¦¿</button>
<button class="fab" id="fabReport">ì œë³´</button>

<div id="sheet" class="sheet">
  <button class="close-btn" onclick="closeSheet()">Ã—</button>
  <div class="sheetTitle" id="sName"></div>
  <div class="addr" id="sAddr"></div>
  <div class="meta" id="sMeta"></div>

  <button class="btn" onclick="openNaverMap()">ë„¤ì´ë²„ì§€ë„ì—ì„œ ë³´ê¸°</button>

  <div id="cmtList"></div>
  <input class="input" id="nickInput" placeholder="ë‹‰ë„¤ì„">
  <textarea class="input" id="contentInput" placeholder="ëŒ“ê¸€"></textarea>
  <button class="btn secondary" onclick="addComment()">ëŒ“ê¸€ ë‹¬ê¸°</button>
</div>

<script>
const API_URL="https://twilight-art-ed3c.wlalsqqq.workers.dev";
const REPORT_URL="./submit.html";

let map,selected,userPos=null;
let allData=[],markers=[];
let useNear=false;

const CAT_EMOJI={
 "ì¹´í˜":"â˜•","í•œì‹":"ğŸš","ì¤‘ì‹":"ğŸ¥Ÿ","ì¼ì‹":"ğŸ£","ì–‘ì‹":"ğŸ",
 "ì¹˜í‚¨":"ğŸ—","í”¼ì":"ğŸ•","ë¶„ì‹":"ğŸ¢","ë°°ë‹¬":"ğŸ›µ","ê¸°íƒ€":"ğŸ“"
};

function markerHtml(item,showLabel){
 const emoji=CAT_EMOJI[item.category?.split(",")[0]]||"ğŸ“";
 const star=item.tier==="verified"?"â˜…":"";
 return `
 <div style="transform:translate(-50%,-100%);text-align:center">
  <div style="position:relative;width:38px;height:38px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 6px 16px rgba(0,0,0,.2)">
    ${emoji}
    ${star?`<div style="position:absolute;top:-6px;right:-6px;width:18px;height:18px;border-radius:50%;background:#ffb400;color:#fff;font-size:12px;font-weight:900;display:flex;align-items:center;justify-content:center">â˜…</div>`:""}
  </div>
  ${showLabel?`<div style="margin-top:4px;font-size:12px;font-weight:900;background:#fff;padding:4px 8px;border-radius:999px">${item.name}</div>`:""}
 </div>`;
}

function initMap(){
 map=new naver.maps.Map("map",{center:new naver.maps.LatLng(37.661,126.764),zoom:14});
 loadRestaurants();
}

function loadRestaurants(){
 fetch(API_URL+"?action=list").then(r=>r.json()).then(j=>{
  allData=j.data||[];
  render();
 });
}

function render(){
 markers.forEach(m=>m.setMap(null));markers=[];
 allData.forEach(item=>{
  const m=new naver.maps.Marker({
   position:new naver.maps.LatLng(item.lat,item.lng),
   map,
   icon:{content:markerHtml(item,map.getZoom()>14)}
  });
  naver.maps.Event.addListener(m,"click",()=>{selected=item;showSheet(item)});
  markers.push(m);
 });
}

function showSheet(item){
 document.getElementById("sName").textContent=item.name+(item.tier==="verified"?" â˜…":"");
 document.getElementById("sAddr").textContent=item.address||"";
 document.getElementById("sMeta").innerHTML=`<span class="pill">${item.category}</span>`;
 document.getElementById("sheet").classList.add("show");
}

function closeSheet(){document.getElementById("sheet").classList.remove("show");}
function openNaverMap(){if(selected)window.open("https://map.naver.com/v5/search/"+encodeURIComponent(selected.name));}

function addComment(){
 fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},
 body:JSON.stringify({action:"addcomment",data:{restaurantId:selected.id,nickname:nickInput.value,content:contentInput.value}})})
 .then(()=>{nickInput.value="";contentInput.value=""});
}

document.getElementById("fabReport").onclick=()=>location.href=REPORT_URL;
document.getElementById("btnMyLoc").onclick=()=>navigator.geolocation.getCurrentPosition(p=>{
 userPos={lat:p.coords.latitude,lng:p.coords.longitude};
 map.panTo(new naver.maps.LatLng(userPos.lat,userPos.lng));
});

document.addEventListener("DOMContentLoaded",initMap);
</script>
</body>
</html>
