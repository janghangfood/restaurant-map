<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì¥í•­ì§€êµ¬ ë§›ì§‘ì§€ë„</title>

<script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=g7937mmgwu"></script>

<style>
html, body { margin:0; padding:0; height:100%; font-family: -apple-system, BlinkMacSystemFont, 'Noto Sans KR'; }
#map { width:100%; height:100%; }

/* ìƒë‹¨ ê³ ì • ì»¨íŠ¸ë¡¤ */
.topbar {
  position: fixed;
  left: 12px;
  right: 12px;
  top: 12px;
  z-index: 2000;
  display: flex;
  flex-direction: column;
  gap: 10px;
  pointer-events: none; /* ë‚´ë¶€ë§Œ í´ë¦­ ê°€ëŠ¥ */
}
.card {
  pointer-events: auto;
  background: rgba(255,255,255,.95);
  backdrop-filter: blur(10px);
  border-radius: 14px;
  box-shadow: 0 10px 24px rgba(0,0,0,.12);
  border: 1px solid rgba(0,0,0,.06);
  padding: 10px;
}

/* row */
.row {
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap:10px;
}
.title {
  font-weight: 900;
  font-size: 14px;
}
.sub {
  font-size: 12px;
  color: #555;
}

/* í† ê¸€ */
.toggle {
  display:flex;
  align-items:center;
  gap:8px;
  user-select:none;
}
.toggle input { width:18px; height:18px; }

/* ì¹´í…Œê³ ë¦¬ ì¹© */
.chips {
  display:flex;
  gap:8px;
  flex-wrap: wrap;
}
.chip {
  padding: 7px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 800;
  background: #f2f2f2;
  border: 1px solid rgba(0,0,0,.06);
  cursor: pointer;
}
.chip.on {
  background: #03c75a;
  color: #fff;
}

/* ì œë³´ ë²„íŠ¼ */
.primaryBtn {
  background:#03c75a;
  color:#fff;
  font-weight: 900;
  border-radius: 12px;
  padding: 10px 12px;
  text-align:center;
  cursor:pointer;
  border: 0;
}

/* ë°”í…€ì‹œíŠ¸ */
.sheet {
  position: fixed;
  left:0; right:0; bottom:0;
  background:#fff;
  border-radius:16px 16px 0 0;
  box-shadow:0 -6px 20px rgba(0,0,0,.2);
  padding:16px;
  display:none;
  z-index:1000;
}
.sheet.show { display:block; }
.sheetTitle { font-weight:900; font-size:16px; }
.addr { font-size:13px; color:#555; margin-top:4px; }
.meta { margin-top:8px; display:flex; gap:6px; flex-wrap:wrap; }
.pill {
  font-size:12px;
  padding:4px 8px;
  border-radius:999px;
  background:#f2f2f2;
}
.btn {
  margin-top:12px;
  padding:12px;
  background:#03c75a;
  color:#fff;
  text-align:center;
  border-radius:10px;
  font-weight:900;
  cursor:pointer;
}
.close-btn {
  position: absolute;
  top: 16px;
  right: 16px;
  width: 24px;
  height: 24px;
  cursor: pointer;
  font-size: 20px;
  color: #999;
}
</style>
</head>

<body>
<div id="map"></div>

<!-- ìƒë‹¨ ê³ ì • UI: (1) ë‚´ì£¼ë³€ 500m, (2) ì¹´í…Œê³ ë¦¬, (3) ì œë³´ ë²„íŠ¼ -->
<div class="topbar">
  <div class="card">
    <div class="row">
      <div>
        <div class="title">ì¥í•­ì§€êµ¬ ë§›ì§‘ì§€ë„</div>
        <div class="sub" id="statusText">ìœ„ì¹˜ í™•ì¸ ì¤‘â€¦</div>
      </div>

      <div class="toggle">
        <input id="nearToggle" type="checkbox" checked />
        <label for="nearToggle" style="font-size:12px;font-weight:900;cursor:pointer;">ë‚´ì£¼ë³€ 500m</label>
      </div>

      <button class="primaryBtn" id="reportBtn" type="button">ì œë³´</button>
    </div>
  </div>

  <div class="card">
    <div class="row" style="margin-bottom:8px;">
      <div class="title">ì¹´í…Œê³ ë¦¬</div>
      <div class="sub" id="filterText">ì „ì²´</div>
    </div>
    <div class="chips" id="chips"></div>
  </div>
</div>

<!-- ë°”í…€ì‹œíŠ¸ -->
<div id="sheet" class="sheet">
  <span class="close-btn" onclick="closeSheet()">Ã—</span>
  <div class="sheetTitle" id="sName"></div>
  <div class="addr" id="sAddr"></div>
  <div class="meta" id="sMeta"></div>
  <div class="btn" onclick="openNaverMap()">ë„¤ì´ë²„ì§€ë„ì—ì„œ ë³´ê¸°</div>
</div>

<script>
/******** ì„¤ì • ********/
const API_URL = "https://twilight-art-ed3c.wlalsqqq.workers.dev"; // âœ… Worker
const REPORT_URL = "./submit.html"; // âœ… ì œë³´ í˜ì´ì§€(ì—†ìœ¼ë©´ ë§Œë“¤ì–´ì•¼ í•¨)
/************************/

let selected = null;
let map = null;

const markers = [];          // { marker, item }
let allData = [];            // APIì—ì„œ ë°›ì€ ì „ì²´ ë§›ì§‘
let userLatLng = null;       // naver.maps.LatLng
let watchId = null;

const ICON_W = 110;
const ICON_H = 110;
function iconSize(){ return new naver.maps.Size(ICON_W, ICON_H); }
function iconAnchor(){ return new naver.maps.Point(Math.floor(ICON_W/2), ICON_H); }

/* =========================
   ì¹´í…Œê³ ë¦¬ â†’ ì´ëª¨ì§€ (B ë°©ì‹)
========================= */
const CATEGORY_PRIORITY = [
  "ì¹´í˜","ë””ì €íŠ¸","ë¸ŒëŸ°ì¹˜","ë² ì´ì»¤ë¦¬",
  "í•œì‹","êµ­ë°¥","ê³ ê¸°","í•´ì‚°ë¬¼","ë©´",
  "ì¤‘ì‹","ì¼ì‹","ì´ˆë°¥","ìŠ¤ì‹œ","ëˆê¹ŒìŠ¤","ì–‘ì‹","ì•„ì‹œì•„",
  "ë¶„ì‹","ì¹˜í‚¨","í”¼ì","í–„ë²„ê±°","ìƒëŸ¬ë“œ","ìˆ ì§‘",
  "ë°°ë‹¬"
];

const CAT_EMOJI = {
  "ì¹´í˜": "â˜•",
  "ë””ì €íŠ¸": "ğŸ°",
  "ë¸ŒëŸ°ì¹˜": "ğŸ¥",
  "ë² ì´ì»¤ë¦¬": "ğŸ¥–",
  "í•œì‹": "ğŸš",
  "êµ­ë°¥": "ğŸ¥˜",
  "ê³ ê¸°": "ğŸ¥©",
  "í•´ì‚°ë¬¼": "ğŸ¦",
  "ë©´": "ğŸœ",
  "ì¤‘ì‹": "ğŸ¥Ÿ",
  "ì¼ì‹": "ğŸ£",
  "ì´ˆë°¥": "ğŸ£",
  "ìŠ¤ì‹œ": "ğŸ£",
  "ëˆê¹ŒìŠ¤": "ğŸ–",
  "ì–‘ì‹": "ğŸ",
  "ì•„ì‹œì•„": "ğŸ›",
  "ë¶„ì‹": "ğŸ¢",
  "ì¹˜í‚¨": "ğŸ—",
  "í”¼ì": "ğŸ•",
  "í–„ë²„ê±°": "ğŸ”",
  "ìƒëŸ¬ë“œ": "ğŸ¥—",
  "ìˆ ì§‘": "ğŸº",
  "ë°°ë‹¬": "ğŸ›µ",
  "ê¸°íƒ€": "ğŸ“"
};

function parseCats(str){
  return String(str||"")
    .split(",")
    .map(s=>s.trim())
    .filter(Boolean);
}
function pickMainCategory(categoryStr){
  const cats = parseCats(categoryStr);
  for (const p of CATEGORY_PRIORITY){
    if (cats.includes(p)) return p;
  }
  return cats[0] || "ê¸°íƒ€";
}
function emojiOf(cat){
  return CAT_EMOJI[cat] || CAT_EMOJI["ê¸°íƒ€"];
}
function esc(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function markerHtmlEmojiB(item, showLabel){
  const cats = parseCats(item.category);
  const main = pickMainCategory(item.category);
  const extras = cats.filter(c => c !== main).slice(0, 2);

  const mainEmoji = emojiOf(main);
  const extraEmojis = extras.map(c => emojiOf(c));

  const badge = extraEmojis.length ? `
    <div style="
      position:absolute; right:-10px; top:-10px;
      display:flex; gap:2px;
      background:#fff; border-radius:999px;
      padding:2px 6px; font-size:14px;
      box-shadow:0 4px 12px rgba(0,0,0,.18);
      border:1px solid rgba(0,0,0,.06);
    ">
      ${extraEmojis.map(e => `<span>${e}</span>`).join("")}
    </div>
  ` : "";

  return `
    <div style="
      transform: translate(-50%, -100%);
      display:flex; flex-direction:column; align-items:center; gap:6px;
      pointer-events:auto;
    ">
      <div style="position:relative;">
        <div style="
          width:38px; height:38px; border-radius:19px;
          background:#fff;
          display:flex; align-items:center; justify-content:center;
          font-size:22px;
          box-shadow:0 8px 20px rgba(0,0,0,.22);
          border:1px solid rgba(0,0,0,.06);
        ">
          ${mainEmoji}
        </div>
        ${badge}
      </div>

      ${showLabel ? `
        <div style="
          max-width:220px;
          background:#fff;
          padding:6px 10px;
          border-radius:999px;
          font-size:12px;
          font-weight:900;
          white-space:nowrap;
          overflow:hidden;
          text-overflow:ellipsis;
          box-shadow:0 8px 20px rgba(0,0,0,.18);
          border:1px solid rgba(0,0,0,.06);
        ">
          ${esc(item.name)}
        </div>
      ` : ""}
    </div>
  `;
}

/* =========================
   í•„í„° UI
========================= */
const selectedCats = new Set(); // ë³µìˆ˜ ì„ íƒ
const chipsEl = document.getElementById("chips");
const filterTextEl = document.getElementById("filterText");
const nearToggleEl = document.getElementById("nearToggle");
const statusTextEl = document.getElementById("statusText");

function buildChipsFromData(data){
  // ë°ì´í„°ì— ìˆëŠ” ì¹´í…Œê³ ë¦¬ë¥¼ ë½‘ì•„ì„œ ì¹© ìƒì„±
  const set = new Set();
  data.forEach(it => parseCats(it.category).forEach(c => set.add(c)));
  const cats = Array.from(set);

  // ìš°ì„ ìˆœìœ„ ê¸°ë°˜ ì •ë ¬ + ë‚˜ë¨¸ì§€
  cats.sort((a,b)=>{
    const ia = CATEGORY_PRIORITY.indexOf(a);
    const ib = CATEGORY_PRIORITY.indexOf(b);
    if (ia === -1 && ib === -1) return a.localeCompare(b, "ko");
    if (ia === -1) return 1;
    if (ib === -1) return -1;
    return ia - ib;
  });

  chipsEl.innerHTML = "";
  cats.forEach(cat=>{
    const btn = document.createElement("div");
    btn.className = "chip";
    btn.textContent = `${emojiOf(cat)} ${cat}`;
    btn.onclick = () => {
      if (selectedCats.has(cat)) selectedCats.delete(cat);
      else selectedCats.add(cat);
      renderChipStates();
      applyFiltersAndRender();
    };
    btn.dataset.cat = cat;
    chipsEl.appendChild(btn);
  });

  renderChipStates();
}

function renderChipStates(){
  const chips = chipsEl.querySelectorAll(".chip");
  chips.forEach(ch=>{
    const cat = ch.dataset.cat;
    if (selectedCats.has(cat)) ch.classList.add("on");
    else ch.classList.remove("on");
  });

  filterTextEl.textContent = selectedCats.size ? Array.from(selectedCats).join(", ") : "ì „ì²´";
}

nearToggleEl.addEventListener("change", () => applyFiltersAndRender());

document.getElementById("reportBtn").addEventListener("click", () => {
  window.location.href = REPORT_URL;
});

/* =========================
   ì§€ë„ ì´ˆê¸°í™” + ìœ„ì¹˜ ì¶”ì 
========================= */
function initMap() {
  if (typeof naver === 'undefined' || typeof naver.maps === 'undefined') {
    console.error('ë„¤ì´ë²„ ì§€ë„ SDK ë¡œë“œ ì‹¤íŒ¨');
    setTimeout(initMap, 100);
    return;
  }

  map = new naver.maps.Map('map', {
    center: new naver.maps.LatLng(37.661, 126.764),
    zoom: 14
  });

  // ì§€ë„ í´ë¦­ ì‹œ ë°”í…€ì‹œíŠ¸ ë‹«ê¸°
  naver.maps.Event.addListener(map, 'click', () => closeSheet());

  // ì¤Œ ë³€ê²½ ì‹œ ë¼ë²¨ on/off (ì¤Œ 14 ì´í•˜ ë¼ë²¨ ìˆ¨ê¹€)
  naver.maps.Event.addListener(map, "zoom_changed", () => {
    updateMarkerIcons();
  });

  loadRestaurants();
  startWatchLocation();
}

function startWatchLocation(){
  if (!navigator.geolocation) {
    statusTextEl.textContent = "ì´ ê¸°ê¸°ì—ì„œ ìœ„ì¹˜ ì‚¬ìš© ë¶ˆê°€";
    return;
  }

  // ì´ë™í•  ë•Œë§ˆë‹¤ ê°±ì‹ 
  watchId = navigator.geolocation.watchPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      userLatLng = new naver.maps.LatLng(lat, lng);
      statusTextEl.textContent = "ë‚´ ìœ„ì¹˜ ê¸°ì¤€ í•„í„° ì ìš© ì¤‘";

      // ì²˜ìŒ ì¡íˆë©´ ì§€ë„ë¥¼ ë‚´ ìœ„ì¹˜ë¡œ ë¶€ë“œëŸ½ê²Œ ì´ë™(ì›ì¹˜ ì•Šìœ¼ë©´ ì£¼ì„)
      // map.panTo(userLatLng);

      applyFiltersAndRender();
    },
    (err) => {
      console.warn("ìœ„ì¹˜ ì˜¤ë¥˜:", err);
      statusTextEl.textContent = "ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•´ìš”(ë‚´ì£¼ë³€ 500m ê¸°ëŠ¥)";
      // ìœ„ì¹˜ ì—†ìœ¼ë©´ â€œë‚´ì£¼ë³€ 500mâ€ í† ê¸€ êº¼ë„ ë˜ê¸´ í•¨
    },
    { enableHighAccuracy: true, maximumAge: 3000, timeout: 10000 }
  );
}

/* =========================
   ë°ì´í„° ë¡œë“œ
========================= */
function loadRestaurants() {
  fetch(API_URL + '?action=list')
    .then(r => r.json())
    .then(json => {
      if (!json.ok) {
        console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', json);
        statusTextEl.textContent = "ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨";
        return;
      }

      allData = json.data || [];
      console.log('ë§›ì§‘ ë°ì´í„°:', allData);

      buildChipsFromData(allData);
      statusTextEl.textContent = "í•„í„° ì¤€ë¹„ ì™„ë£Œ";

      applyFiltersAndRender();
    })
    .catch(err => {
      console.error('Fetch ì—ëŸ¬:', err);
      statusTextEl.textContent = "ë°ì´í„° ìš”ì²­ ì˜¤ë¥˜";
    });
}

/* =========================
   í•„í„° ì ìš© (ë‚´ì£¼ë³€ 500m + ì¹´í…Œê³ ë¦¬)
========================= */
function within500m(item){
  if (!userLatLng) return true; // ìœ„ì¹˜ ì—†ìœ¼ë©´ ê±°ë¦¬ í•„í„° ë¬´ì‹œ
  const itemPos = new naver.maps.LatLng(item.lat, item.lng);
  const m = naver.maps.GeometryUtil.getDistance(userLatLng, itemPos);
  return m <= 500;
}

function matchCategory(item){
  if (selectedCats.size === 0) return true;
  const cats = parseCats(item.category);
  for (const c of cats){
    if (selectedCats.has(c)) return true; // â€œí¬í•¨â€ì´ë©´ í†µê³¼
  }
  return false;
}

function applyFiltersAndRender(){
  if (!map) return;

  const useNear = nearToggleEl.checked;

  const filtered = allData.filter(it=>{
    if (!matchCategory(it)) return false;
    if (useNear && userLatLng) return within500m(it);
    if (useNear && !userLatLng) return false; // ë‚´ì£¼ë³€ í† ê¸€ ONì¸ë° ìœ„ì¹˜ ì—†ìœ¼ë©´ ì•„ë¬´ê²ƒë„ ëª» ë³´ì—¬ì¤Œ
    return true;
  });

  renderMarkers(filtered);

  if (nearToggleEl.checked && !userLatLng) {
    statusTextEl.textContent = "ë‚´ì£¼ë³€ 500m: ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•´ìš”";
  } else {
    statusTextEl.textContent = `í‘œì‹œ ${filtered.length}ê°œ`;
  }
}

/* =========================
   ë§ˆì»¤ ë Œë”
========================= */
function clearMarkers(){
  markers.forEach(m => m.marker.setMap(null));
  markers.length = 0;
}

function updateMarkerIcons(){
  const showLabel = map.getZoom() > 14; // ì¤Œ 15+ ë¼ë²¨ í‘œì‹œ
  markers.forEach(({ marker, item }) => {
    marker.setIcon({
      content: markerHtmlEmojiB(item, showLabel),
      size: iconSize(),
      anchor: iconAnchor()
    });
  });
}

function renderMarkers(data){
  clearMarkers();

  const showLabel = map.getZoom() > 14;

  data.forEach(item => {
    const marker = new naver.maps.Marker({
      position: new naver.maps.LatLng(item.lat, item.lng),
      map,
      icon: {
        content: markerHtmlEmojiB(item, showLabel),
        size: iconSize(),
        anchor: iconAnchor()
      }
    });

    naver.maps.Event.addListener(marker, 'click', () => {
      selected = item;
      showSheet(item);
    });

    markers.push({ marker, item });
  });
}

/* =========================
   ë°”í…€ì‹œíŠ¸
========================= */
function showSheet(item) {
  document.getElementById('sName').textContent = item.name || '';
  document.getElementById('sAddr').textContent = item.address || '';

  const cats = parseCats(item.category);
  const tags = parseCats(item.tags);

  const pills = [];
  if (cats.length) pills.push(...cats.map(c => `<span class="pill">${esc(c)}</span>`));
  if (tags.length) pills.push(...tags.map(t => `<span class="pill">#${esc(t)}</span>`));

  document.getElementById('sMeta').innerHTML = pills.join("");
  document.getElementById('sheet').classList.add('show');
}

function closeSheet() {
  document.getElementById('sheet').classList.remove('show');
}

/* =========================
   ë„¤ì´ë²„ì§€ë„ ì•±/ì›¹ ì´ë™
========================= */
function openNaverMap() {
  if (!selected) return;

  const name = encodeURIComponent(selected.name || "");
  const lat = selected.lat;
  const lng = selected.lng;
  const appname = encodeURIComponent('ì¥í•­ì§€êµ¬ë§›ì§‘');

  const ua = navigator.userAgent.toLowerCase();
  let targetUrl = '';

  if (ua.indexOf('android') > -1) {
    targetUrl = 'intent://place?lat=' + lat +
      '&lng=' + lng +
      '&name=' + name +
      '&appname=' + appname +
      '#Intent;scheme=nmap;package=com.nhn.android.nmap;end';
    window.open(targetUrl, '_blank');

  } else if (/iphone|ipad/.test(ua)) {
    const link = document.createElement('a');
    link.href = 'nmap://place?lat=' + lat +
      '&lng=' + lng +
      '&name=' + name +
      '&appname=' + appname;
    link.target = '_blank';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

  } else {
    targetUrl = 'https://map.naver.com/v5/search/' + name;
    window.open(targetUrl, '_blank');
  }
}

// í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì§€ë„ ì´ˆê¸°í™”
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initMap);
} else {
  initMap();
}
</script>
</body>
</html>
