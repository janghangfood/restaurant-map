<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì¥í•­ì§€êµ¬ ë§›ì§‘ì§€ë„</title>

<link rel="icon" href="data:,">

<!-- ë„¤ì´ë²„ ì§€ë„ SDK -->
<script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=g7937mmgwu"></script>

<style>
html,body{margin:0;padding:0;height:100%;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR"}
#map{width:100%;height:100%}

/* ìƒë‹¨ */
.topUI{position:fixed;top:10px;left:10px;right:10px;z-index:10}
.topRow{display:flex;justify-content:space-between;align-items:center}
.brand{font-weight:900;font-size:15px}
.toggles{display:flex;gap:6px}
.toggle{background:#fff;border-radius:999px;padding:6px 10px;font-size:12px;
  border:1px solid #ddd;cursor:pointer}
.toggle.on{background:#03c75a;color:#fff;border-color:#03c75a}

.chips{display:flex;gap:6px;overflow-x:auto;margin-top:6px}
.chip{background:#fff;border-radius:999px;padding:6px 10px;font-size:12px;
  border:1px solid #ddd;white-space:nowrap;cursor:pointer}
.chip.on{background:#111;color:#fff}

/* FAB */
.fab{position:fixed;right:16px;bottom:18px;width:56px;height:56px;
  border-radius:50%;background:#03c75a;color:#fff;font-weight:900;border:0;z-index:10}
.locBtn{position:fixed;right:16px;bottom:86px;width:44px;height:44px;
  border-radius:50%;background:#fff;border:1px solid #ccc;z-index:10}

/* ë°”í…€ì‹œíŠ¸ */
.sheet{position:fixed;left:0;right:0;bottom:0;max-height:70%;
  background:#fff;border-radius:16px 16px 0 0;
  box-shadow:0 -6px 20px rgba(0,0,0,.2);
  display:none;overflow:auto;z-index:20}
.sheet.show{display:block}
.sheetHeader{position:sticky;top:0;background:#fff;padding:14px;border-bottom:1px solid #eee;z-index:1}
.close{position:absolute;right:14px;top:14px;font-size:20px;cursor:pointer}

.section{padding:14px}
.pill{display:inline-block;background:#f2f2f2;border-radius:999px;padding:4px 8px;font-size:12px;margin-right:6px}

.star{color:#f5a623}

/* ëŒ“ê¸€ */
.cmt{border-top:1px solid #eee;padding-top:10px;margin-top:10px}
.input{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd}
.btn{width:100%;padding:10px;background:#111;color:#fff;border:0;border-radius:8px;margin-top:6px}
</style>
</head>

<body>
<div id="map"></div>

<div class="topUI">
  <div class="topRow">
    <div class="brand">ì¥í•­ì§€êµ¬ ë§›ì§‘ì§€ë„</div>
    <div class="toggles">
      <div id="toggleNear" class="toggle">500m</div>
      <div id="toggleVerified" class="toggle">ğŸ‘‘ ì¸ì¦</div>
    </div>
  </div>
  <div id="chips" class="chips"></div>
</div>

<button class="locBtn" id="btnLoc">â¦¿</button>
<button class="fab" onclick="location.href='submit.html'">ì œë³´</button>

<div id="sheet" class="sheet">
  <div class="sheetHeader">
    <strong id="sName"></strong>
    <span id="sCrown"></span>
    <div class="close" onclick="closeSheet()">Ã—</div>
  </div>
  <div class="section">
    <div id="sDesc"></div>
    <div id="sAddr" style="font-size:13px;color:#555;margin-top:4px"></div>
    <div id="sMeta" style="margin-top:6px"></div>
    <button class="btn" onclick="openNaver()">ë„¤ì´ë²„ì§€ë„ì—ì„œ ë³´ê¸°</button>

    <div class="cmt">
      <strong>ëŒ“ê¸€ / í‰ì </strong>
      <div id="cmtList"></div>

      <input id="nick" class="input" placeholder="ë‹‰ë„¤ì„">
      <select id="rating" class="input">
        <option value="5">â˜…â˜…â˜…â˜…â˜…</option>
        <option value="4">â˜…â˜…â˜…â˜…</option>
        <option value="3">â˜…â˜…â˜…</option>
        <option value="2">â˜…â˜…</option>
        <option value="1">â˜…</option>
      </select>
      <textarea id="content" class="input" placeholder="í•œì¤„í‰"></textarea>
      <button class="btn" onclick="addComment()">ë“±ë¡</button>
    </div>
  </div>
</div>

<script>
const API_URL = "https://twilight-art-ed3c.wlalsqqq.workers.dev";


let map, all=[], markers=[], selected=null;
let useNear=false, onlyVerified=false, userPos=null;

const cats=new Set(), selectedCats=new Set();

/* ì§€ë„ */
map=new naver.maps.Map("map",{center:new naver.maps.LatLng(37.661,126.764),zoom:14});

/* ë°ì´í„° */
fetch(API_URL+"?action=list").then(r=>r.json()).then(j=>{
  all=j.data||[];
  buildChips();
  render();
});

/* ì¹© */
function buildChips(){
  all.forEach(i=>i.category.split(",").forEach(c=>cats.add(c.trim())));
  const el=document.getElementById("chips");
  el.innerHTML="";
  cats.forEach(c=>{
    const d=document.createElement("div");
    d.className="chip";
    d.textContent=c;
    d.onclick=()=>{d.classList.toggle("on");toggleCat(c,d.classList.contains("on"))};
    el.appendChild(d);
  });
}
function toggleCat(c,on){
  on?selectedCats.add(c):selectedCats.delete(c);
  render();
}

/* í•„í„° */
document.getElementById("toggleNear").onclick=()=>{
  useNear=!useNear;
  document.getElementById("toggleNear").classList.toggle("on",useNear);
  if(useNear&&!userPos)getLocation();
  render();
};
document.getElementById("toggleVerified").onclick=()=>{
  onlyVerified=!onlyVerified;
  document.getElementById("toggleVerified").classList.toggle("on",onlyVerified);
  render();
};

/* ìœ„ì¹˜ */
function getLocation(){
  navigator.geolocation.getCurrentPosition(p=>{
    userPos={lat:p.coords.latitude,lng:p.coords.longitude};
  });
}
document.getElementById("btnLoc").onclick=()=>userPos&&map.panTo(new naver.maps.LatLng(userPos.lat,userPos.lng));

/* ë Œë” */
function render(){
  markers.forEach(m=>m.setMap(null)); markers=[];
  all.filter(i=>{
    if(onlyVerified&&i.tier!=="verified")return false;
    if(selectedCats.size&&!i.category.split(",").some(c=>selectedCats.has(c.trim())))return false;
    if(useNear&&userPos){
      const d=naver.maps.LatLng.distance(
        new naver.maps.LatLng(userPos.lat,userPos.lng),
        new naver.maps.LatLng(i.lat,i.lng)
      );
      if(d>500)return false;
    }
    return true;
  }).forEach(i=>{
    const m=new naver.maps.Marker({
      position:new naver.maps.LatLng(i.lat,i.lng),
      map,
      icon:{content:`<div style="font-size:22px">${i.tier==="verified"?"ğŸ‘‘":""}ğŸ“</div>`}
    });
    m.addListener("click",()=>openSheet(i));
    markers.push(m);
  });
}

/* ë°”í…€ì‹œíŠ¸ */
function openSheet(i){
  selected=i;
  sName.textContent=i.name;
  sDesc.textContent=i.desc||"";
  sAddr.textContent=i.address||"";
  sCrown.textContent=i.tier==="verified"?" ğŸ‘‘":"";
  document.getElementById("sheet").classList.add("show");
  loadComments();
}
function closeSheet(){sheet.classList.remove("show")}

function openNaver(){
  window.open(i.placeUrl||`https://map.naver.com/v5/search/${encodeURIComponent(selected.name)}`);
}

/* ëŒ“ê¸€ */
function loadComments(){
  fetch(API_URL+`?action=comments&restaurantId=${selected.id}`)
    .then(r=>r.json()).then(j=>{
      cmtList.innerHTML="";
      j.data.forEach(c=>{
        cmtList.innerHTML+=`<div>${c.nickname} ${"â˜…".repeat(c.rating)}</div>`;
      });
    });
}
function addComment(){
  fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      action:"addcomment",
      data:{
        restaurantId:selected.id,
        nickname:nick.value,
        rating:rating.value,
        content:content.value
      }
    })
  }).then(()=>loadComments());
}
</script>
</body>
</html>
