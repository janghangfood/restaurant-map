<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì¥í•­ì§€êµ¬ ë§›ì§‘ì§€ë„</title>

<script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=g7937mmgwu"></script>

<style>
html, body { margin:0; padding:0; height:100%; font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",sans-serif; }
#map { width:100%; height:100%; }

/* ===== ìƒë‹¨ ì¹´ë“œ (ìŠ¤ìƒ· ëŠë‚Œ) ===== */
.panel {
  position: fixed;
  left: 12px; right: 12px; top: 12px;
  z-index: 1200;
  pointer-events: none;
}
.card {
  pointer-events: auto;
  background: rgba(255,255,255,.92);
  border-radius: 16px;
  box-shadow: 0 12px 26px rgba(0,0,0,.14);
  border: 1px solid rgba(0,0,0,.06);
  padding: 14px 14px 12px;
}
.headerRow{
  display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
}
.hTitle{
  font-size:18px; font-weight:900; margin:0;
}
.hSub{
  font-size:13px; color:#666; margin-top:4px; font-weight:700;
}
.nearToggle{
  display:flex; align-items:center; gap:10px;
}
.checkWrap{
  display:flex; align-items:center; gap:8px;
  font-size:14px; font-weight:900;
  user-select:none;
}
.checkBox{
  width:22px; height:22px; border-radius:6px;
  border:2px solid #cfd3d8;
  background:#fff;
  display:flex; align-items:center; justify-content:center;
}
.checkBox.on{
  border-color:#03c75a;
  background:#03c75a;
  color:#fff;
}
.countPill{
  margin-top:8px;
  display:inline-block;
  font-size:12px;
  font-weight:900;
  color:#333;
}

/* ===== ì¹´í…Œê³ ë¦¬ ì˜ì—­ ===== */
.catTitleRow{
  margin-top:12px;
  display:flex; align-items:center; justify-content:space-between;
  color:#111;
}
.catTitle{
  font-size:16px; font-weight:900;
}
.catAllTxt{
  font-size:13px; color:#555; font-weight:800;
}

.chips {
  margin-top:10px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

.chip{
  display:flex; align-items:center; gap:8px;
  padding:10px 14px;
  border-radius:999px;
  background:#f3f4f6;
  border:1px solid rgba(0,0,0,.06);
  font-size:14px;
  font-weight:900;
  user-select:none;
  cursor:pointer;
}
.chip .e{ font-size:16px; }
.chip.active{
  background:#03c75a;
  color:#fff;
}
.chip.active .e{ filter: brightness(2); }

/* ===== ìš°í•˜ë‹¨ ë²„íŠ¼ (ìŠ¤ìƒ· ëŠë‚Œ) ===== */
.fabSubmit{
  position:fixed;
  right:16px; bottom:22px;
  width:86px; height:86px;
  border-radius:999px;
  border:0;
  background:#03c75a;
  color:#fff;
  font-weight:1000;
  font-size:20px;
  box-shadow:0 14px 26px rgba(0,0,0,.22);
  cursor:pointer;
  z-index:1300;
}
.fabMe{
  position:fixed;
  right:22px; bottom:118px;
  width:48px; height:48px;
  border-radius:999px;
  border:0;
  background:#fff;
  box-shadow:0 12px 22px rgba(0,0,0,.18);
  cursor:pointer;
  z-index:1300;
  display:flex; align-items:center; justify-content:center;
  font-size:20px;
}

/* ===== ë°”í…€ì‹œíŠ¸ ===== */
.sheet {
  position: fixed; left:0; right:0; bottom:0;
  background:#fff;
  border-radius:16px 16px 0 0;
  box-shadow:0 -6px 20px rgba(0,0,0,.2);
  padding:16px;
  display:none;
  z-index:1400;
  max-height:72vh;
  overflow:auto;
}
.sheet.show { display:block; }
.close-btn{
  position:absolute; top:14px; right:16px;
  font-size:22px; color:#999; cursor:pointer;
}
.title { font-weight:900; font-size:16px; padding-right:30px; }
.addr { font-size:13px; color:#555; margin-top:4px; }
.desc { margin-top:10px; font-size:13px; color:#222; line-height:1.35; }
.nick { margin-top:6px; font-size:12px; color:#666; }
.meta { margin-top:8px; display:flex; gap:6px; flex-wrap:wrap; }
.meta .tag{ font-size:12px; padding:4px 8px; border-radius:999px; background:#f2f2f2; }

.btn {
  margin-top:12px;
  padding:12px;
  background:#03c75a;
  color:#fff;
  text-align:center;
  border-radius:12px;
  font-weight:900;
  cursor:pointer;
}

.comments { margin-top:12px; border-top:1px solid #eee; padding-top:12px; }
.c-item{ padding:8px 0; border-bottom:1px solid #f0f0f0; }
.c-head{ display:flex; justify-content:space-between; gap:10px; }
.c-nick{ font-weight:900; font-size:12px; color:#111; }
.c-time{ font-size:11px; color:#777; }
.c-body{ margin-top:4px; font-size:13px; color:#222; line-height:1.35; }
.c-form{ display:flex; gap:8px; margin-top:10px; }
.c-form input{ flex:1; border:1px solid #ddd; border-radius:12px; padding:10px; font-size:13px; }
.c-form button{ border:0; border-radius:12px; padding:10px 12px; background:#111; color:#fff; font-weight:900; }

.toast{
  position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
  background:#111; color:#fff; padding:10px 14px; border-radius:12px;
  font-size:13px; display:none; z-index:2000;
}
.toast.show{display:block;}
</style>
</head>

<body>
<div id="map"></div>

<!-- ìƒë‹¨ íŒ¨ë„ -->
<div class="panel">
  <div class="card">
    <div class="headerRow">
      <div>
        <div class="hTitle">ì¥í•­ì§€êµ¬ ë§›ì§‘ì§€ë„</div>
        <div class="hSub" id="countText">í‘œì‹œ 0ê°œ</div>
      </div>

      <div class="nearToggle">
        <div class="checkWrap" onclick="toggleNear()">
          <div class="checkBox" id="nearBox">âœ“</div>
          <div>ë‚´ì£¼ë³€ 500m</div>
        </div>
      </div>
    </div>

    <div class="catTitleRow">
      <div class="catTitle">ì¹´í…Œê³ ë¦¬</div>
      <div class="catAllTxt" id="catStatus">ì „ì²´</div>
    </div>

    <div class="chips" id="chips"></div>
  </div>
</div>

<!-- ìš°í•˜ë‹¨ ë²„íŠ¼ -->
<button class="fabMe" title="í˜„ì¬ ìœ„ì¹˜" onclick="moveToMe()">â—</button>
<button class="fabSubmit" title="ì œë³´í•˜ê¸°" onclick="goSubmit()">ì œë³´</button>

<!-- ë°”í…€ì‹œíŠ¸ -->
<div id="sheet" class="sheet">
  <span class="close-btn" onclick="closeSheet()">Ã—</span>
  <div class="title" id="sName"></div>
  <div class="addr" id="sAddr"></div>
  <div class="desc" id="sDesc" style="display:none;"></div>
  <div class="nick" id="sNick" style="display:none;"></div>
  <div class="meta" id="sMeta"></div>
  <div class="btn" onclick="openNaverMap()">ë„¤ì´ë²„ì§€ë„ì—ì„œ ë³´ê¸°</div>

  <div class="comments">
    <div style="font-weight:900;margin-bottom:6px;">ëŒ“ê¸€</div>
    <div id="cList" style="color:#777;font-size:13px;">ê°€ê²Œë¥¼ ì„ íƒí•˜ë©´ ëŒ“ê¸€ì´ ë³´ì—¬ìš”</div>
    <div class="c-form">
      <input id="cNick" placeholder="ë‹‰ë„¤ì„" maxlength="20" />
      <input id="cText" placeholder="ëŒ“ê¸€ ë‚´ìš©" maxlength="120" />
      <button onclick="addComment()">ë“±ë¡</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/******** ì„¤ì • ********/
const API_URL = "https://twilight-art-ed3c.wlalsqqq.workers.dev";
const SUBMIT_PAGE = "./submit.html";
const RADIUS_M = 500;
/************************/

let map = null;
let selected = null;

let allRestaurants = [];
let filteredRestaurants = [];
const markerObjs = [];

let watchId = null;
let myPos = null;
let myCircle = null;

// UI ìƒíƒœ
let nearOnly = true; // ê¸°ë³¸: ë‚´ì£¼ë³€ 500m ON (ìŠ¤ìƒ· ëŠë‚Œ)
let selectedCats = new Set(); // ë³µìˆ˜ ì„ íƒ (ì „ì²´ëŠ” set ë¹„ì›€)

// ì¹´í…Œê³ ë¦¬(ìŠ¤ìƒ·ì²˜ëŸ¼ ëª‡ ê°œë§Œ ë¨¼ì €)
const CATEGORY_MASTER = [
  { key:"ì „ì²´", emoji:"âœ¨" },
  { key:"í•œì‹", emoji:"ğŸš" },
  { key:"ê³ ê¸°", emoji:"ğŸ¥©" },
  { key:"ì¤‘ì‹", emoji:"ğŸ¥Ÿ" },
  { key:"ì–‘ì‹", emoji:"ğŸ" },
  { key:"ì¹´í˜", emoji:"â˜•" },
  { key:"ë¶„ì‹", emoji:"ğŸ¢" },
  { key:"ì¹˜í‚¨", emoji:"ğŸ—" },
  { key:"í”¼ì", emoji:"ğŸ•" },
  { key:"ë””ì €íŠ¸", emoji:"ğŸ°" },
  { key:"ë°°ë‹¬", emoji:"ğŸ›µ" }
];

const CAT_EMOJI = {
  "í•œì‹":"ğŸš","ì¤‘ì‹":"ğŸ¥Ÿ","ì¼ì‹":"ğŸ£","ì–‘ì‹":"ğŸ","ì¹´í˜":"â˜•","ë¶„ì‹":"ğŸ¢","ê³ ê¸°":"ğŸ¥©",
  "ì¹˜í‚¨":"ğŸ—","í”¼ì":"ğŸ•","ë””ì €íŠ¸":"ğŸ°","ë°°ë‹¬":"ğŸ›µ","ê¸°íƒ€":"ğŸ“"
};

function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 2500);
}
function esc(s){
  return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}
function parseList(str){
  return String(str||"").split(",").map(s=>s.trim()).filter(Boolean);
}

function pickEmoji(item){
  const cats = parseList(item.category);
  for(const c of cats){
    if(CAT_EMOJI[c]) return CAT_EMOJI[c];
  }
  return CAT_EMOJI["ê¸°íƒ€"];
}

// ì¤Œ 14 ì´í•˜ë©´ ë¼ë²¨ ìˆ¨ê¹€
function markerHtml(item, showLabel){
  const emoji = pickEmoji(item);
  return `
    <div style="transform: translate(-50%, -100%); display:flex; flex-direction:column; align-items:center; gap:6px;">
      <div style="
        width:38px;height:38px;border-radius:19px;background:#fff;
        display:flex;align-items:center;justify-content:center;font-size:22px;
        box-shadow:0 10px 22px rgba(0,0,0,.22);
        border:1px solid rgba(0,0,0,.06);
      ">${emoji}</div>
      ${showLabel ? `
        <div style="
          max-width:220px;background:#fff;padding:6px 10px;border-radius:999px;
          font-size:12px;font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
          box-shadow:0 10px 22px rgba(0,0,0,.18);border:1px solid rgba(0,0,0,.06);
        ">${esc(item.name)}</div>
      ` : ``}
    </div>
  `;
}

/* ===== UI init ===== */
function initChips(){
  const wrap = document.getElementById("chips");
  wrap.innerHTML = "";
  CATEGORY_MASTER.forEach(c=>{
    const el = document.createElement("div");
    el.className = "chip";
    el.innerHTML = `<span class="e">${c.emoji}</span><span>${c.key}</span>`;
    el.onclick = () => toggleCat(c.key, el);

    if(c.key === "ì „ì²´") el.classList.add("active");
    wrap.appendChild(el);
  });

  refreshNearUI();
  refreshCatStatusText();
}

function toggleCat(cat, el){
  const chips = [...document.querySelectorAll(".chip")];
  const allChip = chips.find(x => x.textContent.includes("ì „ì²´"));

  if(cat === "ì „ì²´"){
    selectedCats.clear();
    chips.forEach(x=>x.classList.remove("active"));
    el.classList.add("active");
    applyFiltersAndRender();
    refreshCatStatusText();
    return;
  }

  if(allChip) allChip.classList.remove("active");

  if(selectedCats.has(cat)){
    selectedCats.delete(cat);
    el.classList.remove("active");
  }else{
    selectedCats.add(cat);
    el.classList.add("active");
  }

  if(selectedCats.size === 0 && allChip){
    allChip.classList.add("active");
  }

  applyFiltersAndRender();
  refreshCatStatusText();
}

function refreshCatStatusText(){
  const el = document.getElementById("catStatus");
  if(selectedCats.size === 0) el.textContent = "ì „ì²´";
  else el.textContent = [...selectedCats].join(", ");
}

function toggleNear(){
  nearOnly = !nearOnly;
  refreshNearUI();
  applyFiltersAndRender();
}

function refreshNearUI(){
  const box = document.getElementById("nearBox");
  if(nearOnly){
    box.classList.add("on");
    box.textContent = "âœ“";
  }else{
    box.classList.remove("on");
    box.textContent = "";
  }
}

/* ===== Map init ===== */
async function initMap(){
  if(!window.naver || !naver.maps){
    setTimeout(initMap, 100);
    return;
  }

  map = new naver.maps.Map("map", {
    center: new naver.maps.LatLng(37.661, 126.764),
    zoom: 15
  });

  initChips();

  naver.maps.Event.addListener(map, "click", () => closeSheet());

  naver.maps.Event.addListener(map, "zoom_changed", () => {
    const showLabel = map.getZoom() > 14;
    markerObjs.forEach(o=>{
      o.marker.setIcon({ content: markerHtml(o.item, showLabel), anchor: new naver.maps.Point(0,0) });
    });
  });

  await loadRestaurants();
  startWatchLocation(); // 500m ìë™ê°±ì‹ ì„ ìœ„í•´
}

async function loadRestaurants(){
  try{
    const r = await fetch(API_URL + "?action=list");
    const json = await r.json();
    if(!json.ok){
      console.error(json);
      toast("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");
      return;
    }
    allRestaurants = json.data || [];
    applyFiltersAndRender();
  }catch(e){
    console.error(e);
    toast("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨(ë„¤íŠ¸ì›Œí¬)");
  }
}

function applyFiltersAndRender(){
  // 1) ì¹´í…Œê³ ë¦¬
  let temp = allRestaurants.slice();
  if(selectedCats.size > 0){
    temp = temp.filter(item=>{
      const cats = new Set(parseList(item.category));
      for(const c of selectedCats){
        if(cats.has(c)) return true;
      }
      return false;
    });
  }

  // 2) 500m(nearOnly ONì´ë©´ ê±¸ëŸ¬ì„œ í‘œì‹œ)
  if(nearOnly && myPos){
    temp = temp.filter(item=>{
      const d = haversineM(myPos, {lat:item.lat, lng:item.lng});
      return d <= RADIUS_M;
    });
  }

  filteredRestaurants = temp;
  updateCounts();
  renderMarkers();
}

function updateCounts(){
  // í‘œì‹œ nê°œ
  document.getElementById("countText").textContent = `í‘œì‹œ ${filteredRestaurants.length}ê°œ`;

  // 500m pillì€ "ë‚´ì£¼ë³€ 500m" ë¼ë²¨ì´ë‹ˆê¹Œ ë³„ë„ ìˆ«ì êµ³ì´ ì•ˆ ë¶™ì„(ìŠ¤ìƒ· ê·¸ëŒ€ë¡œ)
}

function renderMarkers(){
  markerObjs.forEach(o=>o.marker.setMap(null));
  markerObjs.length = 0;

  const showLabel = map.getZoom() > 14;

  filteredRestaurants.forEach(item=>{
    const marker = new naver.maps.Marker({
      position: new naver.maps.LatLng(item.lat, item.lng),
      map,
      icon:{ content: markerHtml(item, showLabel), anchor: new naver.maps.Point(0,0) }
    });

    naver.maps.Event.addListener(marker, "click", () => {
      selected = item;
      showSheet(item);
      loadComments(item.id);
    });

    markerObjs.push({marker, item});
  });
}

/* ===== ìœ„ì¹˜/500m ìë™ê°±ì‹  ===== */
function startWatchLocation(){
  if(!navigator.geolocation) return;

  if(watchId !== null) return;

  watchId = navigator.geolocation.watchPosition(
    (pos)=>{
      myPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      drawMyCircle();
      // nearOnly ONì´ë©´ ì´ë™í•  ë•Œë§ˆë‹¤ í•„í„° ìë™ ê°±ì‹ 
      applyFiltersAndRender();
    },
    (err)=>{ console.warn("ìœ„ì¹˜ ì˜¤ë¥˜:", err); },
    { enableHighAccuracy:true, maximumAge:2000, timeout:8000 }
  );
}

function drawMyCircle(){
  if(!map || !myPos) return;
  const center = new naver.maps.LatLng(myPos.lat, myPos.lng);

  if(!myCircle){
    myCircle = new naver.maps.Circle({
      map,
      center,
      radius: RADIUS_M,
      fillOpacity: 0.08,
      strokeOpacity: 0.25,
      strokeWeight: 2
    });
  }else{
    myCircle.setCenter(center);
  }
}

function haversineM(a, b){
  const R = 6371000;
  const toRad = (d)=>d*Math.PI/180;
  const dLat = toRad(b.lat-a.lat);
  const dLng = toRad(b.lng-a.lng);
  const s1 = Math.sin(dLat/2);
  const s2 = Math.sin(dLng/2);
  const q = s1*s1 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
  return 2*R*Math.asin(Math.min(1, Math.sqrt(q)));
}

function moveToMe(){
  if(!navigator.geolocation) return toast("ìœ„ì¹˜ ì§€ì› ì•ˆ ë¨");

  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      myPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      map.panTo(new naver.maps.LatLng(myPos.lat, myPos.lng));
      drawMyCircle();
      applyFiltersAndRender();
    },
    ()=>toast("í˜„ì¬ ìœ„ì¹˜ë¥¼ ëª» ê°€ì ¸ì™”ì–´"),
    { enableHighAccuracy:true, timeout:8000 }
  );
}

/* ===== ë°”í…€ì‹œíŠ¸ ===== */
function showSheet(item){
  document.getElementById("sName").textContent = item.name || "";
  document.getElementById("sAddr").textContent = item.address || "";

  const descEl = document.getElementById("sDesc");
  if(item.desc && String(item.desc).trim()){
    descEl.style.display="block";
    descEl.textContent = String(item.desc);
  }else{
    descEl.style.display="none";
    descEl.textContent="";
  }

  const nickEl = document.getElementById("sNick");
  if(item.nickname && String(item.nickname).trim()){
    nickEl.style.display="block";
    nickEl.textContent = "ì œë³´: " + String(item.nickname);
  }else{
    nickEl.style.display="none";
    nickEl.textContent="";
  }

  const cats = parseList(item.category);
  const tags = parseList(item.tags);
  const pills = [];
  if(cats.length) pills.push(...cats.map(c=>`<span class="tag">${esc(c)}</span>`));
  if(tags.length) pills.push(...tags.map(t=>`<span class="tag">#${esc(t)}</span>`));
  document.getElementById("sMeta").innerHTML = pills.join("");

  document.getElementById("sheet").classList.add("show");
}
function closeSheet(){ document.getElementById("sheet").classList.remove("show"); }

/* ë„¤ì´ë²„ì§€ë„ì—ì„œ ë³´ê¸°: placeUrl ìš°ì„  */
function openNaverMap(){
  if(!selected) return;
  const placeUrl = String(selected.placeUrl||"").trim();
  if(placeUrl && /^https?:\/\//i.test(placeUrl)){
    window.open(placeUrl, "_blank");
    return;
  }
  const name = encodeURIComponent(selected.name||"");
  window.open("https://map.naver.com/v5/search/" + name, "_blank");
}

/* ëŒ“ê¸€ */
async function loadComments(restaurantId){
  const list = document.getElementById("cList");
  list.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
  try{
    const r = await fetch(API_URL + `?action=comments&restaurantId=${encodeURIComponent(restaurantId)}`);
    const json = await r.json();
    if(!json.ok){ list.textContent="ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨"; return; }
    const data = json.data || [];
    if(!data.length){
      list.innerHTML = "<div style='color:#777;font-size:13px;'>ëŒ“ê¸€ì´ ì•„ì§ ì—†ì–´ìš”</div>";
      return;
    }
    list.innerHTML = data.map(c=>`
      <div class="c-item">
        <div class="c-head">
          <div class="c-nick">${esc(c.nickname)}</div>
          <div class="c-time">${esc(c.createdAt||"")}</div>
        </div>
        <div class="c-body">${esc(c.content)}</div>
      </div>
    `).join("");
  }catch(e){
    console.error(e);
    list.textContent="ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨";
  }
}
async function addComment(){
  if(!selected) return;
  const nickname = document.getElementById("cNick").value.trim();
  const content = document.getElementById("cText").value.trim();
  if(!nickname || !content) return toast("ë‹‰ë„¤ì„/ëŒ“ê¸€ ì…ë ¥");

  try{
    const r = await fetch(API_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ action:"addcomment", data:{ restaurantId:selected.id, nickname, content } })
    });
    const json = await r.json();
    if(!json.ok) return toast("ëŒ“ê¸€ ì‹¤íŒ¨: " + (json.error||""));
    document.getElementById("cText").value = "";
    loadComments(selected.id);
  }catch(e){
    console.error(e);
    toast("ëŒ“ê¸€ ì‹¤íŒ¨(ë„¤íŠ¸ì›Œí¬)");
  }
}

/* ì œë³´ */
function goSubmit(){ location.href = SUBMIT_PAGE; }

/* start */
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", initMap);
} else {
  initMap();
}
</script>
</body>
</html>
