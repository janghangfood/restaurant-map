<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì¥í•­ì§€êµ¬ ë§›ì§‘ì§€ë„</title>

<!-- ë„¤ì´ë²„ ì§€ë„ SDK -->
<script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=g7937mmgwu"></script>

<style>
html, body { margin:0; padding:0; height:100%; font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",sans-serif; }
#map { width:100%; height:100%; }

/* ìƒë‹¨ ì˜¤ë²„ë ˆì´(ë°°ê²½ ì—†ì´ ì•„ì´ì½˜ë§Œ) */
.topbar{
  position:fixed; left:10px; right:10px; top:10px;
  display:flex; gap:8px; align-items:center; flex-wrap:wrap;
  z-index:1200;
  pointer-events:none; /* ì»¨í…Œì´ë„ˆëŠ” í´ë¦­ ë§‰ê³  */
}
.topbar .chip{
  pointer-events:auto; /* ë²„íŠ¼ë§Œ í´ë¦­ */
  width:40px; height:40px; border-radius:999px;
  background:transparent;
  display:flex; align-items:center; justify-content:center;
  font-size:20px; cursor:pointer;
  user-select:none;
  transform: translateZ(0);
}
.topbar .chip.active{
  background: rgba(255,255,255,.85);
  box-shadow:0 8px 20px rgba(0,0,0,.16);
}
.topbar .info{
  pointer-events:none;
  margin-left:auto;
  display:flex; align-items:center; gap:8px;
  font-size:12px; color:#111;
}
.pill{
  pointer-events:none;
  background:rgba(255,255,255,.85);
  box-shadow:0 8px 20px rgba(0,0,0,.12);
  border-radius:999px; padding:8px 10px;
  font-weight:800;
}

/* ìš°ì¸¡ í”Œë¡œíŒ… ë²„íŠ¼ë“¤ */
.fab-wrap{
  position:fixed; right:14px; bottom:110px;
  display:flex; flex-direction:column; gap:10px;
  z-index:1300;
}
.fab{
  width:52px; height:52px; border-radius:999px;
  border:0; cursor:pointer;
  box-shadow:0 10px 22px rgba(0,0,0,.2);
  font-size:20px; font-weight:900;
  background:#fff;
}
.fab.primary{ background:#03c75a; color:#fff; }

/* ë°”í…€ì‹œíŠ¸ */
.sheet {
  position: fixed; left:0; right:0; bottom:0;
  background:#fff;
  border-radius:16px 16px 0 0;
  box-shadow:0 -6px 20px rgba(0,0,0,.2);
  padding:16px;
  display:none;
  z-index:1400;
  max-height:72vh;
  overflow:auto;
}
.sheet.show { display:block; }
.close-btn{
  position:absolute; top:14px; right:16px;
  font-size:22px; color:#999; cursor:pointer;
}
.title { font-weight:900; font-size:16px; padding-right:30px; }
.addr { font-size:13px; color:#555; margin-top:4px; }
.desc { margin-top:10px; font-size:13px; color:#222; line-height:1.35; }
.nick { margin-top:6px; font-size:12px; color:#666; }

.meta { margin-top:8px; display:flex; gap:6px; flex-wrap:wrap; }
.meta .tag{
  font-size:12px; padding:4px 8px; border-radius:999px; background:#f2f2f2;
}

.btn {
  margin-top:12px;
  padding:12px;
  background:#03c75a;
  color:#fff;
  text-align:center;
  border-radius:12px;
  font-weight:900;
  cursor:pointer;
}

/* ëŒ“ê¸€ */
.comments { margin-top:12px; border-top:1px solid #eee; padding-top:12px; }
.c-item{ padding:8px 0; border-bottom:1px solid #f0f0f0; }
.c-head{ display:flex; justify-content:space-between; gap:10px; }
.c-nick{ font-weight:900; font-size:12px; color:#111; }
.c-time{ font-size:11px; color:#777; }
.c-body{ margin-top:4px; font-size:13px; color:#222; line-height:1.35; }
.c-form{ display:flex; gap:8px; margin-top:10px; }
.c-form input{
  flex:1; border:1px solid #ddd; border-radius:12px; padding:10px; font-size:13px;
}
.c-form button{
  border:0; border-radius:12px; padding:10px 12px;
  background:#111; color:#fff; font-weight:900;
}
.toast{
  position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
  background:#111; color:#fff; padding:10px 14px; border-radius:12px;
  font-size:13px; display:none; z-index:2000;
}
.toast.show{display:block;}
</style>
</head>

<body>
<div id="map"></div>

<!-- ìƒë‹¨ ì¹´í…Œê³ ë¦¬ ì•„ì´ì½˜(ë°°ê²½ ìµœì†Œ) + 500m í‘œì‹œ -->
<div class="topbar" id="topbar">
  <div id="catChips" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
  <div class="info">
    <div class="pill" id="nearInfo">ë‚´ ì£¼ë³€ 500m: -</div>
  </div>
</div>

<!-- ìš°ì¸¡ ë²„íŠ¼ -->
<div class="fab-wrap">
  <button class="fab" title="í˜„ì¬ ìœ„ì¹˜" onclick="moveToMe()">ğŸ“</button>
  <button class="fab primary" title="ì œë³´í•˜ê¸°" onclick="goSubmit()">ï¼‹</button>
</div>

<!-- ë°”í…€ì‹œíŠ¸ -->
<div id="sheet" class="sheet">
  <span class="close-btn" onclick="closeSheet()">Ã—</span>
  <div class="title" id="sName"></div>
  <div class="addr" id="sAddr"></div>
  <div class="desc" id="sDesc" style="display:none;"></div>
  <div class="nick" id="sNick" style="display:none;"></div>
  <div class="meta" id="sMeta"></div>
  <div class="btn" onclick="openNaverMap()">ë„¤ì´ë²„ì§€ë„ì—ì„œ ë³´ê¸°</div>

  <div class="comments">
    <div style="font-weight:900;margin-bottom:6px;">ëŒ“ê¸€</div>
    <div id="cList" style="color:#777;font-size:13px;">ê°€ê²Œë¥¼ ì„ íƒí•˜ë©´ ëŒ“ê¸€ì´ ë³´ì—¬ìš”</div>
    <div class="c-form">
      <input id="cNick" placeholder="ë‹‰ë„¤ì„" maxlength="20" />
      <input id="cText" placeholder="ëŒ“ê¸€ ë‚´ìš©" maxlength="120" />
      <button onclick="addComment()">ë“±ë¡</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/******** ì„¤ì • ********/
const API_URL = "https://twilight-art-ed3c.wlalsqqq.workers.dev";
const SUBMIT_PAGE = "./submit.html"; // ì œë³´ í˜ì´ì§€ íŒŒì¼ëª…
const RADIUS_M = 500;
/************************/

let map = null;
let selected = null;

let allRestaurants = []; // ì›ë³¸
let filteredRestaurants = []; // í•„í„° ê²°ê³¼
const markerObjs = []; // {marker,item}

let watchId = null;
let myPos = null;
let myCircle = null;

const CATEGORY_MASTER = [
  { key:"ì „ì²´", emoji:"âœ¨" },
  { key:"í•œì‹", emoji:"ğŸš" },
  { key:"ì¤‘ì‹", emoji:"ğŸ¥Ÿ" },
  { key:"ì¼ì‹", emoji:"ğŸ£" },
  { key:"ì–‘ì‹", emoji:"ğŸ" },
  { key:"ì¹´í˜", emoji:"â˜•" },
  { key:"ë¶„ì‹", emoji:"ğŸ¢" },
  { key:"ê³ ê¸°", emoji:"ğŸ¥©" },
  { key:"ì¹˜í‚¨", emoji:"ğŸ—" },
  { key:"í”¼ì", emoji:"ğŸ•" },
  { key:"ë””ì €íŠ¸", emoji:"ğŸ°" },
  { key:"ë°°ë‹¬", emoji:"ğŸ›µ" }
];

let selectedCats = new Set(); // ë³µìˆ˜ ì„ íƒ
// "ì „ì²´"ëŠ” íŠ¹ë³„ ì²˜ë¦¬

function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 2500);
}

function esc(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

function parseList(str){
  return String(str||"").split(",").map(s=>s.trim()).filter(Boolean);
}

// ëŒ€í‘œ ì´ëª¨ì§€ 1ê°œë§Œ
const CAT_EMOJI = {
  "í•œì‹":"ğŸš","ì¤‘ì‹":"ğŸ¥Ÿ","ì¼ì‹":"ğŸ£","ì–‘ì‹":"ğŸ","ì¹´í˜":"â˜•","ë¶„ì‹":"ğŸ¢","ê³ ê¸°":"ğŸ¥©",
  "ì¹˜í‚¨":"ğŸ—","í”¼ì":"ğŸ•","ë””ì €íŠ¸":"ğŸ°","ë°°ë‹¬":"ğŸ›µ","ê¸°íƒ€":"ğŸ“"
};

function pickEmoji(item){
  const cats = parseList(item.category);
  for(const c of cats){
    if(CAT_EMOJI[c]) return CAT_EMOJI[c];
  }
  return CAT_EMOJI["ê¸°íƒ€"];
}

// ì¤Œ 14 ì´í•˜ ë¼ë²¨ ìˆ¨ê¹€
function markerHtml(item, showLabel){
  const emoji = pickEmoji(item);
  return `
    <div style="transform: translate(-50%, -100%); display:flex; flex-direction:column; align-items:center; gap:6px;">
      <div style="
        width:36px;height:36px;border-radius:18px;background:#fff;
        display:flex;align-items:center;justify-content:center;font-size:20px;
        box-shadow:0 8px 20px rgba(0,0,0,.22);
        border:1px solid rgba(0,0,0,.06);
      ">${emoji}</div>
      ${showLabel ? `
        <div style="
          max-width:220px;background:#fff;padding:6px 10px;border-radius:999px;
          font-size:12px;font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
          box-shadow:0 8px 20px rgba(0,0,0,.18);border:1px solid rgba(0,0,0,.06);
        ">${esc(item.name)}</div>
      ` : ``}
    </div>
  `;
}

function initUI(){
  const wrap = document.getElementById("catChips");
  wrap.innerHTML = "";

  CATEGORY_MASTER.forEach(c=>{
    const el = document.createElement("div");
    el.className = "chip";
    el.textContent = c.emoji;
    el.title = c.key;
    el.onclick = () => toggleCategory(c.key, el);
    wrap.appendChild(el);

    // ê¸°ë³¸: ì „ì²´ ì„ íƒ
    if(c.key === "ì „ì²´"){
      el.classList.add("active");
    }
  });
}

function toggleCategory(cat, el){
  // ì „ì²´ í´ë¦­ ì‹œ ì´ˆê¸°í™”
  if(cat === "ì „ì²´"){
    selectedCats.clear();
    document.querySelectorAll(".topbar .chip").forEach(x=>x.classList.remove("active"));
    el.classList.add("active");
    applyFiltersAndRender();
    return;
  }

  // ì „ì²´ ë²„íŠ¼ ë¹„í™œì„±
  const allChip = [...document.querySelectorAll(".topbar .chip")].find(x=>x.title==="ì „ì²´");
  if(allChip) allChip.classList.remove("active");

  if(selectedCats.has(cat)){
    selectedCats.delete(cat);
    el.classList.remove("active");
  }else{
    selectedCats.add(cat);
    el.classList.add("active");
  }

  // ì•„ë¬´ ê²ƒë„ ì„ íƒ ì•ˆë˜ë©´ ì „ì²´ë¡œ
  if(selectedCats.size === 0){
    if(allChip) allChip.classList.add("active");
  }

  applyFiltersAndRender();
}

function applyFiltersAndRender(){
  // 1) ì¹´í…Œê³ ë¦¬ í•„í„°
  if(selectedCats.size === 0){
    filteredRestaurants = allRestaurants.slice();
  }else{
    filteredRestaurants = allRestaurants.filter(item=>{
      const cats = new Set(parseList(item.category));
      for(const c of selectedCats){
        if(cats.has(c)) return true;
      }
      return false;
    });
  }

  // 2) ë‚´ ì£¼ë³€ 500m í‘œì‹œ/ì¹´ìš´íŠ¸
  updateNearCount();

  // 3) ë§ˆì»¤ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
  renderMarkers();
}

async function initMap(){
  if(!window.naver || !naver.maps){
    setTimeout(initMap, 100);
    return;
  }

  map = new naver.maps.Map("map", {
    center: new naver.maps.LatLng(37.661, 126.764),
    zoom: 15
  });

  naver.maps.Event.addListener(map, "click", () => closeSheet());

  naver.maps.Event.addListener(map, "zoom_changed", () => {
    // ì¤Œ ë³€ê²½ ì‹œ ë¼ë²¨ë§Œ ì—…ë°ì´íŠ¸ (ë§ˆì»¤ ì¬ìƒì„± X)
    const showLabel = map.getZoom() > 14;
    markerObjs.forEach(o=>{
      o.marker.setIcon({
        content: markerHtml(o.item, showLabel),
        anchor: new naver.maps.Point(0,0)
      });
    });
  });

  initUI();
  await loadRestaurants();
  startWatchLocation(); // 500m ìë™ê°±ì‹ 
}

async function loadRestaurants(){
  try{
    const r = await fetch(API_URL + "?action=list");
    const json = await r.json();
    if(!json.ok){
      console.error(json);
      toast("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");
      return;
    }
    allRestaurants = json.data || [];
    applyFiltersAndRender();
  }catch(e){
    console.error(e);
    toast("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨(ë„¤íŠ¸ì›Œí¬)");
  }
}

function renderMarkers(){
  // ê¸°ì¡´ ì œê±°
  markerObjs.forEach(o=>o.marker.setMap(null));
  markerObjs.length = 0;

  const showLabel = map.getZoom() > 14;

  filteredRestaurants.forEach(item=>{
    const marker = new naver.maps.Marker({
      position: new naver.maps.LatLng(item.lat, item.lng),
      map,
      icon:{
        content: markerHtml(item, showLabel),
        anchor: new naver.maps.Point(0,0)
      }
    });

    naver.maps.Event.addListener(marker, "click", () => {
      selected = item;
      showSheet(item);
      loadComments(item.id);
    });

    markerObjs.push({marker, item});
  });
}

/* ========= 500m / ìœ„ì¹˜ ìë™ê°±ì‹  ========= */
function startWatchLocation(){
  if(!navigator.geolocation){
    toast("ì´ ê¸°ê¸°ëŠ” ìœ„ì¹˜ë¥¼ ì§€ì›í•˜ì§€ ì•Šì•„ìš”");
    return;
  }

  // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ ì¤‘ë³µ ë°©ì§€
  if(watchId !== null) return;

  watchId = navigator.geolocation.watchPosition(
    (pos)=>{
      myPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      drawMyCircle();
      updateNearCount();
    },
    (err)=>{
      console.warn("ìœ„ì¹˜ ì˜¤ë¥˜:", err);
      // ì²˜ìŒ ì§„ì…ì‹œ ì˜¤ë¥˜ í† ìŠ¤íŠ¸ëŠ” ê³¼í•˜ê²Œ ë„ìš°ì§€ ì•ŠìŒ
    },
    { enableHighAccuracy:true, maximumAge:2000, timeout:8000 }
  );
}

function drawMyCircle(){
  if(!map || !myPos) return;

  const center = new naver.maps.LatLng(myPos.lat, myPos.lng);

  if(!myCircle){
    myCircle = new naver.maps.Circle({
      map,
      center,
      radius: RADIUS_M,
      fillOpacity: 0.08,
      strokeOpacity: 0.25,
      strokeWeight: 2
    });
  }else{
    myCircle.setCenter(center);
  }
}

function haversineM(a, b){
  const R = 6371000;
  const toRad = (d)=>d*Math.PI/180;
  const dLat = toRad(b.lat-a.lat);
  const dLng = toRad(b.lng-a.lng);
  const s1 = Math.sin(dLat/2);
  const s2 = Math.sin(dLng/2);
  const q = s1*s1 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
  return 2*R*Math.asin(Math.min(1, Math.sqrt(q)));
}

function updateNearCount(){
  const el = document.getElementById("nearInfo");
  if(!myPos){
    el.textContent = "ë‚´ ì£¼ë³€ 500m: -";
    return;
  }
  const cnt = filteredRestaurants.filter(r=>{
    const d = haversineM(myPos, {lat:r.lat, lng:r.lng});
    return d <= RADIUS_M;
  }).length;
  el.textContent = `ë‚´ ì£¼ë³€ 500m: ${cnt}ê³³`;
}

function moveToMe(){
  if(!navigator.geolocation){
    toast("ì´ ê¸°ê¸°ëŠ” ìœ„ì¹˜ë¥¼ ì§€ì›í•˜ì§€ ì•Šì•„ìš”");
    return;
  }
  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      myPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      const center = new naver.maps.LatLng(myPos.lat, myPos.lng);
      map.panTo(center);
      drawMyCircle();
      updateNearCount();
    },
    (err)=>{
      console.warn(err);
      toast("í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆì–´ìš”");
    },
    { enableHighAccuracy:true, timeout:8000 }
  );
}

/* ========= ë°”í…€ì‹œíŠ¸ ========= */
function showSheet(item){
  document.getElementById("sName").textContent = item.name || "";
  document.getElementById("sAddr").textContent = item.address || "";

  const descEl = document.getElementById("sDesc");
  if(item.desc && String(item.desc).trim()){
    descEl.style.display="block";
    descEl.textContent = String(item.desc);
  }else{
    descEl.style.display="none";
    descEl.textContent="";
  }

  const nickEl = document.getElementById("sNick");
  if(item.nickname && String(item.nickname).trim()){
    nickEl.style.display="block";
    nickEl.textContent = "ì œë³´: " + String(item.nickname);
  }else{
    nickEl.style.display="none";
    nickEl.textContent="";
  }

  const cats = parseList(item.category);
  const tags = parseList(item.tags);
  const pills = [];
  if(cats.length) pills.push(...cats.map(c=>`<span class="tag">${esc(c)}</span>`));
  if(tags.length) pills.push(...tags.map(t=>`<span class="tag">#${esc(t)}</span>`));
  document.getElementById("sMeta").innerHTML = pills.join("");

  document.getElementById("sheet").classList.add("show");
}

function closeSheet(){
  document.getElementById("sheet").classList.remove("show");
}

/* ========= ë„¤ì´ë²„ì§€ë„ì—ì„œ ë³´ê¸° (placeUrl ìš°ì„ ) ========= */
function openNaverMap(){
  if(!selected) return;

  const placeUrl = String(selected.placeUrl||"").trim();
  if(placeUrl && /^https?:\/\//i.test(placeUrl)){
    window.open(placeUrl, "_blank");
    return;
  }

  // fallback (ê²€ìƒ‰)
  const name = encodeURIComponent(selected.name || "");
  window.open("https://map.naver.com/v5/search/" + name, "_blank");
}

/* ========= ëŒ“ê¸€ ========= */
async function loadComments(restaurantId){
  const list = document.getElementById("cList");
  list.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

  try{
    const r = await fetch(API_URL + `?action=comments&restaurantId=${encodeURIComponent(restaurantId)}`);
    const json = await r.json();
    if(!json.ok){
      list.textContent = "ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨";
      return;
    }
    const data = json.data || [];
    if(!data.length){
      list.innerHTML = "<div style='color:#777;font-size:13px;'>ëŒ“ê¸€ì´ ì•„ì§ ì—†ì–´ìš”</div>";
      return;
    }
    list.innerHTML = data.map(c=>`
      <div class="c-item">
        <div class="c-head">
          <div class="c-nick">${esc(c.nickname)}</div>
          <div class="c-time">${esc(c.createdAt || "")}</div>
        </div>
        <div class="c-body">${esc(c.content)}</div>
      </div>
    `).join("");
  }catch(e){
    console.error(e);
    list.textContent = "ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨";
  }
}

async function addComment(){
  if(!selected) return;

  const nickname = document.getElementById("cNick").value.trim();
  const content = document.getElementById("cText").value.trim();
  if(!nickname || !content) return toast("ë‹‰ë„¤ì„/ëŒ“ê¸€ì„ ì…ë ¥í•´ì¤˜");

  try{
    const r = await fetch(API_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        action:"addcomment",
        data:{ restaurantId:selected.id, nickname, content }
      })
    });
    const json = await r.json();
    if(!json.ok) return toast("ëŒ“ê¸€ ì‹¤íŒ¨: " + (json.error||""));
    document.getElementById("cText").value = "";
    loadComments(selected.id);
  }catch(e){
    console.error(e);
    toast("ëŒ“ê¸€ ì‹¤íŒ¨(ë„¤íŠ¸ì›Œí¬)");
  }
}

/* ========= ì œë³´ í˜ì´ì§€ ========= */
function goSubmit(){
  location.href = SUBMIT_PAGE;
}

/* start */
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", initMap);
} else {
  initMap();
}
</script>
</body>
</html>
