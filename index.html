<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì¥í•­ì§€êµ¬ ë§›ì§‘ì§€ë„</title>

<link rel="icon" href="data:,">

<!-- âœ… ë„¤ì´ë²„ ì§€ë„ SDK -->
<script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=g7937mmgwu"></script>

<style>
html, body { margin:0; padding:0; height:100%; font-family:-apple-system, BlinkMacSystemFont, 'Noto Sans KR'; }
#map { width:100%; height:100%; position:relative; z-index:1; }

/* âœ… ìƒë‹¨ UI */
.topUI{
  position:fixed;
  left:12px; right:12px; top:12px;
  z-index:9999;
  display:flex;
  flex-direction:column;
  gap:10px;
  pointer-events:none;
}
.topRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.brand{
  font-weight:900;
  font-size:16px;
  color:#111;
  text-shadow: 0 2px 10px rgba(255,255,255,.9);
}
.status{
  font-size:12px;
  color:#222;
  text-shadow: 0 2px 10px rgba(255,255,255,.9);
}
.controls{
  display:flex;
  align-items:center;
  gap:8px;
  pointer-events:auto;
}
.toggleBtn{
  display:flex;
  align-items:center;
  gap:6px;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid rgba(0,0,0,.08);
  background: rgba(255,255,255,.78);
  box-shadow:0 8px 20px rgba(0,0,0,.12);
  font-weight:900;
  font-size:12px;
  cursor:pointer;
  user-select:none;
}
.toggleDot{
  width:10px; height:10px; border-radius:999px;
  background:#bbb;
}
.toggleBtn.on .toggleDot{ background:#03c75a; }
.toggleBtn.on{ border-color: rgba(3,199,90,.35); }

.chipBar{
  display:flex;
  gap:8px;
  flex-wrap:nowrap;
  overflow:auto;
  -webkit-overflow-scrolling: touch;
  padding-bottom:2px;
  pointer-events:auto;
}
.chipBar::-webkit-scrollbar{ display:none; }

.chip{
  flex:0 0 auto;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid rgba(0,0,0,.08);
  background: rgba(255,255,255,.78);
  box-shadow:0 8px 20px rgba(0,0,0,.12);
  font-weight:900;
  font-size:12px;
  cursor:pointer;
  user-select:none;
  white-space:nowrap;
}
.chip.on{
  background: rgba(3,199,90,.92);
  border-color: rgba(3,199,90,.40);
  color:#fff;
}

/* âœ… ì˜¤ë¥¸ìª½ ì•„ë˜ ë²„íŠ¼ë“¤ */
.fab{
  position:fixed;
  right:16px;
  bottom:18px;
  z-index:9999;
  width:56px; height:56px;
  border-radius:999px;
  background:#03c75a;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  font-size:14px;
  border:0;
  box-shadow:0 12px 26px rgba(0,0,0,.22);
  cursor:pointer;
}
.fab:active{ transform: translateY(1px); }

.locBtn{
  position:fixed;
  right:16px;
  bottom:86px;
  z-index:9999;
  width:44px; height:44px;
  border-radius:999px;
  background: rgba(255,255,255,.92);
  border:1px solid rgba(0,0,0,.10);
  box-shadow:0 10px 22px rgba(0,0,0,.18);
  cursor:pointer;
  font-weight:900;
  font-size:18px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.locBtn:active{ transform: translateY(1px); }

/* âœ… ë°”í…€ì‹œíŠ¸ */
.sheet{
  position:fixed;
  left:0; right:0; bottom:0;
  background:#fff;
  border-radius:16px 16px 0 0;
  box-shadow:0 -6px 20px rgba(0,0,0,.2);
  padding:16px;
  display:none;
  z-index:9998;
  max-height:72vh;
  overflow:auto;
}
.sheet.show{ display:block; }

/* âœ… ë‹«ê¸° ë²„íŠ¼: ìŠ¤í¬ë¡¤í•´ë„ í•­ìƒ ë³´ì´ê²Œ */
.close-btn{
  position: sticky;
  top: 0;
  margin-left:auto;
  width:28px; height:28px;
  border-radius:999px;
  border:1px solid rgba(0,0,0,.08);
  background:#fff;
  cursor:pointer;
  font-size:18px; color:#777;
  display:flex; align-items:center; justify-content:center;
  z-index:10;
}

.sheetTitle{ font-weight:900; font-size:16px; padding-right:40px; margin-top:-28px; }
.addr{ font-size:13px; color:#555; margin-top:4px; }
.desc{ font-size:13px; color:#222; margin-top:10px; line-height:1.35; }
.meta{ margin-top:10px; display:flex; gap:6px; flex-wrap:wrap; }
.pill{ font-size:12px; padding:4px 8px; border-radius:999px; background:#f2f2f2; }

.btn{
  margin-top:12px;
  padding:12px;
  background:#03c75a;
  color:#fff;
  text-align:center;
  border-radius:12px;
  font-weight:900;
  cursor:pointer;
  border:0;
  width:100%;
}
.btn.secondary{ background:#111; margin-top:10px; }

/* ëŒ“ê¸€ */
.cmtBox{ margin-top:14px; }
.cmtHeader{ font-weight:900; margin-bottom:8px; }
.cmtList{ display:flex; flex-direction:column; gap:10px; }
.cmtItem{
  border:1px solid rgba(0,0,0,.07);
  border-radius:12px;
  padding:10px;
  background:#fff;
}
.cmtTop{ display:flex; justify-content:space-between; gap:10px; }
.cmtNick{ font-weight:900; font-size:13px; }
.cmtTime{ font-size:11px; color:#777; white-space:nowrap; }
.cmtContent{ margin-top:6px; font-size:13px; line-height:1.35; }

.formRow{ display:flex; gap:8px; margin-top:10px; }
.input{
  flex:1;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid rgba(0,0,0,.12);
  font-size:13px;
}
textarea.input{ min-height:76px; resize:none; }
.mini{ font-size:12px; color:#777; margin-top:8px; }
</style>
</head>

<body>
<div id="map"></div>

<!-- âœ… ìƒë‹¨ UI -->
<div class="topUI">
  <div class="topRow">
    <div>
      <div class="brand">ì¥í•­ì§€êµ¬ ë§›ì§‘ì§€ë„</div>
      <div class="status" id="statusText">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
    </div>
    <div class="controls">
      <div id="nearBtn" class="toggleBtn" title="ë‚´ì£¼ë³€ 500m">
        <span class="toggleDot"></span>
        <span>ë‚´ì£¼ë³€ 500m</span>
      </div>

      <!-- âœ… 500m ì˜†: ì¸ì¦ í† ê¸€(ğŸ‘‘) -->
      <div id="verifiedBtn" class="toggleBtn" title="ì¸ì¦ë§›ì§‘ë§Œ ë³´ê¸°">
        <span class="toggleDot"></span>
        <span>ğŸ‘‘ ë§›ì§‘ì¸ì¦</span>
      </div>
    </div>
  </div>

  <div class="chipBar" id="chips"></div>
</div>

<!-- âœ… í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ -->
<button class="locBtn" id="btnMyLoc" type="button" title="í˜„ì¬ ìœ„ì¹˜ë¡œ">â¦¿</button>

<!-- âœ… ì œë³´ ë²„íŠ¼ -->
<button class="fab" id="fabReport" type="button">ì œë³´</button>

<!-- âœ… ë°”í…€ì‹œíŠ¸ -->
<div id="sheet" class="sheet">
  <button class="close-btn" id="btnCloseSheet" type="button">Ã—</button>
  <div class="sheetTitle" id="sName"></div>
  <div class="addr" id="sAddr"></div>
  <div class="desc" id="sDesc" style="display:none;"></div>
  <div class="meta" id="sMeta"></div>

  <button class="btn" id="btnOpenNaver" type="button">ë„¤ì´ë²„ì§€ë„ì—ì„œ ë³´ê¸°</button>

  <div class="cmtBox">
    <div class="cmtHeader">ëŒ“ê¸€</div>
    <div class="cmtList" id="cmtList"></div>
    <div class="mini" id="cmtStatus"></div>

    <div class="formRow">
      <input class="input" id="nickInput" placeholder="ë‹‰ë„¤ì„" maxlength="20" />
    </div>
    <div class="formRow">
      <textarea class="input" id="contentInput" placeholder="ëŒ“ê¸€ì„ ë‚¨ê²¨ì£¼ì„¸ìš”" maxlength="300"></textarea>
    </div>
    <button class="btn secondary" id="btnAddComment" type="button">ëŒ“ê¸€ ë‹¬ê¸°</button>
  </div>
</div>

<script>
/******** ì„¤ì • ********/
const API_URL = "https://twilight-art-ed3c.wlalsqqq.workers.dev";
const REPORT_URL = "./submit.html";
/************************/

let map = null;
let selected = null;

const statusTextEl = document.getElementById("statusText");
const chipsEl = document.getElementById("chips");

const cmtListEl = document.getElementById("cmtList");
const cmtStatusEl = document.getElementById("cmtStatus");
const nickInputEl = document.getElementById("nickInput");
const contentInputEl = document.getElementById("contentInput");

const nearBtnEl = document.getElementById("nearBtn");
const verifiedBtnEl = document.getElementById("verifiedBtn");

/* âœ… ê¸°ë³¸ê°’: ì¥í•­ì§€êµ¬ ê³ ì • (500m OFF) */
let useNear = false;
nearBtnEl.classList.toggle("on", useNear);

/* âœ… ì¸ì¦ í† ê¸€ */
let onlyVerified = false;
verifiedBtnEl.classList.toggle("on", onlyVerified);

const markers = []; // { marker, item }
let allData = [];
let userPos = null; // {lat, lng}

let myMarker = null;
let myCircle = null;

/* âœ… ìœ„ì¹˜ ê°ì‹œë¥¼ â€œ500m ì¼¤ ë•Œë§Œâ€ ì‹œì‘ */
let watching = false;

/* =========================
   ì¹´í…Œê³ ë¦¬ â†’ ëŒ€í‘œ ì´ëª¨ì§€ 1ê°œ
========================= */
const CATEGORY_PRIORITY = [
  "ì¹´í˜","ë””ì €íŠ¸","ë¸ŒëŸ°ì¹˜","ë² ì´ì»¤ë¦¬",
  "í•œì‹","êµ­ë°¥","ê³ ê¸°","í•´ì‚°ë¬¼","ë©´",
  "ì¤‘ì‹","ì¼ì‹","ì´ˆë°¥","ìŠ¤ì‹œ","ëˆê¹ŒìŠ¤","ì–‘ì‹","ì•„ì‹œì•„",
  "ë¶„ì‹","ì¹˜í‚¨","í”¼ì","í–„ë²„ê±°","ìƒëŸ¬ë“œ","ìˆ ì§‘",
  "ë°°ë‹¬"
];
const CAT_EMOJI = {
  "ì¹´í˜":"â˜•","ë””ì €íŠ¸":"ğŸ°","ë¸ŒëŸ°ì¹˜":"ğŸ¥","ë² ì´ì»¤ë¦¬":"ğŸ¥–",
  "í•œì‹":"ğŸš","êµ­ë°¥":"ğŸ¥˜","ê³ ê¸°":"ğŸ¥©","í•´ì‚°ë¬¼":"ğŸ¦","ë©´":"ğŸœ",
  "ì¤‘ì‹":"ğŸ¥Ÿ","ì¼ì‹":"ğŸ£","ì´ˆë°¥":"ğŸ£","ìŠ¤ì‹œ":"ğŸ£","ëˆê¹ŒìŠ¤":"ğŸ–","ì–‘ì‹":"ğŸ","ì•„ì‹œì•„":"ğŸ›",
  "ë¶„ì‹":"ğŸ¢","ì¹˜í‚¨":"ğŸ—","í”¼ì":"ğŸ•","í–„ë²„ê±°":"ğŸ”","ìƒëŸ¬ë“œ":"ğŸ¥—","ìˆ ì§‘":"ğŸº",
  "ë°°ë‹¬":"ğŸ›µ","ê¸°íƒ€":"ğŸ“"
};
function parseCats(str){ return String(str||"").split(",").map(s=>s.trim()).filter(Boolean); }
function pickMainCategory(categoryStr){
  const cats = parseCats(categoryStr);
  for (const p of CATEGORY_PRIORITY) if (cats.includes(p)) return p;
  return cats[0] || "ê¸°íƒ€";
}
function emojiOf(cat){ return CAT_EMOJI[cat] || "ğŸ“"; }
function esc(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================
   âœ… ì¸ì¦ íŒë‹¨: tier ê¸°ë°˜
========================= */
function isVerifiedItem(item){
  const t = String(item.tier || "").toLowerCase().trim();
  return (
    t === "verified" ||
    t === "certified" ||
    t === "vip" ||
    t === "ì¸ì¦" ||
    t === "ì¸ì¦ë§›ì§‘" ||
    t === "ì¸ì¦ë¨" ||
    t === "ì™•ê´€" ||
    t === "crown" ||
    t === "1" ||
    t === "tier1" ||
    t === "tier 1"
  );
}

/* =========================
   âœ… ë§ˆì»¤ í”ë“¤ë¦¼ ë°©ì§€(í•µì‹¬)
   - ê³ ì • í¬ê¸° ì»¨í…Œì´ë„ˆ
   - CSS translate ì œê±°
   - anchorë¥¼ bottom-centerë¡œ ê³ ì •
========================= */
const ICON_W = 110, ICON_H = 110;
function iconSize(){ return new naver.maps.Size(ICON_W, ICON_H); }
function iconAnchor(){ return new naver.maps.Point(Math.floor(ICON_W/2), ICON_H); }

function markerHtml(item, showLabel){
  const main = pickMainCategory(item.category);
  const emoji = emojiOf(main);
  const crown = isVerifiedItem(item) ? "ğŸ‘‘" : "";

  /* ë¼ë²¨ì€ show/hide í•´ë„ â€œê³µê°„ì€ ìœ ì§€â€í•´ì„œ ì•µì»¤ í”ë“¤ë¦¼ ì—†ìŒ */
  const labelStyle = showLabel
    ? "opacity:1;"
    : "opacity:0; pointer-events:none;";

  return `
    <div style="
      width:${ICON_W}px; height:${ICON_H}px;
      display:flex; flex-direction:column; align-items:center; justify-content:flex-end;
      position:relative;
      font-family:-apple-system,BlinkMacSystemFont,'Noto Sans KR',sans-serif;
    ">
      <div style="position:relative; width:38px; height:38px; border-radius:19px;
        background:#fff; display:flex; align-items:center; justify-content:center;
        font-size:22px; box-shadow:0 8px 20px rgba(0,0,0,.22);
        border:1px solid rgba(0,0,0,.06);
      ">
        ${emoji}
        ${crown ? `
          <div style="
            position:absolute; right:-10px; top:-10px;
            width:22px; height:22px; border-radius:999px;
            background:#fff; display:flex; align-items:center; justify-content:center;
            font-size:14px;
            box-shadow:0 6px 16px rgba(0,0,0,.18);
            border:1px solid rgba(0,0,0,.06);
          ">${crown}</div>
        ` : ""}
      </div>

      <div style="
        margin-top:6px;
        max-width:200px; background:#fff; padding:6px 10px; border-radius:999px;
        font-size:12px; font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
        box-shadow:0 8px 20px rgba(0,0,0,.18); border:1px solid rgba(0,0,0,.06);
        ${labelStyle}
      ">${esc(item.name)}</div>
    </div>
  `;
}

/* =========================
   ê±°ë¦¬ ê³„ì‚° (500m)
========================= */
function distMeters(lat1, lng1, lat2, lng2){
  const R = 6371000;
  const toRad = d => d * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLng = toRad(lng2 - lng1);
  const a =
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
    Math.sin(dLng/2) * Math.sin(dLng/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}
function within500m(item){
  if (!userPos) return false;
  const d = distMeters(userPos.lat, userPos.lng, Number(item.lat), Number(item.lng));
  return d <= 500;
}

/* =========================
   ì¹´í…Œê³ ë¦¬ ì¹©(ë‹¤ì¤‘ ì„ íƒ)
========================= */
const selectedCats = new Set();

function setAllSelected(){
  selectedCats.clear();
  renderChipsState();
  applyFiltersAndRender();
}
function buildChipsFromData(data){
  const set = new Set();
  data.forEach(it => parseCats(it.category).forEach(c => set.add(c)));
  const cats = Array.from(set);

  cats.sort((a,b)=>{
    const ia = CATEGORY_PRIORITY.indexOf(a);
    const ib = CATEGORY_PRIORITY.indexOf(b);
    if (ia === -1 && ib === -1) return a.localeCompare(b, "ko");
    if (ia === -1) return 1;
    if (ib === -1) return -1;
    return ia - ib;
  });

  chipsEl.innerHTML = "";

  const all = document.createElement("div");
  all.className = "chip on";
  all.dataset.cat = "__ALL__";
  all.textContent = "âœ¨ ì „ì²´";
  all.onclick = () => setAllSelected();
  chipsEl.appendChild(all);

  cats.forEach(cat=>{
    const el = document.createElement("div");
    el.className = "chip";
    el.dataset.cat = cat;
    el.textContent = `${emojiOf(cat)} ${cat}`;
    el.onclick = () => {
      if (selectedCats.has(cat)) selectedCats.delete(cat);
      else selectedCats.add(cat);

      if (selectedCats.size === 0) setAllSelected();
      else { renderChipsState(); applyFiltersAndRender(); }
    };
    chipsEl.appendChild(el);
  });

  renderChipsState();
}
function renderChipsState(){
  const isAll = selectedCats.size === 0;
  chipsEl.querySelectorAll(".chip").forEach(ch=>{
    const cat = ch.dataset.cat;
    if (cat === "__ALL__") ch.classList.toggle("on", isAll);
    else ch.classList.toggle("on", selectedCats.has(cat));
  });
}
function matchCategory(item){
  if (selectedCats.size === 0) return true;
  const cats = parseCats(item.category);
  return cats.some(c => selectedCats.has(c));
}

/* =========================
   UI ì´ë²¤íŠ¸
========================= */
nearBtnEl.addEventListener("click", ()=>{
  useNear = !useNear;
  nearBtnEl.classList.toggle("on", useNear);

  if (useNear) startWatchLocation();  // âœ… 500m ON í•  ë•Œë§Œ ìœ„ì¹˜ ì‹œì‘
  else {
    // 500m OFFë©´ ì›/ë‚´ë§ˆì»¤ ìˆ¨ê¹€(ìœ„ì¹˜ ìì²´ëŠ” ìœ ì§€í•´ë„ ë˜ì§€ë§Œ UIëŠ” ë”)
    if (myCircle) myCircle.setMap(null), myCircle = null;
    if (myMarker) myMarker.setMap(null), myMarker = null;
  }

  applyFiltersAndRender();
});

verifiedBtnEl.addEventListener("click", ()=>{
  onlyVerified = !onlyVerified;
  verifiedBtnEl.classList.toggle("on", onlyVerified);
  applyFiltersAndRender();
});

document.getElementById("fabReport").addEventListener("click", ()=>{
  window.location.href = REPORT_URL;
});

document.getElementById("btnMyLoc").addEventListener("click", ()=>{
  if (!map) return;

  // í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ì€ "ìš”ì²­"ì´ë‹ˆê¹Œ ì—¬ê¸°ì„œëŠ” ìœ„ì¹˜ ê¶Œí•œ ìš”ì²­í•´ë„ OK
  if (!userPos) startWatchLocation(true);

  if (!userPos){
    alert("í˜„ì¬ ìœ„ì¹˜ë¥¼ ì•„ì§ ëª» ì°¾ì•˜ì–´ìš”. ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì¤˜!");
    return;
  }
  map.panTo(new naver.maps.LatLng(userPos.lat, userPos.lng));
  if (map.getZoom() < 16) map.setZoom(16, true);
});

/* ë°”í…€ì‹œíŠ¸ ë²„íŠ¼ë“¤ */
document.getElementById("btnCloseSheet").addEventListener("click", closeSheet);
document.getElementById("btnOpenNaver").addEventListener("click", openNaverMap);
document.getElementById("btnAddComment").addEventListener("click", addCommentFromUI);

/* =========================
   ì§€ë„ ì´ˆê¸°í™”
========================= */
function initMap(){
  if (!naver?.maps) {
    console.error("ë„¤ì´ë²„ ì§€ë„ SDK ë¡œë“œ ì‹¤íŒ¨");
    setTimeout(initMap, 100);
    return;
  }

  map = new naver.maps.Map("map", {
    center: new naver.maps.LatLng(37.661, 126.764),
    zoom: 14
  });

  naver.maps.Event.addListener(map, "click", () => closeSheet());
  naver.maps.Event.addListener(map, "zoom_changed", () => updateMarkerIcons());

  statusTextEl.textContent = "ì¡°íšŒê°œìˆ˜";
  loadRestaurants();
}

/* =========================
   âœ… ìœ„ì¹˜ ê°ì‹œ(í•„ìš”í•  ë•Œë§Œ)
   force=trueë©´ ì¦‰ì‹œ ê¶Œí•œ ìš”ì²­
========================= */
function startWatchLocation(force=false){
  if (watching && !force) return;
  if (!navigator.geolocation){
    statusTextEl.textContent = "ì´ ê¸°ê¸°ì—ì„œ ìœ„ì¹˜ ì‚¬ìš© ë¶ˆê°€";
    return;
  }

  watching = true;
  statusTextEl.textContent = "ìœ„ì¹˜ í™•ì¸ ì¤‘â€¦(í—ˆìš© ëˆŒëŸ¬ì¤˜)";

  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      if (useNear) updateMyLocationOverlay();
      applyFiltersAndRender();
      statusTextEl.textContent = useNear ? "ë‚´ì£¼ë³€ 500m ê¸°ì¤€" : "ì¥í•­ì§€êµ¬ ê¸°ì¤€";
    },
    (err)=>{
      console.warn("ì´ˆê¸° ìœ„ì¹˜ ì‹¤íŒ¨:", err);
      statusTextEl.textContent = "ìœ„ì¹˜ ì¡ëŠ” ì¤‘â€¦";
    },
    { enableHighAccuracy:false, timeout:7000, maximumAge:60000 }
  );

  navigator.geolocation.watchPosition(
    (pos)=>{
      userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      if (useNear) updateMyLocationOverlay();
      applyFiltersAndRender();
    },
    (err)=>{
      console.warn("ìœ„ì¹˜ ì˜¤ë¥˜:", err);
      if (err.code === 1) statusTextEl.textContent = "ìœ„ì¹˜ ê¶Œí•œ í•„ìš”(í—ˆìš© ëˆŒëŸ¬ì¤˜)";
      else if (err.code === 3) statusTextEl.textContent = "ìœ„ì¹˜ê°€ ëŠ¦ê²Œ ì¡í˜€ìš”(ì‹¤ì™¸/ì •í™•í•œ ìœ„ì¹˜ ON ì¶”ì²œ)";
      else statusTextEl.textContent = "ìœ„ì¹˜ ì‚¬ìš© ë¶ˆê°€";
    },
    { enableHighAccuracy:true, timeout:20000, maximumAge:5000 }
  );
}

function updateMyLocationOverlay(){
  if (!map || !userPos) return;
  const latlng = new naver.maps.LatLng(userPos.lat, userPos.lng);

  if (!myMarker){
    myMarker = new naver.maps.Marker({
      position: latlng,
      map,
      icon: {
        content: `<div style="transform:translate(-50%,-50%); width:14px; height:14px; border-radius:999px;
          background:#03c75a; box-shadow:0 6px 16px rgba(0,0,0,.25); border:2px solid #fff;"></div>`,
        size: new naver.maps.Size(20,20),
        anchor: new naver.maps.Point(10,10)
      }
    });
  } else {
    myMarker.setPosition(latlng);
  }

  if (!myCircle){
    myCircle = new naver.maps.Circle({
      map,
      center: latlng,
      radius: 500,
      fillColor: "#03c75a",
      fillOpacity: 0.12,
      strokeColor: "#03c75a",
      strokeOpacity: 0.35,
      strokeWeight: 2
    });
  } else {
    myCircle.setCenter(latlng);
  }
}

/* =========================
   ë°ì´í„° ë¡œë“œ
========================= */
function loadRestaurants(){
  fetch(API_URL + "?action=list")
    .then(r=>r.json())
    .then(json=>{
      if (!json.ok){
        statusTextEl.textContent = "ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨";
        console.error(json);
        return;
      }
      allData = json.data || [];
      buildChipsFromData(allData);
      applyFiltersAndRender();
    })
    .catch(err=>{
      console.error(err);
      statusTextEl.textContent = "ë°ì´í„° ìš”ì²­ ì˜¤ë¥˜";
    });
}

/* =========================
   ë§ˆì»¤ ë Œë”
========================= */
function clearMarkers(){
  markers.forEach(m => m.marker.setMap(null));
  markers.length = 0;
}
function updateMarkerIcons(){
  if (!map) return;
  const showLabel = map.getZoom() > 14;
  markers.forEach(({ marker, item }) => {
    marker.setIcon({
      content: markerHtml(item, showLabel),
      size: iconSize(),
      anchor: iconAnchor()
    });
  });
}
function renderMarkers(data){
  clearMarkers();
  const showLabel = map.getZoom() > 14;

  data.forEach(item=>{
    const marker = new naver.maps.Marker({
      position: new naver.maps.LatLng(item.lat, item.lng),
      map,
      icon:{
        content: markerHtml(item, showLabel),
        size: iconSize(),
        anchor: iconAnchor()
      }
    });

    naver.maps.Event.addListener(marker, "click", ()=>{
      selected = item;
      showSheet(item);
      loadComments(item.id);
    });

    markers.push({ marker, item });
  });
}

/* =========================
   í•„í„° ì ìš©
========================= */
function applyFiltersAndRender(){
  if (!map) return;

  const filtered = allData.filter(it=>{
    if (onlyVerified && !isVerifiedItem(it)) return false;
    if (!matchCategory(it)) return false;

    if (useNear){
      if (!userPos) return false;
      return within500m(it);
    }
    return true;
  });

  renderMarkers(filtered);

  if (useNear && !userPos) statusTextEl.textContent = "ë‚´ì£¼ë³€ 500m: ìœ„ì¹˜ ê¶Œí•œ í•„ìš”";
  else {
    const base = useNear ? "ë‚´ì£¼ë³€ 500m" : "ì¥í•­ì§€êµ¬ ê¸°ì¤€";
    const v = onlyVerified ? " Â· ğŸ‘‘ì¸ì¦" : "";
    statusTextEl.textContent = `${base}${v} Â· ${filtered.length}ê°œ`;
  }
}

/* =========================
   ë°”í…€ì‹œíŠ¸ + ëŒ“ê¸€
========================= */
function showSheet(item){
  document.getElementById("sName").textContent = item.name || "";
  document.getElementById("sAddr").textContent = item.address || "";

  const descEl = document.getElementById("sDesc");
  const desc = String(item.desc || "").trim();
  if (desc){
    descEl.style.display = "block";
    descEl.textContent = desc;
  } else {
    descEl.style.display = "none";
    descEl.textContent = "";
  }

  const cats = parseCats(item.category);
  const tags = parseCats(item.tags);

  const pills = [];
  if (isVerifiedItem(item)) pills.push(`<span class="pill">ğŸ‘‘ ì¸ì¦ë§›ì§‘</span>`);
  if (cats.length) pills.push(...cats.map(c => `<span class="pill">${esc(c)}</span>`));
  if (tags.length) pills.push(...tags.map(t => `<span class="pill">#${esc(t)}</span>`));

  document.getElementById("sMeta").innerHTML = pills.join("");
  document.getElementById("sheet").classList.add("show");
}
function closeSheet(){
  document.getElementById("sheet").classList.remove("show");
}

/* ëŒ“ê¸€ */
function renderComments(list){
  cmtListEl.innerHTML = "";
  if (!list || list.length === 0){
    cmtListEl.innerHTML = `<div class="mini">ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš” ğŸ™‚</div>`;
    return;
  }
  list.forEach(c=>{
    const nick = esc(c.nickname || "ìµëª…");
    const time = esc(c.createdAt || "");
    const content = esc(c.content || "");
    const el = document.createElement("div");
    el.className = "cmtItem";
    el.innerHTML = `
      <div class="cmtTop">
        <div class="cmtNick">${nick}</div>
        <div class="cmtTime">${time}</div>
      </div>
      <div class="cmtContent">${content}</div>
    `;
    cmtListEl.appendChild(el);
  });
}

async function loadComments(restaurantId){
  if (!restaurantId) return;
  cmtStatusEl.textContent = "ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦";
  try{
    const res = await fetch(API_URL + `?action=comments&restaurantId=${encodeURIComponent(restaurantId)}`);
    const json = await res.json();
    if (!json.ok) throw new Error(json.error || "ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨");
    renderComments(json.data || []);
    cmtStatusEl.textContent = "";
  }catch(e){
    console.error(e);
    cmtStatusEl.textContent = "ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.";
  }
}

async function addCommentFromUI(){
  if (!selected?.id) return;

  const nickname = nickInputEl.value.trim();
  const content = contentInputEl.value.trim();

  if (!nickname) { alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì¤˜"); return; }
  if (!content) { alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì¤˜"); return; }

  cmtStatusEl.textContent = "ë“±ë¡ ì¤‘â€¦";
  try{
    const res = await fetch(API_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        action: "addcomment",
        data: { restaurantId: String(selected.id), nickname, content }
      })
    });
    const json = await res.json();
    if (!json.ok) throw new Error(json.error || "ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨");

    contentInputEl.value = "";
    await loadComments(selected.id);
    cmtStatusEl.textContent = "";
  }catch(e){
    console.error(e);
    cmtStatusEl.textContent = "ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨";
    alert("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨: " + (e.message || ""));
  }
}

/* =========================
   ë„¤ì´ë²„ì§€ë„ ì´ë™
   - placeUrl ìˆìœ¼ë©´ ê·¸ê±¸ ìš°ì„  ì‚¬ìš©
========================= */
function openNaverMap(){
  if (!selected) return;

  const placeUrl = String(selected.placeUrl || "").trim();
  if (placeUrl){
    window.open(placeUrl, "_blank");
    return;
  }

  const name = encodeURIComponent(selected.name || "");
  const lat = selected.lat;
  const lng = selected.lng;
  const appname = encodeURIComponent("ì¥í•­ì§€êµ¬ë§›ì§‘");

  const ua = navigator.userAgent.toLowerCase();
  if (ua.includes("android")) {
    const url = "intent://place?lat=" + lat + "&lng=" + lng + "&name=" + name + "&appname=" + appname +
      "#Intent;scheme=nmap;package=com.nhn.android.nmap;end";
    window.open(url, "_blank");
  } else if (/iphone|ipad/.test(ua)) {
    const link = document.createElement("a");
    link.href = "nmap://place?lat=" + lat + "&lng=" + lng + "&name=" + name + "&appname=" + appname;
    link.target = "_blank";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  } else {
    window.open("https://map.naver.com/v5/search/" + name, "_blank");
  }
}

/* =========================
   ì‹œì‘
========================= */
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", initMap);
} else {
  initMap();
}
</script>
</body>
</html>
