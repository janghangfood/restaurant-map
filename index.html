<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì¥í•­ì§€êµ¬ ë§›ì§‘ì§€ë„</title>

<!-- âœ… ë„¤ì´ë²„ ì§€ë„ SDK (ë„ˆ í‚¤ ë°©ì‹ ìœ ì§€) -->
<script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=g7937mmgwu"></script>

<style>
html, body { margin:0; padding:0; height:100%; font-family: -apple-system, BlinkMacSystemFont, 'Noto Sans KR'; }
#map { width:100%; height:100%; }

.sheet {
  position: fixed;
  left:0; right:0; bottom:0;
  background:#fff;
  border-radius:16px 16px 0 0;
  box-shadow:0 -6px 20px rgba(0,0,0,.2);
  padding:16px;
  display:none;
  z-index:1000;
}
.sheet.show { display:block; }
.title { font-weight:800; font-size:16px; }
.addr { font-size:13px; color:#555; margin-top:4px; }

.meta { margin-top:8px; display:flex; gap:6px; flex-wrap:wrap; }
.pill {
  font-size:12px;
  padding:4px 8px;
  border-radius:999px;
  background:#f2f2f2;
}

.btn {
  margin-top:12px;
  padding:12px;
  background:#03c75a;
  color:#fff;
  text-align:center;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
}
.close-btn {
  position: absolute;
  top: 16px;
  right: 16px;
  width: 24px;
  height: 24px;
  cursor: pointer;
  font-size: 20px;
  color: #999;
}
</style>
</head>

<body>
<div id="map"></div>

<!-- ë°”í…€ì‹œíŠ¸ -->
<div id="sheet" class="sheet">
  <span class="close-btn" onclick="closeSheet()">Ã—</span>
  <div class="title" id="sName"></div>
  <div class="addr" id="sAddr"></div>
  <div class="meta" id="sMeta"></div>
  <div class="btn" onclick="openNaverMap()">ë„¤ì´ë²„ì§€ë„ì—ì„œ ë³´ê¸°</div>
</div>

<script>
/******** ì„¤ì • ********/
// âœ… Cloudflare Worker API URL
const API_URL = "https://twilight-art-ed3c.wlalsqqq.workers.dev";
/************************/

let selected = null;
let map = null;

// ë§ˆì»¤ ëª©ë¡(ì¬ë¡œë”©/ì¤Œ ë³€ê²½ì— ì‚¬ìš©)
const markers = [];

/* =========================
   ì¹´í…Œê³ ë¦¬ â†’ ì´ëª¨ì§€ (B ë°©ì‹)
========================= */
const CATEGORY_PRIORITY = [
  "ì¹´í˜","ë””ì €íŠ¸","ë¸ŒëŸ°ì¹˜","ë² ì´ì»¤ë¦¬",
  "í•œì‹","êµ­ë°¥","ê³ ê¸°","í•´ì‚°ë¬¼","ë©´",
  "ì¤‘ì‹","ì¼ì‹","ì´ˆë°¥","ìŠ¤ì‹œ","ëˆê¹ŒìŠ¤","ì–‘ì‹","ì•„ì‹œì•„",
  "ë¶„ì‹","ì¹˜í‚¨","í”¼ì","í–„ë²„ê±°","ìƒëŸ¬ë“œ","ìˆ ì§‘",
  "ë°°ë‹¬"
];

const CAT_EMOJI = {
  "ì¹´í˜": "â˜•",
  "ë””ì €íŠ¸": "ğŸ°",
  "ë¸ŒëŸ°ì¹˜": "ğŸ¥",
  "ë² ì´ì»¤ë¦¬": "ğŸ¥–",

  "í•œì‹": "ğŸš",
  "êµ­ë°¥": "ğŸ¥˜",
  "ê³ ê¸°": "ğŸ¥©",
  "í•´ì‚°ë¬¼": "ğŸ¦",
  "ë©´": "ğŸœ",

  "ì¤‘ì‹": "ğŸ¥Ÿ",
  "ì¼ì‹": "ğŸ£",
  "ì´ˆë°¥": "ğŸ£",
  "ìŠ¤ì‹œ": "ğŸ£",
  "ëˆê¹ŒìŠ¤": "ğŸ–",
  "ì–‘ì‹": "ğŸ",
  "ì•„ì‹œì•„": "ğŸ›",

  "ë¶„ì‹": "ğŸ¢",
  "ì¹˜í‚¨": "ğŸ—",
  "í”¼ì": "ğŸ•",
  "í–„ë²„ê±°": "ğŸ”",
  "ìƒëŸ¬ë“œ": "ğŸ¥—",
  "ìˆ ì§‘": "ğŸº",
  "ë°°ë‹¬": "ğŸ›µ",
  "ê¸°íƒ€": "ğŸ“"
};

function parseCats(str){
  return String(str||"")
    .split(",")
    .map(s=>s.trim())
    .filter(Boolean);
}

function pickMainCategory(categoryStr){
  const cats = parseCats(categoryStr);
  for (const p of CATEGORY_PRIORITY){
    if (cats.includes(p)) return p;
  }
  return cats[0] || "ê¸°íƒ€";
}

function emojiOf(cat){
  return CAT_EMOJI[cat] || CAT_EMOJI["ê¸°íƒ€"];
}

function esc(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function markerHtmlEmojiB(item, showLabel){
  const cats = parseCats(item.category);
  const main = pickMainCategory(item.category);
  const extras = cats.filter(c => c !== main).slice(0, 2);

  const mainEmoji = emojiOf(main);
  const extraEmojis = extras.map(c => emojiOf(c));

  const badge = extraEmojis.length ? `
    <div style="
      position:absolute; right:-10px; top:-10px;
      display:flex; gap:2px;
      background:#fff; border-radius:999px;
      padding:2px 6px; font-size:14px;
      box-shadow:0 4px 12px rgba(0,0,0,.18);
      border:1px solid rgba(0,0,0,.06);
    ">
      ${extraEmojis.map(e => `<span>${e}</span>`).join("")}
    </div>
  ` : "";

  return `
    <div style="
      transform: translate(-50%, -100%);
      display:flex; flex-direction:column; align-items:center; gap:6px;
      pointer-events:auto;
    ">
      <div style="position:relative;">
        <div style="
          width:38px; height:38px; border-radius:19px;
          background:#fff;
          display:flex; align-items:center; justify-content:center;
          font-size:22px;
          box-shadow:0 8px 20px rgba(0,0,0,.22);
          border:1px solid rgba(0,0,0,.06);
        ">
          ${mainEmoji}
        </div>
        ${badge}
      </div>

      ${showLabel ? `
        <div style="
          max-width:220px;
          background:#fff;
          padding:6px 10px;
          border-radius:999px;
          font-size:12px;
          font-weight:800;
          white-space:nowrap;
          overflow:hidden;
          text-overflow:ellipsis;
          box-shadow:0 8px 20px rgba(0,0,0,.18);
          border:1px solid rgba(0,0,0,.06);
        ">
          ${esc(item.name)}
        </div>
      ` : ""}
    </div>
  `;
}

/* =========================
   ì§€ë„ ì´ˆê¸°í™”
========================= */
function initMap() {
  if (typeof naver === 'undefined' || typeof naver.maps === 'undefined') {
    console.error('ë„¤ì´ë²„ ì§€ë„ SDK ë¡œë“œ ì‹¤íŒ¨');
    setTimeout(initMap, 100);
    return;
  }

  map = new naver.maps.Map('map', {
    center: new naver.maps.LatLng(37.661, 126.764),
    zoom: 14
  });

  // ì§€ë„ í´ë¦­ ì‹œ ë°”í…€ì‹œíŠ¸ ë‹«ê¸°
  naver.maps.Event.addListener(map, 'click', () => closeSheet());

  // ì¤Œ ë³€ê²½ ì‹œ ë¼ë²¨ on/off
  naver.maps.Event.addListener(map, "zoom_changed", () => {
    const showLabel = map.getZoom() > 14;
    markers.forEach(({ marker, item }) => {
      marker.setIcon({
        content: markerHtmlEmojiB(item, showLabel),
        anchor: new naver.maps.Point(0, 0)
      });
    });
  });

  loadRestaurants();
}

/* =========================
   ìŠ¹ì¸ ë§›ì§‘ ë¶ˆëŸ¬ì˜¤ê¸°
========================= */
function loadRestaurants() {
  fetch(API_URL + '?action=list')
    .then(r => r.json())
    .then(json => {
      if (!json.ok) {
        console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', json);
        return;
      }

      console.log('ë§›ì§‘ ë°ì´í„°:', json.data);

      // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
      markers.forEach(m => m.marker.setMap(null));
      markers.length = 0;

      const showLabel = map.getZoom() > 14;

      json.data.forEach(item => {
        const marker = new naver.maps.Marker({
          position: new naver.maps.LatLng(item.lat, item.lng),
          map,
          icon: {
            content: markerHtmlEmojiB(item, showLabel),
            anchor: new naver.maps.Point(0, 0)
          }
        });

        naver.maps.Event.addListener(marker, 'click', () => {
          selected = item;
          showSheet(item);
        });

        markers.push({ marker, item });
      });
    })
    .catch(err => console.error('Fetch ì—ëŸ¬:', err));
}

/* =========================
   ë°”í…€ì‹œíŠ¸
========================= */
function showSheet(item) {
  document.getElementById('sName').textContent = item.name || '';
  document.getElementById('sAddr').textContent = item.address || '';

  const cats = parseCats(item.category);
  const tags = parseCats(item.tags);

  const pills = [];
  if (cats.length) pills.push(...cats.map(c => `<span class="pill">${esc(c)}</span>`));
  if (tags.length) pills.push(...tags.map(t => `<span class="pill">#${esc(t)}</span>`));

  document.getElementById('sMeta').innerHTML = pills.join("");
  document.getElementById('sheet').classList.add('show');
}

function closeSheet() {
  document.getElementById('sheet').classList.remove('show');
}

/* =========================
   ë„¤ì´ë²„ì§€ë„ ì•±/ì›¹ ì´ë™
========================= */
function openNaverMap() {
  if (!selected) return;

  const name = encodeURIComponent(selected.name || "");
  const lat = selected.lat;
  const lng = selected.lng;
  const appname = encodeURIComponent('ì¥í•­ì§€êµ¬ë§›ì§‘');

  const ua = navigator.userAgent.toLowerCase();
  let targetUrl = '';

  if (ua.indexOf('android') > -1) {
    targetUrl = 'intent://place?lat=' + lat +
      '&lng=' + lng +
      '&name=' + name +
      '&appname=' + appname +
      '#Intent;scheme=nmap;package=com.nhn.android.nmap;end';
    window.open(targetUrl, '_blank');

  } else if (/iphone|ipad/.test(ua)) {
    const link = document.createElement('a');
    link.href = 'nmap://place?lat=' + lat +
      '&lng=' + lng +
      '&name=' + name +
      '&appname=' + appname;
    link.target = '_blank';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

  } else {
    targetUrl = 'https://map.naver.com/v5/search/' + name;
    window.open(targetUrl, '_blank');
  }
}

// í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì§€ë„ ì´ˆê¸°í™”
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initMap);
} else {
  initMap();
}
</script>
</body>
</html>
