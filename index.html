<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì¥í•­ì§€êµ¬ ë§›ì§‘ì§€ë„</title>

<link rel="icon" href="data:,">
<script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=g7937mmgwu"></script>

<style>
html, body { margin:0; padding:0; height:100%; font-family:-apple-system, BlinkMacSystemFont, 'Noto Sans KR', sans-serif; }
#map { width:100%; height:100%; position:relative; z-index:1; }

/* âœ… ìƒë‹¨ UI */
.topUI{ position:fixed; left:12px; right:12px; top:12px; z-index:9999; display:flex; flex-direction:column; gap:8px; pointer-events:none; }
.topRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
.brand{ font-weight:900; font-size:15px; color:#111; text-shadow:0 2px 10px rgba(255,255,255,.9); }
.status{ font-size:11px; color:#222; text-shadow:0 2px 10px rgba(255,255,255,.9); }
.controls{ display:flex; align-items:center; gap:6px; pointer-events:auto; }

.toggleBtn{
  display:flex; align-items:center; gap:6px;
  padding:6px 8px; border-radius:999px;
  border:1px solid rgba(0,0,0,.08);
  background: rgba(255,255,255,.78);
  box-shadow:0 8px 18px rgba(0,0,0,.10);
  font-weight:900; font-size:11px;
  cursor:pointer; user-select:none;
}
.toggleDot{ width:9px; height:9px; border-radius:999px; background:#bbb; }
.toggleBtn.on .toggleDot{ background:#03c75a; }
.toggleBtn.on{ border-color: rgba(3,199,90,.35); }

.chipBar{ display:flex; gap:6px; flex-wrap:nowrap; overflow:auto; -webkit-overflow-scrolling: touch; padding-bottom:2px; pointer-events:auto; }
.chipBar::-webkit-scrollbar{ display:none; }
.chip{
  flex:0 0 auto;
  padding:6px 8px; border-radius:999px;
  border:1px solid rgba(0,0,0,.08);
  background: rgba(255,255,255,.78);
  box-shadow:0 8px 18px rgba(0,0,0,.10);
  font-weight:900; font-size:11px;
  cursor:pointer; user-select:none; white-space:nowrap;
}
.chip.on{ background: rgba(3,199,90,.92); border-color: rgba(3,199,90,.40); color:#fff; }

/* âœ… ì˜¤ë¥¸ìª½ ì•„ë˜ ë²„íŠ¼ë“¤ */
.fab{
  position:fixed; right:16px; bottom:18px; z-index:9999;
  width:52px; height:52px; border-radius:999px;
  background:#03c75a; color:#fff;
  display:flex; align-items:center; justify-content:center;
  font-weight:900; font-size:13px;
  border:0; box-shadow:0 12px 24px rgba(0,0,0,.20);
  cursor:pointer;
}
.locBtn{
  position:fixed; right:16px; bottom:80px; z-index:9999;
  width:42px; height:42px; border-radius:999px;
  background: rgba(255,255,255,.92);
  border:1px solid rgba(0,0,0,.10);
  box-shadow:0 10px 20px rgba(0,0,0,.16);
  cursor:pointer; font-weight:900; font-size:18px;
  display:flex; align-items:center; justify-content:center;
}
.fab:active,.locBtn:active{ transform: translateY(1px); }

/* âœ… ë°”í…€ì‹œíŠ¸ */
.sheet{
  position:fixed; left:0; right:0; bottom:0;
  background:#fff; border-radius:16px 16px 0 0;
  box-shadow:0 -6px 20px rgba(0,0,0,.2);
  padding:16px; display:none; z-index:9998;
  max-height:72vh; overflow:auto;
}
.sheet.show{ display:block; }

.close-btn{
  position:sticky; top:0;
  display:flex; justify-content:flex-end;
  background:linear-gradient(to bottom, rgba(255,255,255,1), rgba(255,255,255,.9));
  padding-bottom:8px;
  z-index:5;
}
.close-x{
  width:28px; height:28px; border-radius:999px;
  border:1px solid rgba(0,0,0,.08); background:#fff;
  cursor:pointer; font-size:18px; color:#777;
  display:flex; align-items:center; justify-content:center;
}
.sheetTitle{ font-weight:900; font-size:15px; }
.addr{ font-size:12px; color:#555; margin-top:4px; }
.desc{ font-size:12px; color:#222; margin-top:8px; line-height:1.35; }
.meta{ margin-top:10px; display:flex; gap:6px; flex-wrap:wrap; }
.pill{ font-size:11px; padding:4px 8px; border-radius:999px; background:#f2f2f2; }

.btn{
  margin-top:10px; padding:12px;
  background:#03c75a; color:#fff;
  text-align:center; border-radius:12px;
  font-weight:900; cursor:pointer; border:0; width:100%;
}
.btn.secondary{ background:#111; margin-top:8px; }
.btn:disabled{ opacity:.6; cursor:not-allowed; }

/* ëŒ“ê¸€ */
.cmtBox{ margin-top:14px; }
.cmtHeader{ font-weight:900; font-size:13px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; gap:10px; }
.cmtSummary{ font-size:11px; color:#555; white-space:nowrap; }
.cmtList{ display:flex; flex-direction:column; gap:10px; }
.cmtItem{ border:1px solid rgba(0,0,0,.07); border-radius:12px; padding:10px; background:#fff; }
.cmtTop{ display:flex; justify-content:space-between; gap:10px; align-items:center; }
.cmtNick{ font-weight:900; font-size:12px; }
.cmtTime{ font-size:10px; color:#777; white-space:nowrap; }
.cmtStars{ font-size:12px; letter-spacing:1px; }
.cmtContent{ margin-top:6px; font-size:12px; line-height:1.35; }

.formRow{ display:flex; gap:8px; margin-top:10px; }
.input{ flex:1; padding:10px 12px; border-radius:12px; border:1px solid rgba(0,0,0,.12); font-size:12px; }
textarea.input{ min-height:70px; resize:none; }
.mini{ font-size:11px; color:#777; margin-top:8px; }

/* âœ… ë³„ì  ì„ íƒ UI */
.ratingRow{ display:flex; align-items:center; gap:8px; margin-top:10px; }
.starBtn{
  width:34px; height:34px; border-radius:10px;
  border:1px solid rgba(0,0,0,.12);
  background:#fff;
  cursor:pointer;
  font-size:18px;
  display:flex; align-items:center; justify-content:center;
}
.starBtn.on{ border-color: rgba(3,199,90,.35); }
.ratingHint{ font-size:11px; color:#666; }

/* âœ… ë¡œë”© ë°” (ëŒ“ê¸€ìš©) */
.progressWrap{
  position:sticky; top:0;
  z-index:6;
  height:3px;
  border-radius:999px;
  overflow:hidden;
  background:rgba(0,0,0,.06);
  display:none;
}
.progressWrap.show{ display:block; }
.progressBar{
  width:35%;
  height:100%;
  background:#03c75a;
  transform: translateX(-120%);
  animation: progressMove 1.0s infinite linear;
}
@keyframes progressMove {
  0% { transform: translateX(-120%); }
  100% { transform: translateX(320%); }
}

/* âœ… íŒì—…(ëª¨ë‹¬) (index êµ¬ì¡°ìš©) */
.modal{
  position:fixed; inset:0;
  background:rgba(0,0,0,.35);
  z-index:10000;
  display:none;
  align-items:center;
  justify-content:center;
  padding:18px;
}
.modal.show{ display:flex; }

.modalCard{
  width:min(360px, 92vw);
  background:#fff;
  border-radius:18px;
  box-shadow:0 16px 40px rgba(0,0,0,.25);
  padding:14px 14px 12px;
  border:1px solid rgba(0,0,0,.06);
}
.modalTitle{ font-weight:900; font-size:14px; color:#111; }
.modalMsg{ margin-top:6px; font-size:12px; color:#444; line-height:1.35; white-space: pre-line;}
.modalBtns{ display:flex; gap:8px; margin-top:12px; }
.mbtn{
  flex:1;
  padding:10px 12px;
  border-radius:12px;
  border:0;
  font-weight:900;
  cursor:pointer;
}
.mbtn.ok{ background:#03c75a; color:#fff; }
.mbtn.dark{ background:#111; color:#fff; }
.mbtn.ghost{ background:#f2f2f2; color:#111; }

/* âœ… í† ìŠ¤íŠ¸ */
.toast{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:18px;
  z-index:10001;
  background:rgba(17,17,17,.92);
  color:#fff;
  padding:10px 12px;
  border-radius:999px;
  font-size:12px;
  font-weight:900;
  box-shadow:0 12px 24px rgba(0,0,0,.22);
  display:none;
}
.toast.show{ display:block; }

/* âœ… ëª¨ë‹¬ Fade + Scale ì• ë‹ˆë©”ì´ì…˜ (index.html êµ¬ì¡°: .modal + .modalCard) */
.modal{
  opacity: 0;
  transition: opacity .18s ease;
  will-change: opacity;
}
.modal.show{
  opacity: 1;
}
.modalCard{
  opacity: 0;
  transform: scale(.96) translateY(10px);
  transition: transform .22s cubic-bezier(.2,.8,.2,1), opacity .18s ease;
  will-change: transform, opacity;
}
.modal.show .modalCard{
  opacity: 1;
  transform: scale(1) translateY(0);
}
@media (prefers-reduced-motion: reduce){
  .modal, .modalCard{ transition:none !important; }
}
</style>
</head>

<body>
<div id="map"></div>

<div class="topUI">
  <div class="topRow">
    <div>
      <div class="brand">ì¥í•­ì§€êµ¬ ë§›ì§‘ì§€ë„</div>
      <div class="status" id="statusText">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
    </div>
    <div class="controls">
      <div id="nearBtn" class="toggleBtn" title="ë‚´ì£¼ë³€ 500m">
        <span class="toggleDot"></span><span>500m</span>
      </div>
      <div id="vipBtn" class="toggleBtn" title="ì¸ì¦ë§›ì§‘ë§Œ">
        <span class="toggleDot"></span><span>ğŸ‘‘ ì¸ì¦ë§›ì§‘</span>
      </div>
    </div>
  </div>

  <div class="chipBar" id="chips"></div>
</div>

<button class="locBtn" id="btnMyLoc" type="button" title="í˜„ì¬ ìœ„ì¹˜ë¡œ">â¦¿</button>
<button class="fab" id="fabReport" type="button">ì œë³´</button>

<div id="sheet" class="sheet">
  <div class="close-btn">
    <button class="close-x" id="btnCloseSheet" type="button">Ã—</button>
  </div>

  <!-- âœ… ëŒ“ê¸€ ë¡œë”©ë°”(ì‹œíŠ¸ ìƒë‹¨ ê³ ì •) -->
  <div class="progressWrap" id="cmtProgress">
    <div class="progressBar"></div>
  </div>

  <div class="sheetTitle" id="sName"></div>
  <div class="addr" id="sAddr"></div>
  <div class="desc" id="sDesc" style="display:none;"></div>
  <div class="meta" id="sMeta"></div>

  <button class="btn" id="btnOpenNaver" type="button">ë„¤ì´ë²„ì§€ë„ì—ì„œ ë³´ê¸°</button>

  <div class="cmtBox">
    <div class="cmtHeader">
      <div>ëŒ“ê¸€</div>
      <div class="cmtSummary" id="ratingSummary"></div>
    </div>

    <div class="cmtList" id="cmtList"></div>
    <div class="mini" id="cmtStatus"></div>

    <!-- âœ… ë³„ì  ì„ íƒ -->
    <div class="ratingRow" id="ratingRow">
      <button class="starBtn" data-v="1" type="button">â˜…</button>
      <button class="starBtn" data-v="2" type="button">â˜…</button>
      <button class="starBtn" data-v="3" type="button">â˜…</button>
      <button class="starBtn" data-v="4" type="button">â˜…</button>
      <button class="starBtn" data-v="5" type="button">â˜…</button>
      <div class="ratingHint" id="ratingHint">í‰ì  ì„ íƒ</div>
    </div>

    <div class="formRow">
      <input class="input" id="nickInput" placeholder="ë‹‰ë„¤ì„" maxlength="20" />
    </div>
    <div class="formRow">
      <textarea class="input" id="contentInput" placeholder="ëŒ“ê¸€ì„ ë‚¨ê²¨ì£¼ì„¸ìš”" maxlength="300"></textarea>
    </div>
    <button class="btn secondary" id="btnAddComment" type="button">ëŒ“ê¸€ ë‹¬ê¸°</button>
  </div>
</div>

<!-- âœ… íŒì—…(ëª¨ë‹¬) -->
<div class="modal" id="modal">
  <div class="modalCard">
    <div class="modalTitle" id="modalTitle">ì•ˆë‚´</div>
    <div class="modalMsg" id="modalMsg"></div>
    <div class="modalBtns" id="modalBtns"></div>
  </div>
</div>

<!-- âœ… í† ìŠ¤íŠ¸ -->
<div class="toast" id="toast"></div>

<script>
/******** ì„¤ì • ********/
const API_URL = "https://twilight-art-ed3c.wlalsqqq.workers.dev"; // âœ… Worker
const REPORT_URL = "./submit.html";
/************************/

let map = null;
let selected = null;

const statusTextEl = document.getElementById("statusText");
const chipsEl = document.getElementById("chips");

const cmtListEl = document.getElementById("cmtList");
const cmtStatusEl = document.getElementById("cmtStatus");
const nickInputEl = document.getElementById("nickInput");
const contentInputEl = document.getElementById("contentInput");
const ratingSummaryEl = document.getElementById("ratingSummary");
const cmtProgressEl = document.getElementById("cmtProgress");

const nearBtnEl = document.getElementById("nearBtn");
const vipBtnEl = document.getElementById("vipBtn");
const btnAddCommentEl = document.getElementById("btnAddComment");

let useNear = false;
let useVipOnly = false;

const markers = [];
let allData = [];
let userPos = null;

let myMarker = null;
let myCircle = null;
let watchId = null;

/* =========================
   âœ… íŒì—…/í† ìŠ¤íŠ¸ ìœ í‹¸ (index.htmlìš©)
========================= */
const modalEl = document.getElementById("modal");
const modalTitleEl = document.getElementById("modalTitle");
const modalMsgEl = document.getElementById("modalMsg");
const modalBtnsEl = document.getElementById("modalBtns");
const toastEl = document.getElementById("toast");

function showToast(msg, ms=1800){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>toastEl.classList.remove("show"), ms);
}

function hideModal(){ modalEl.classList.remove("show"); }

function showModal({ title="ì•ˆë‚´", message="", buttons=[] }){
  modalTitleEl.textContent = title;
  modalMsgEl.textContent = message;
  modalBtnsEl.innerHTML = "";

  const btns = buttons.length
    ? buttons
    : [{ text:"í™•ì¸", kind:"ok", onClick: ()=>{} }];

  btns.forEach(b=>{
    const el = document.createElement("button");
    el.className = "mbtn " + (b.kind || "ok");
    el.textContent = b.text || "í™•ì¸";
    el.onclick = ()=>{
      try{ b.onClick && b.onClick(); }
      finally{ if (b.autoClose !== false) hideModal(); }
    };
    modalBtnsEl.appendChild(el);
  });

  modalEl.classList.add("show");
}

// ë°”ê¹¥ í´ë¦­í•˜ë©´ ë‹«ê¸°
modalEl.addEventListener("click", (e)=>{ if (e.target === modalEl) hideModal(); });

// ESCë¡œ ë‹«ê¸°
document.addEventListener("keydown", (e)=>{
  if (e.key === "Escape" && modalEl.classList.contains("show")) hideModal();
});

/* =========================
   deviceId (IP ëŒ€ì‹  í˜„ì‹¤ì ì¸ ì¤‘ë³µ ë°©ì§€ í‚¤)
========================= */
function getDeviceId(){
  const key = "jh_food_device_id";
  let v = localStorage.getItem(key);
  if (v) return v;
  v = "d_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,10);
  localStorage.setItem(key, v);
  return v;
}
const DEVICE_ID = getDeviceId();

/* =========================
   ì´ëª¨ì§€(ëŒ€í‘œ 1ê°œ)
========================= */
const CATEGORY_PRIORITY = [
  "ì¹´í˜","ë””ì €íŠ¸",
  "ë°˜ë ¤ë™ë¬¼ì¹´í˜",
  "ë¸ŒëŸ°ì¹˜","ë² ì´ì»¤ë¦¬",
  "í•œì‹","êµ­ë°¥","ê³ ê¸°","í•´ì‚°ë¬¼","ë©´",
  "ì¤‘ì‹","ì¼ì‹","ì´ˆë°¥","ìŠ¤ì‹œ","ëˆê¹ŒìŠ¤",
  "ì–‘ì‹","ì•„ì‹œì•„","ë¶„ì‹","ì¹˜í‚¨","í”¼ì",
  "í–„ë²„ê±°","ìƒëŸ¬ë“œ","ìˆ ì§‘","ë°°ë‹¬"
];

const CAT_EMOJI = {
  "ì¹´í˜":"â˜•",
  "ë””ì €íŠ¸":"ğŸ°",
  "ë°˜ë ¤ë™ë¬¼ì¹´í˜":"ğŸ¾",
  "ë¸ŒëŸ°ì¹˜":"ğŸ¥",
  "ë² ì´ì»¤ë¦¬":"ğŸ¥–",
  "í•œì‹":"ğŸš",
  "êµ­ë°¥":"ğŸ¥˜",
  "ê³ ê¸°":"ğŸ¥©",
  "í•´ì‚°ë¬¼":"ğŸ¦",
  "ë©´":"ğŸœ",
  "ì¤‘ì‹":"ğŸ¥Ÿ",
  "ì¼ì‹":"ğŸ£",
  "ì´ˆë°¥":"ğŸ£",
  "ìŠ¤ì‹œ":"ğŸ£",
  "ëˆê¹ŒìŠ¤":"ğŸ–",
  "ì–‘ì‹":"ğŸ",
  "ì•„ì‹œì•„":"ğŸ›",
  "ë¶„ì‹":"ğŸ¢",
  "ì¹˜í‚¨":"ğŸ—",
  "í”¼ì":"ğŸ•",
  "í–„ë²„ê±°":"ğŸ”",
  "ìƒëŸ¬ë“œ":"ğŸ¥—",
  "ìˆ ì§‘":"ğŸº",
  "ë°°ë‹¬":"ğŸ›µ",
  "ê¸°íƒ€":"ğŸ“"
};

function parseCats(str){ return String(str||"").split(",").map(s=>s.trim()).filter(Boolean); }
function pickMainCategory(categoryStr){
  const cats = parseCats(categoryStr);
  for (const p of CATEGORY_PRIORITY) if (cats.includes(p)) return p;
  return cats[0] || "ê¸°íƒ€";
}
function emojiOf(cat){ return CAT_EMOJI[cat] || "ğŸ“"; }
function esc(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* âœ… ë§ˆì»¤ HTML: ì™•ê´€ì€ ë°°ì§€ */
function markerHtml(item, showLabel){
  const main = pickMainCategory(item.category);
  const emoji = emojiOf(main);
  const isVip = (String(item.tier||"").toLowerCase() === "verified");

  return `
    <div style="position:relative; transform: translate(-50%, -100%); display:flex; flex-direction:column; align-items:center; gap:6px; pointer-events:auto;">
      <div style="position:relative; width:38px; height:38px; border-radius:19px; background:#fff; display:flex; align-items:center; justify-content:center; font-size:22px; box-shadow:0 8px 20px rgba(0,0,0,.22); border:1px solid rgba(0,0,0,.06);">
        ${emoji}
        ${isVip ? `
          <div style="
            position:absolute; top:-6px; right:-6px;
            width:18px; height:18px; border-radius:999px;
            background:linear-gradient(135deg,#FFD36A,#FFB800);
            color:#5a3b00; font-size:11px;
            display:flex; align-items:center; justify-content:center;
            box-shadow:0 4px 10px rgba(0,0,0,.25);
            border:1px solid rgba(0,0,0,.15);
          ">ğŸ‘‘</div>
        ` : ""}
      </div>

      ${showLabel ? `
        <div style="max-width:200px; background:#fff; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; box-shadow:0 8px 20px rgba(0,0,0,.18); border:1px solid rgba(0,0,0,.06);">
          ${esc(item.name)}
        </div>` : ""}
    </div>`;
}

/* =========================
   ê±°ë¦¬ ê³„ì‚° (500m)
========================= */
function distMeters(lat1, lng1, lat2, lng2){
  const R = 6371000;
  const toRad = d => d * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLng = toRad(lng2 - lng1);
  const a =
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
    Math.sin(dLng/2) * Math.sin(dLng/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}
function within500m(item){
  if (!userPos) return false;
  const d = distMeters(userPos.lat, userPos.lng, Number(item.lat), Number(item.lng));
  return d <= 500;
}

/* =========================
   ì¹´í…Œê³ ë¦¬ ì¹©(ë“±ë¡ëœ ì¹´í…Œê³ ë¦¬ë§Œ)
========================= */
const selectedCats = new Set();
function setAllSelected(){
  selectedCats.clear();
  renderChipsState();
  applyFiltersAndRender();
}
function buildChipsFromData(data){
  const set = new Set();
  data.forEach(it => parseCats(it.category).forEach(c => set.add(c)));
  const cats = Array.from(set);

  cats.sort((a,b)=>{
    const ia = CATEGORY_PRIORITY.indexOf(a);
    const ib = CATEGORY_PRIORITY.indexOf(b);
    if (ia === -1 && ib === -1) return a.localeCompare(b, "ko");
    if (ia === -1) return 1;
    if (ib === -1) return -1;
    return ia - ib;
  });

  chipsEl.innerHTML = "";

  const all = document.createElement("div");
  all.className = "chip on";
  all.dataset.cat = "__ALL__";
  all.textContent = "âœ¨ ì „ì²´";
  all.onclick = () => setAllSelected();
  chipsEl.appendChild(all);

  cats.forEach(cat=>{
    const el = document.createElement("div");
    el.className = "chip";
    el.dataset.cat = cat;
    el.textContent = `${emojiOf(cat)} ${cat}`;
    el.onclick = () => {
      if (selectedCats.has(cat)) selectedCats.delete(cat);
      else selectedCats.add(cat);
      if (selectedCats.size === 0) setAllSelected();
      else { renderChipsState(); applyFiltersAndRender(); }
    };
    chipsEl.appendChild(el);
  });

  renderChipsState();
}
function renderChipsState(){
  const isAll = selectedCats.size === 0;
  chipsEl.querySelectorAll(".chip").forEach(ch=>{
    const cat = ch.dataset.cat;
    if (cat === "__ALL__") ch.classList.toggle("on", isAll);
    else ch.classList.toggle("on", selectedCats.has(cat));
  });
}
function matchCategory(item){
  if (selectedCats.size === 0) return true;
  const cats = parseCats(item.category);
  return cats.some(c => selectedCats.has(c));
}

/* =========================
   createdAt í‘œì‹œ(KST)
========================= */
function formatKST(v){
  const s = String(v ?? "").trim();
  if (!s) return "";
  if (/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}$/.test(s)) return s;

  const d = new Date(s);
  if (isNaN(d.getTime())) return s;

  const pad = (n)=> String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

/* =========================
   ìœ„ì¹˜: 500m ONì¼ ë•Œë§Œ ì¶”ì 
========================= */
function ensureWatchLocation(){
  if (watchId !== null) return;
  if (!navigator.geolocation){
    statusTextEl.textContent = "ì´ ê¸°ê¸°ì—ì„œ ìœ„ì¹˜ ì‚¬ìš© ë¶ˆê°€";
    return;
  }

  statusTextEl.textContent = "500m: ìœ„ì¹˜ ê¶Œí•œ í—ˆìš© í•„ìš”";

  watchId = navigator.geolocation.watchPosition(
    (pos)=>{
      userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      updateMyLocationOverlay();
      applyFiltersAndRender();
    },
    (err)=>{
      if (err.code === 1) statusTextEl.textContent = "500m: ìœ„ì¹˜ ê¶Œí•œ í•„ìš”(í—ˆìš©)";
      else if (err.code === 3) statusTextEl.textContent = "500m: ìœ„ì¹˜ê°€ ëŠ¦ê²Œ ì¡í˜€ìš”";
      else statusTextEl.textContent = "500m: ìœ„ì¹˜ ì‚¬ìš© ë¶ˆê°€";
    },
    { enableHighAccuracy:true, timeout:20000, maximumAge:5000 }
  );
}
function stopWatchLocation(){
  if (watchId === null) return;
  navigator.geolocation.clearWatch(watchId);
  watchId = null;
}
function updateMyLocationOverlay(){
  if (!map || !userPos) return;
  const latlng = new naver.maps.LatLng(userPos.lat, userPos.lng);

  if (!myMarker){
    myMarker = new naver.maps.Marker({
      position: latlng,
      map,
      icon: {
        content: `<div style="transform:translate(-50%,-50%); width:14px; height:14px; border-radius:999px; background:#03c75a; box-shadow:0 6px 16px rgba(0,0,0,.25); border:2px solid #fff;"></div>`,
        size: new naver.maps.Size(20,20),
        anchor: new naver.maps.Point(10,10)
      }
    });
  } else {
    myMarker.setPosition(latlng);
  }

  if (!myCircle){
    myCircle = new naver.maps.Circle({
      map,
      center: latlng,
      radius: 500,
      fillColor: "#03c75a",
      fillOpacity: 0.12,
      strokeColor: "#03c75a",
      strokeOpacity: 0.35,
      strokeWeight: 2
    });
  } else {
    myCircle.setCenter(latlng);
  }
}

/* =========================
   í‰ì  UI (1~5)
========================= */
let selectedRating = 0;
const starBtns = Array.from(document.querySelectorAll(".starBtn"));
const ratingHintEl = document.getElementById("ratingHint");

function paintStars(v){
  starBtns.forEach(btn=>{
    const n = Number(btn.dataset.v);
    btn.classList.toggle("on", n <= v);
    btn.textContent = (n <= v) ? "â˜…" : "â˜†";
  });
  ratingHintEl.textContent = v ? `ì„ íƒ: ${v}ì ` : "í‰ì  ì„ íƒ";
}

starBtns.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    selectedRating = Number(btn.dataset.v);
    paintStars(selectedRating);
  });
});

/* =========================
   UI ì´ë²¤íŠ¸
========================= */
nearBtnEl.addEventListener("click", ()=>{
  useNear = !useNear;
  nearBtnEl.classList.toggle("on", useNear);

  if (useNear) ensureWatchLocation();
  else {
    stopWatchLocation();
    userPos = null;
    if (myCircle) myCircle.setMap(null), myCircle=null;
    if (myMarker) myMarker.setMap(null), myMarker=null;
  }
  applyFiltersAndRender();
});

vipBtnEl.addEventListener("click", ()=>{
  useVipOnly = !useVipOnly;
  vipBtnEl.classList.toggle("on", useVipOnly);
  applyFiltersAndRender();
});

document.getElementById("fabReport").addEventListener("click", ()=>{ location.href = REPORT_URL; });

document.getElementById("btnMyLoc").addEventListener("click", ()=>{
  if (!map) return;
  if (!navigator.geolocation){ showToast("ì´ ê¸°ê¸°ì—ì„œ ìœ„ì¹˜ ì‚¬ìš© ë¶ˆê°€"); return; }
  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      map.panTo(new naver.maps.LatLng(userPos.lat, userPos.lng));
      if (map.getZoom() < 16) map.setZoom(16, true);
    },
    ()=> showToast("í˜„ì¬ ìœ„ì¹˜ë¥¼ ëª» ì°¾ì•˜ì–´ìš”. ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì¤˜!"),
    { enableHighAccuracy:true, timeout:8000, maximumAge:5000 }
  );
});

document.getElementById("btnCloseSheet").addEventListener("click", closeSheet);
document.getElementById("btnOpenNaver").addEventListener("click", openNaverMap);
btnAddCommentEl.addEventListener("click", addCommentFromUI);

/* =========================
   ì§€ë„ ì´ˆê¸°í™”
========================= */
let lastShowLabel = null;

function initMap(){
  if (!naver?.maps) { setTimeout(initMap, 100); return; }

  map = new naver.maps.Map("map", {
    center: new naver.maps.LatLng(37.661, 126.764),
    zoom: 14
  });

  naver.maps.Event.addListener(map, "click", () => closeSheet());
  naver.maps.Event.addListener(map, "zoom_changed", () => {
    const showLabel = map.getZoom() > 14;
    if (showLabel === lastShowLabel) return;
    lastShowLabel = showLabel;
    updateMarkerIcons();
  });

  loadRestaurants();
}

/* =========================
   âœ… ë°ì´í„° ë¡œë“œ (ë¡œì»¬ ìºì‹œ ì„ í‘œì‹œ + ìµœì‹  ê°±ì‹ )
========================= */
function loadRestaurants(){
  // 1) ìºì‹œ ì„ í‘œì‹œ
  try{
    const cached = localStorage.getItem("jh_food_list_cache");
    if (cached){
      const parsed = JSON.parse(cached);
      if (Array.isArray(parsed)){
        allData = parsed;
        buildChipsFromData(allData);
        applyFiltersAndRender();
        statusTextEl.textContent = `í‘œì‹œ ${allData.length}ê°œ (ìºì‹œ)`;
      }
    }
  }catch(e){}

  // 2) ìµœì‹  ë°ì´í„° ìš”ì²­
  fetch(API_URL + "?action=list", { cache: "no-store" })
    .then(r=>r.json())
    .then(json=>{
      if (!json.ok){ statusTextEl.textContent="ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨"; return; }
      allData = json.data || [];
      try{ localStorage.setItem("jh_food_list_cache", JSON.stringify(allData)); }catch(e){}
      buildChipsFromData(allData);
      applyFiltersAndRender();
    })
    .catch(()=>{ statusTextEl.textContent="ë°ì´í„° ìš”ì²­ ì˜¤ë¥˜"; });
}

/* =========================
   ë§ˆì»¤ ë Œë” (Batch)
========================= */
function clearMarkers(){
  markers.forEach(m => m.marker.setMap(null));
  markers.length = 0;
}
function updateMarkerIcons(){
  if (!map) return;
  const showLabel = map.getZoom() > 14;
  markers.forEach(({ marker, item }) => marker.setIcon({ content: markerHtml(item, showLabel) }));
}

let renderToken = 0;
function renderMarkers(data){
  clearMarkers();
  const showLabel = map.getZoom() > 14;

  const token = ++renderToken;
  const BATCH = 50;
  let i = 0;

  function step(){
    if (token !== renderToken) return;
    const end = Math.min(i + BATCH, data.length);

    for (; i < end; i++){
      const item = data[i];
      const marker = new naver.maps.Marker({
        position: new naver.maps.LatLng(item.lat, item.lng),
        map,
        icon:{ content: markerHtml(item, showLabel) }
      });

      naver.maps.Event.addListener(marker, "click", ()=>{
        selected = item;
        showSheet(item);
        loadCommentsSmart(item.id);
      });

      markers.push({ marker, item });
    }

    if (i < data.length) requestAnimationFrame(step);
  }

  requestAnimationFrame(step);
}

/* =========================
   í•„í„° ì ìš©
========================= */
function applyFiltersAndRender(){
  if (!map) return;

  const filtered = allData.filter(it=>{
    if (!matchCategory(it)) return false;
    if (useVipOnly && String(it.tier||"").toLowerCase() !== "verified") return false;
    if (useNear){
      if (!userPos) return false;
      return within500m(it);
    }
    return true;
  });

  renderMarkers(filtered);

  if (useNear && !userPos) statusTextEl.textContent = "500m: ìœ„ì¹˜ ê¶Œí•œ í•„ìš”(í—ˆìš©)";
  else statusTextEl.textContent = `í‘œì‹œ ${filtered.length}ê°œ${useNear ? " (500m)" : ""}${useVipOnly ? " (ì¸ì¦)" : ""}`;
}

/* =========================
   ë°”í…€ì‹œíŠ¸ + ëŒ“ê¸€
========================= */
function showSheet(item){
  document.getElementById("sName").textContent = item.name || "";
  document.getElementById("sAddr").textContent = item.address || "";

  const d = String(item.desc || "").trim();
  const descEl = document.getElementById("sDesc");
  if (d){ descEl.style.display = "block"; descEl.textContent = d; }
  else { descEl.style.display = "none"; descEl.textContent = ""; }

  const cats = parseCats(item.category);
  const tags = parseCats(item.tags);

  const pills = [];
  if (String(item.tier||"").toLowerCase() === "verified") pills.push(`<span class="pill">ğŸ‘‘ ì¸ì¦ë§›ì§‘</span>`);
  if (cats.length) pills.push(...cats.map(c => `<span class="pill">${esc(c)}</span>`));
  if (tags.length) pills.push(...tags.map(t => `<span class="pill">#${esc(t)}</span>`));

  document.getElementById("sMeta").innerHTML = pills.join("");
  ratingSummaryEl.textContent = "";

  // âœ… ì…ë ¥/ë³„ì  ì´ˆê¸°í™”
  selectedRating = 0;
  paintStars(0);

  document.getElementById("sheet").classList.add("show");
}
function closeSheet(){ document.getElementById("sheet").classList.remove("show"); }

/* ëŒ“ê¸€ ë Œë” + í‰ê·  */
function starsText(r){
  const n = Math.max(0, Math.min(5, Math.round(Number(r) || 0)));
  return "â˜…".repeat(n) + "âœ©".repeat(5-n) + ` (${n}ì )`;
}

function renderComments(list){
  cmtListEl.innerHTML = "";

  const ratings = (list||[]).map(x => Number(x.rating)).filter(v => Number.isFinite(v) && v>=1 && v<=5);
  if (ratings.length){
    const avg = (ratings.reduce((a,b)=>a+b,0) / ratings.length);
    ratingSummaryEl.textContent = `í‰ê·  ${avg.toFixed(1)}ì  Â· ${ratings.length}ëª…`;
  } else {
    ratingSummaryEl.textContent = "";
  }

  if (!list || list.length === 0){
    cmtListEl.innerHTML = `<div class="mini">ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš” ğŸ™‚</div>`;
    return;
  }

  list.forEach(c=>{
    const nick = esc(c.nickname || "ìµëª…");
    const time = esc(formatKST(c.createdAt));
    const content = esc(c.content || "");
    const rating = Number(c.rating);

    const el = document.createElement("div");
    el.className = "cmtItem";
    el.innerHTML = `
      <div class="cmtTop">
        <div style="display:flex; align-items:center; gap:8px;">
          <div class="cmtNick">${nick}</div>
          <div class="cmtStars">${starsText(rating)}</div>
        </div>
        <div class="cmtTime">${time}</div>
      </div>
      <div class="cmtContent">${content}</div>
    `;
    cmtListEl.appendChild(el);
  });
}

/* =========================
   âœ… ëŒ“ê¸€: ë¹ ë¥¸ UX (ìºì‹œ ì„ í‘œì‹œ + ìµœì‹  ê°±ì‹  + ë¡œë”©ë°” + ì¤‘ë³µìš”ì²­ ì·¨ì†Œ)
========================= */
const COMMENT_TTL_MS = 30_000; // 30ì´ˆ ìºì‹œ
const commentMem = new Map();  // restaurantId -> { ts, data }
let commentAbort = null;

function commentCacheKey(rid){ return "jh_food_cmt_" + rid; }

function showCommentProgress(on){
  cmtProgressEl.classList.toggle("show", !!on);
}

function getCachedComments(rid){
  // 1) ë©”ëª¨ë¦¬ ìºì‹œ
  const m = commentMem.get(rid);
  if (m && (Date.now() - m.ts) < COMMENT_TTL_MS) return m.data;

  // 2) localStorage ìºì‹œ
  try{
    const raw = localStorage.getItem(commentCacheKey(rid));
    if (!raw) return null;
    const obj = JSON.parse(raw);
    if (!obj || !Array.isArray(obj.data) || !obj.ts) return null;
    if ((Date.now() - obj.ts) > COMMENT_TTL_MS) return null;
    commentMem.set(rid, { ts: obj.ts, data: obj.data });
    return obj.data;
  }catch(e){
    return null;
  }
}

function setCachedComments(rid, data){
  const ts = Date.now();
  commentMem.set(rid, { ts, data });
  try{
    localStorage.setItem(commentCacheKey(rid), JSON.stringify({ ts, data }));
  }catch(e){}
}

async function loadCommentsSmart(restaurantId){
  if (!restaurantId) return;

  // ì´ì „ ìš”ì²­ ì·¨ì†Œ
  try{ if (commentAbort) commentAbort.abort(); }catch(e){}
  commentAbort = new AbortController();

  // âœ… ìºì‹œ ì„ í‘œì‹œ
  const cached = getCachedComments(restaurantId);
  if (cached){
    renderComments(cached);
    cmtStatusEl.textContent = "ëŒ“ê¸€ ìµœì‹ í™” ì¤‘â€¦";
  } else {
    cmtListEl.innerHTML = `<div class="mini">ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>`;
    cmtStatusEl.textContent = "";
  }

  showCommentProgress(true);

  try{
    const res = await fetch(API_URL + `?action=comments&restaurantId=${encodeURIComponent(restaurantId)}`, {
      cache: "no-store",
      signal: commentAbort.signal
    });
    const json = await res.json();
    if (!json.ok) throw new Error(json.error || "ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨");

    const list = json.data || [];
    setCachedComments(restaurantId, list);
    renderComments(list);
    cmtStatusEl.textContent = "";
  }catch(e){
    if (e.name === "AbortError") return;
    cmtStatusEl.textContent = "ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.";
    if (!cached) showToast("ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨");
  }finally{
    showCommentProgress(false);
  }
}

/* =========================
   âœ… ëŒ“ê¸€ ë“±ë¡: íŒì—… + ë¡œë”©ë°” + ë²„íŠ¼ ì ê¸ˆ + ì„±ê³µ/ì‹¤íŒ¨ íŒì—…
========================= */
async function addCommentFromUI(){
  if (!selected?.id) return;

  const nickname = nickInputEl.value.trim();
  const content = contentInputEl.value.trim();

  if (!selectedRating) { showModal({ title:"í™•ì¸", message:"í‰ì ì„ ì„ íƒí•´ì¤˜(1~5)" }); return; }
  if (!nickname) { showModal({ title:"í™•ì¸", message:"ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì¤˜" }); return; }
  if (!content) { showModal({ title:"í™•ì¸", message:"ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì¤˜" }); return; }

  // UI ì ê¸ˆ
  btnAddCommentEl.disabled = true;
  showCommentProgress(true);

  showModal({
    title: "ë“±ë¡ ìš”ì²­ ì¤‘â€¦",
    message: "ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.",
    buttons: [{ text:"ë‹«ê¸°", kind:"ghost", onClick: ()=>{} }]
  });

  try{
    const res = await fetch(API_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        action: "addcomment",
        data: {
          restaurantId: String(selected.id),
          nickname,
          content,
          rating: selectedRating,
          deviceId: DEVICE_ID
        }
      })
    });

    const json = await res.json();
    if (!json.ok) throw new Error(json.error || "ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨");

    // ì…ë ¥ ì´ˆê¸°í™”
    contentInputEl.value = "";
    selectedRating = 0;
    paintStars(0);

    // âœ… ìºì‹œ ë¬´íš¨í™” í›„ ìµœì‹  ë¡œë“œ
    try{ localStorage.removeItem(commentCacheKey(selected.id)); }catch(e){}
    commentMem.delete(selected.id);

    hideModal();
    showModal({
      title: "ë“±ë¡ ì™„ë£Œ",
      message: "ëŒ“ê¸€ì´ ë“±ë¡ëì–´ìš” ğŸ™‚",
      buttons: [{ text:"í™•ì¸", kind:"ok", onClick: ()=>{} }]
    });

    await loadCommentsSmart(selected.id);
  }catch(e){
    hideModal();
    showModal({
      title: "ë“±ë¡ ì‹¤íŒ¨",
      message: String(e.message || e || "unknown"),
      buttons: [{ text:"í™•ì¸", kind:"ok", onClick: ()=>{} }]
    });
  }finally{
    btnAddCommentEl.disabled = false;
    showCommentProgress(false);
  }
}

/* =========================
   ë„¤ì´ë²„ì§€ë„ ì´ë™ (placeUrl ìš°ì„ )
========================= */
function openNaverMap(){
  if (!selected) return;
  const placeUrl = String(selected.placeUrl || "").trim();
  if (placeUrl){
    window.open(placeUrl, "_blank");
    return;
  }
  const name = encodeURIComponent(selected.name || "");
  window.open("https://map.naver.com/v5/search/" + name, "_blank");
}

/* =========================
   âœ… ì²« ë°©ë¬¸ ì•ˆë‚´ íŒì—… (1íšŒë§Œ)
========================= */
(function showIntroOnce(){
  const KEY = "jh_food_intro_seen_v1";
  if (localStorage.getItem(KEY)) return;

  showModal({
    title: "ğŸ½ï¸ ì¥í•­ì§€êµ¬ ë§›ì§‘ì§€ë„ ì•ˆë‚´",
    message:
`ì´ ì§€ë„ëŠ”
ì¥í•­ì§€êµ¬ ì…ì£¼ë¯¼ì´ ì§ì ‘ ì œë³´í•˜ê³  ë§Œë“¤ì–´ê°€ëŠ” ë§›ì§‘ ì§€ë„ì…ë‹ˆë‹¤.

ë§›ì§‘ì€ ì•„ë˜ ë‘ ë‹¨ê³„ë¡œ êµ¬ë¶„ë©ë‹ˆë‹¤.

â‘  ì œë³´ë§›ì§‘
ğŸ‘‰ ì…ì£¼ë¯¼ì´ ì§ì ‘ ì œë³´í•œ ë§›ì§‘

â‘¡ ğŸ‘‘ ì¸ì¦ë§›ì§‘
ğŸ‘‰ í˜„ì¬ë„ ìœ ëª…í•˜ê±°ë‚˜
ğŸ‘‰ ëŒ“ê¸€ê³¼ í‰ì ì´ ì¢‹ì•„ ìë™ ìŠ¹ê¸‰ëœ ë§›ì§‘

ê´‘ê³  ì—†ì´
ì¥í•­ì§€êµ¬ ì…ì£¼ë¯¼ì´ ì œë³´í•œ ê°€ê²Œë§Œ í‘œì‹œë©ë‹ˆë‹¤.`,
    buttons: [
      { text:"í™•ì¸", kind:"ok", onClick: ()=>localStorage.setItem(KEY,"1") }
    ]
  });
})();

/* =========================
   ì‹œì‘
========================= */
if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", initMap);
else initMap();
</script>
</body>
</html>
